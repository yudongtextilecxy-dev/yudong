<!DOCTYPE html>

<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="å®‡ä¸œæŠ¥ä»·">
    <title>å®‡ä¸œçººç»‡æŠ¥ä»·ç³»ç»Ÿ - ä¼˜åŒ–ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #007AFF; --success: #34C759; --error: #FF3B30; --warning: #FF9500;
            --bg: #f9fafb; --surface: white; --text: #1F2937; --text-secondary: #6B7280; --border: #E5E7EB;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05); --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --radius: 1rem; --spacing: 1rem; --transition: all 0.2s ease;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #111827; --surface: #1F2937; --text: #F9FAFB;
                --text-secondary: #D1D5DB; --border: #374151;
            }
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft YaHei", sans-serif;
            background: linear-gradient(135deg, var(--bg) 0%, color-mix(in srgb, var(--primary) 5%, var(--bg)) 100%);
            min-height: 100vh; color: var(--text); padding: var(--spacing);
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .toolbar {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            padding: 0.75rem var(--spacing);
            margin-bottom: var(--spacing);
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        .toolbar-btn {
            padding: 0.5rem 0.875rem;
            border-radius: 0.5rem;
            border: none;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.375rem;
            min-width: fit-content;
            white-space: nowrap;
        }
        .toolbar-btn-primary { background: var(--primary); color: white; }
        .toolbar-btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .toolbar-btn-secondary {
            background: color-mix(in srgb, var(--text) 5%, transparent);
            color: var(--text);
        }
        .toolbar-btn-secondary:hover { background: color-mix(in srgb, var(--text) 10%, transparent); }
        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: var(--border);
            flex-shrink: 0;
            margin: 0 0.5rem;
        }
        .header {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            padding: 1.5rem;
            margin-bottom: var(--spacing);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing);
        }
        .header h1 { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.25rem; }
        .header p { font-size: 0.875rem; color: var(--text-secondary); }
        .stats-row {
            display: flex;
            gap: var(--spacing);
        }
        .stat-card {
            background: linear-gradient(135deg, color-mix(in srgb, var(--primary) 10%, transparent), color-mix(in srgb, var(--primary) 5%, transparent));
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: center;
            min-width: 100px;
            border: 1px solid color-mix(in srgb, var(--primary) 20%, transparent);
        }
        .stat-number { font-size: 2rem; font-weight: 800; color: var(--primary); }
        .stat-label { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem; }
        .main-grid { display: grid; grid-template-columns: 300px 1fr; gap: var(--spacing); }
        .sidebar {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            padding: var(--spacing);
            height: fit-content;
        }
        .sidebar h2 { font-size: 1rem; font-weight: 700; margin-bottom: var(--spacing); }
        .sidebar-group {
            margin-bottom: 1.5rem; /* å¢åŠ ç»„é—´è· */
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border); /* æ·»åŠ åˆ†éš”çº¿ */
        }
        .sidebar-group:last-child { border-bottom: none; padding-bottom: 0; margin-bottom: 0; }
        .sidebar-btn {
            width: 100%;
            padding: 1rem; /* å¢åŠ æŒ‰é’®å†…paddingï¼Œæé«˜è§¦å±å‹å¥½åº¦ */
            border-radius: 0.75rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 0.75rem; /* å¢åŠ æŒ‰é’®é—´è·ï¼Œä»0.5remåˆ°0.75rem */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .sidebar-btn:last-child { margin-bottom: 0; } /* æœ€åä¸€ä¸ªæŒ‰é’®æ— åº•è¾¹è· */
        .sidebar-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-sm); } /* å¢å¼ºhoveråé¦ˆ */
        .btn-upload { background: var(--primary); color: white; }
        .btn-upload:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-export-all { background: var(--success); color: white; }
        .btn-export-all:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-clear {
            background: color-mix(in srgb, var(--error) 10%, white);
            color: var(--error);
            border: 1px solid color-mix(in srgb, var(--error) 20%, transparent);
        }
        .btn-clear:hover { background: color-mix(in srgb, var(--error) 15%, white); }
        .btn-manage { background: var(--warning); color: white; }
        .btn-manage:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-manage.active { background: var(--primary); }
        .status-msg {
            margin-top: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .status-success { background: color-mix(in srgb, var(--success) 10%, white); color: var(--success); }
        .status-error { background: color-mix(in srgb, var(--error) 10%, white); color: var(--error); }
        .status-loading { background: color-mix(in srgb, var(--primary) 10%, white); color: var(--primary); }
        .files-section {
            margin-top: var(--spacing);
            padding-top: var(--spacing);
            border-top: 1px solid var(--border);
            max-height: 150px;
            overflow-y: auto;
        }
        .files-section::-webkit-scrollbar { width: 4px; }
        .files-section::-webkit-scrollbar-track { background: var(--border); border-radius: 2px; }
        .files-section::-webkit-scrollbar-thumb { background: var(--text-secondary); border-radius: 2px; }
        .files-section h3 { font-size: 0.875rem; font-weight: 700; margin-bottom: 0.75rem; }
        .file-item {
            background: var(--bg);
            border-radius: 0.5rem;
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            transition: var(--transition);
            font-size: 0.8125rem;
        }
        .file-item:hover { background: color-mix(in srgb, var(--primary) 5%, var(--bg)); }
        .file-name { font-weight: 600; margin-bottom: 0.125rem; }
        .file-info { color: var(--text-secondary); }
        .main-content {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            padding: 1.5rem;
        }
        .main-content h2 { font-size: 1.25rem; font-weight: 700; margin-bottom: var(--spacing); }
        .search-container {
            background: var(--bg);
            border-radius: var(--radius);
            padding: var(--spacing);
            margin-bottom: var(--spacing);
        }
        .search-box { position: relative; margin-bottom: 1.25rem; }
        .search-input {
            width: 100%;
            padding: 0.75rem 0.75rem 0.75rem 3rem;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 0.75rem;
            font-size: 1rem;
            color: var(--text);
            resize: vertical;
            min-height: 4rem;
            transition: var(--transition);
            font-family: inherit;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 10%, transparent);
        }
        .search-icon {
            position: absolute;
            left: 1rem;
            top: 0.875rem;
            width: 1.25rem;
            height: 1.25rem;
            color: var(--text-secondary);
        }
        .search-history {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1.25rem;
        }
        .history-item {
            padding: 0.375rem 0.75rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }
        .history-item:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .button-row { display: flex; gap: 0.75rem; align-items: center; margin-bottom: 1.25rem; justify-content: flex-start; }
        .btn-export {
            background: var(--success);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            flex-shrink: 0;
        }
        .btn-export:hover { opacity: 0.9; transform: translateY(-1px); }
        .empty-state {
            text-align: center;
            padding: 3rem;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }
        @keyframes fadeIn { to { opacity: 1; } }
        .empty-icon { font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem; }
        .empty-text { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
        .empty-subtext { font-size: 0.875rem; color: var(--text-secondary); }
        .results-summary {
            background: color-mix(in srgb, var(--primary) 5%, var(--bg));
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: var(--spacing);
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--primary);
        }
        .fuzzy-matches {
            background: color-mix(in srgb, var(--warning) 10%, white);
            border: 1px solid color-mix(in srgb, var(--warning) 20%, transparent);
            border-radius: var(--radius);
            padding: var(--spacing);
            margin-bottom: var(--spacing);
        }
        .fuzzy-title { font-weight: 700; color: #92400E; margin-bottom: 0.75rem; }
        .fuzzy-buttons { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .fuzzy-btn {
            padding: 0.5rem 1rem;
            background: white;
            color: #92400E;
            border: 1px solid color-mix(in srgb, var(--warning) 30%, transparent);
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: var(--transition);
        }
        .fuzzy-btn:hover { background: color-mix(in srgb, var(--warning) 10%, white); }
        .range-section { margin-bottom: 2rem; }
        .range-header {
            background: linear-gradient(135deg, var(--success), color-mix(in srgb, var(--success) 80%, white));
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            margin-bottom: var(--spacing);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .range-title { font-size: 1.125rem; font-weight: 700; }
        .range-count { font-size: 0.875rem; opacity: 0.9; }
        .code-list {
            background: color-mix(in srgb, var(--success) 5%, var(--bg));
            border: 1px solid color-mix(in srgb, var(--success) 15%, transparent);
            border-radius: 0.75rem;
            padding: var(--spacing);
            margin-bottom: var(--spacing);
            max-height: 200px;
            overflow-y: auto;
        }
        .code-list h4 {
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--success);
            margin-bottom: 0.75rem;
        }
        .codes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.5rem;
        }
        .code-pill {
            background: var(--surface);
            color: var(--text);
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.8125rem;
            font-weight: 600;
            text-align: center;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: var(--transition);
        }
        .code-pill:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        .product-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: var(--spacing);
            overflow: hidden;
            transition: var(--transition);
            position: relative;
        }
        .product-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
            border-color: var(--primary);
        }
        .product-header {
            background: linear-gradient(135deg, color-mix(in srgb, var(--primary) 15%, white), color-mix(in srgb, var(--primary) 5%, white));
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .product-code { font-size: 1.25rem; font-weight: 700; }
        .match-badge {
            font-size: 0.75rem;
            background: var(--success);
            color: white;
            padding: 0.375rem 0.875rem;
            border-radius: 9999px;
            font-weight: 700;
        }
        .product-content { padding: 1.5rem; }
        .specs-grid {
            background: var(--bg);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: var(--spacing);
        }
        .specs-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
        }
        .specs-row:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        .spec-item label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.375rem;
            font-weight: 600;
        }
        .spec-item .value {
            font-size: 1.125rem;
            font-weight: 800;
            color: var(--success);
        }
        .spec-item .value-normal {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text);
        }
        .notes-box {
            background: color-mix(in srgb, var(--error) 5%, white);
            border: 1px solid color-mix(in srgb, var(--error) 15%, transparent);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: var(--spacing);
        }
        .notes-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--error);
            margin-bottom: 0.25rem;
        }
        .notes-text {
            font-size: 0.875rem;
            color: color-mix(in srgb, var(--error) 80%, black);
        }
        .supplier-box {
            background: color-mix(in srgb, var(--primary) 5%, var(--bg));
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
        }
        .supplier-label {
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--primary);
        }
        .supplier-text {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text);
            flex: 1;
        }
        .view-image-link {
            font-size: 0.8125rem;
            color: var(--primary);
            text-decoration: none;
            cursor: pointer;
            margin-left: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            background: color-mix(in srgb, var(--primary) 10%, transparent);
            transition: var(--transition);
        }
        .view-image-link:hover {
            background: var(--primary);
            color: white;
        }
        .not-found {
            text-align: center;
            padding: 2rem;
        }
        .not-found-icon { font-size: 3rem; margin-bottom: 0.75rem; }
        .not-found-code { font-size: 1.125rem; font-weight: 700; margin-bottom: 0.5rem; }
        .not-found-text { font-size: 0.875rem; color: var(--text-secondary); }
        .manage-container {
            display: none;
        }
        .manage-container.active {
            display: block;
        }
        .manage-section {
            background: var(--bg);
            border-radius: var(--radius);
            padding: var(--spacing);
            margin-bottom: var(--spacing);
        }
        .manage-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: var(--spacing);
        }
        .manage-input-group {
            display: flex;
            flex-direction: column;
        }
        .manage-input-group label {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-secondary);
        }
        .manage-input {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: var(--transition);
        }
        .manage-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .manage-file-input {
            padding: 0.5rem;
            border: 1px dashed var(--border);
            border-radius: 0.5rem;
            text-align: center;
            cursor: pointer;
        }
        .manage-file-input:hover {
            border-color: var(--primary);
            background: color-mix(in srgb, var(--primary) 5%, var(--bg));
        }
        .manage-btn-row {
            display: flex;
            gap: 0.75rem;
            grid-column: 1 / -1;
        }
        .btn-add, .btn-update, .btn-delete {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        .btn-add { background: var(--success); color: white; }
        .btn-add:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-update { background: var(--primary); color: white; }
        .btn-update:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-delete { background: var(--error); color: white; }
        .btn-delete:hover { opacity: 0.9; transform: translateY(-1px); }
        .manage-search {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 0.75rem;
            font-size: 1rem;
            margin-bottom: var(--spacing);
        }
        .manage-search:focus {
            outline: none;
            border-color: var(--primary);
        }
        .manage-product-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing);
        }
        .manage-product-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            position: relative;
        }
        .manage-product-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }
        .manage-product-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.25rem;
        }
        .btn-edit, .btn-remove {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            border: none;
            font-size: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
        }
        .btn-edit { background: var(--primary); color: white; }
        .btn-remove { background: var(--error); color: white; }
        .manage-product-code {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .manage-product-specs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            font-size: 0.8125rem;
        }
        .manage-product-spec {
            display: flex;
            justify-content: space-between;
        }
        .manage-product-spec label { color: var(--text-secondary); }
        .manage-product-image {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 0.25rem;
            margin-top: 0.5rem;
            cursor: pointer;
        }
        .search-container.manage-search-container { display: none; }
        .search-container.manage-search-container.active { display: block; }
        .main-content.manage-mode .search-container:not(.manage-search-container) { display: none; }
        .main-content.manage-mode #resultsArea { display: none; }
        .bulk-upload-btn {
            background: var(--warning);
            color: white;
            padding: 0.75rem;
            border-radius: 0.75rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 0.5rem;
        }
        .bulk-upload-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .bulk-input {
            display: none;
        }
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(4px);
        }
        .image-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: var(--radius);
            overflow: auto;
            box-shadow: var(--shadow-md);
            position: relative;
            animation: fadeIn 0.3s ease;
        }
        .modal-image {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            display: block;
            object-fit: contain;
        }
        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        .close-modal:hover {
            background: color-mix(in srgb, var(--error) 80%, black);
        }
        @media (max-width: 1024px) {
            .main-grid { grid-template-columns: 1fr; }
            .specs-row { grid-template-columns: repeat(2, 1fr); }
            .toolbar { gap: 0.375rem; padding: 0.5rem; }
            .files-section { max-height: 120px; }
            .manage-form { grid-template-columns: 1fr; }
            .manage-product-list { grid-template-columns: 1fr; }
            .sidebar-btn { padding: 0.875rem; margin-bottom: 0.625rem; } /* å°å±å¹•è°ƒæ•´é—´è· */
        }
        @media (max-width: 640px) {
            body { padding: 0.5rem; }
            .header { padding: 1rem; flex-direction: column; text-align: center; gap: 0.5rem; }
            .header h1 { font-size: 1.5rem; }
            .stats-row { width: 100%; justify-content: center; flex-wrap: wrap; }
            .stat-card { min-width: auto; flex: 1 1 80px; }
            .main-content { padding: 1rem; border-radius: 0.75rem; }
            .specs-row { grid-template-columns: 1fr; }
            .codes-grid { grid-template-columns: 1fr; gap: 0.25rem; }
            .toolbar {
                justify-content: flex-start;
                gap: 0.25rem;
                padding: 0.5rem 0.75rem;
                flex-direction: row;
            }
            .toolbar-btn {
                padding: 0.375rem 0.625rem;
                font-size: 0.8125rem;
                gap: 0.25rem;
            }
            .toolbar-divider {
                margin: 0 0.25rem;
                height: 20px;
            }
            .sidebar {
                order: -1;
                margin-bottom: var(--spacing);
            }
            .sidebar h2 { font-size: 0.9375rem; margin-bottom: 0.75rem; }
            .search-container { padding: 0.75rem; }
            .button-row { flex-direction: column; }
            .btn-export { width: 100%; }
            .product-header { flex-direction: column; gap: 0.5rem; text-align: center; }
            .files-section { max-height: 100px; padding: 0.5rem; }
            .file-item { padding: 0.375rem; margin-bottom: 0.125rem; }
            .manage-btn-row { flex-direction: column; }
            .manage-product-actions { position: static; justify-content: center; margin-top: 0.5rem; }
            .modal-content { max-width: 95%; max-height: 95%; }
        }
        @media (max-width: 480px) {
            .container { padding: 0; }
            .toolbar { border-radius: 0.5rem; margin: 0 0 var(--spacing) 0; }
            .header { margin: 0 0 var(--spacing) 0; }
        }
        .hint-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            margin-bottom: 1.5rem; /* å¢åŠ åº•è¾¹è·ï¼Œæå‡ä¸å†å²è®°å½•çš„é—´è· */
            padding: 0.75rem;
            background: color-mix(in srgb, var(--primary) 10%, var(--bg));
            border-radius: 0.75rem;
            border-left: 2px solid color-mix(in srgb, var(--primary) 20%, transparent); /* è¿›ä¸€æ­¥æ·¡åŒ–è¾¹æ¡†é¢œè‰²ï¼Œå‡å°å®½åº¦ */
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="toolbar">
            <button class="toolbar-btn toolbar-btn-primary" onclick="document.getElementById('searchInput').focus()">
                <span>ğŸ”</span>
                <span>æœç´¢</span>
            </button>
            <button class="toolbar-btn toolbar-btn-secondary" onclick="exportQuotePDF()" id="toolbarQuotePDF" style="display: none;">
                <span>ğŸ“„</span>
                <span>æŠ¥ä»·PDF</span>
            </button>
            <button class="toolbar-btn toolbar-btn-secondary" onclick="exportAllData()" id="toolbarExportAll" style="display: none;">
                <span>ğŸ“¦</span>
                <span>å¯¼å‡ºå…¨éƒ¨</span>
            </button>
            <div class="toolbar-divider"></div>
            <button class="toolbar-btn toolbar-btn-secondary" onclick="clearSearchHistory()">
                <span>ğŸ—‘ï¸</span>
                <span>æ¸…é™¤å†å²</span>
            </button>
        </div>
        <div class="header">
            <div>
                <h1>ğŸ­ å®‡ä¸œçººç»‡æŠ¥ä»·ç³»ç»Ÿ</h1>
                <p>å¿«é€ŸæŸ¥è¯¢ Â· æ™ºèƒ½æœç´¢ Â· åŒºé—´åˆ†æ</p>
            </div>
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-number" id="dataCount">0</div>
                    <div class="stat-label">äº§å“æ•°æ®</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="fileCount">0</div>
                    <div class="stat-label">æ–‡ä»¶æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="resultCount">0</div>
                    <div class="stat-label">æŸ¥è¯¢ç»“æœ</div>
                </div>
            </div>
        </div>
        <div class="main-grid">
            <div class="sidebar">
                <h2>ğŸ“‚ æ•°æ®ç®¡ç†</h2>
                <div class="sidebar-group">
                    <input type="file" id="fileInput" accept=".csv,.xlsx" multiple style="display: none;">
                    <button class="sidebar-btn btn-upload" onclick="document.getElementById('fileInput').click()">
                        <span>ğŸ“¤</span>
                        <span>ä¸Šä¼ æ–‡ä»¶</span>
                    </button>
                    <input type="file" id="restoreInput" accept=".json,.zip" style="display: none;">
                    <button class="sidebar-btn btn-upload" onclick="document.getElementById('restoreInput').click()">
                        <span>ğŸ“¥</span>
                        <span>å¯¼å…¥æ•°æ®åº“</span>
                    </button>
                </div>
                <div class="sidebar-group">
                    <button class="sidebar-btn btn-export-all" id="sidebarExportAll" style="display: none;" onclick="exportAllData()">
                        <span>ğŸ“¦</span>
                        <span>å¯¼å‡ºå…¨éƒ¨</span>
                    </button>
                    <button class="sidebar-btn btn-manage" id="manageBtn" onclick="toggleManageMode()">ğŸ› ï¸ ç®¡ç†äº§å“</button>
                </div>
                <div class="sidebar-group">
                    <button class="sidebar-btn btn-clear" onclick="clearData()">
                        <span>ğŸ—‘ï¸</span>
                        <span>æ¸…ç©ºæ•°æ®</span>
                    </button>
                </div>
                <div id="statusMsg"></div>
                <div id="filesList"></div>
            </div>
            <div class="main-content" id="mainContent">
                <h2>ğŸ” äº§å“æŸ¥è¯¢</h2>
                <div class="search-container">
                    <div class="search-box">
                        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <textarea id="searchInput" class="search-input" rows="3" placeholder="è¾“å…¥äº§å“ä»£ç ã€ä¾›åº”å•†æˆ–ä»·æ ¼/å…‹é‡åŒºé—´...&#10;&#10;ç¤ºä¾‹ï¼š&#10;â€¢ äº§å“ä»£ç ï¼šC6001, Y6&#10;â€¢ ä¾›åº”å•†ï¼šæ°¸è”&#10;â€¢ ä»·æ ¼åŒºé—´ï¼š20å…ƒä»¥ä¸Š, 10-15å…ƒ&#10;â€¢ å…‹é‡åŒºé—´ï¼š100å…‹å†…, 150-200å…‹"></textarea>
                    </div>
                    <p class="hint-text">ğŸ’¡ å®æ—¶æ™ºèƒ½æœç´¢å·²å¼€å¯ï¼šè¾“å…¥å³è‡ªåŠ¨åŒ¹é…äº§å“ä»£ç ã€ä¾›åº”å•†ã€ä»·æ ¼/å…‹é‡åŒºé—´ã€‚æ”¯æŒæ‰¹é‡æŸ¥è¯¢ã€æ¨¡ç³Šæœç´¢ä¸å†å²è®°å½•å¿«é€Ÿè°ƒç”¨ã€‚</p>
                    <div class="search-history" id="searchHistory"></div>
                    <div class="button-row">
                        <button class="btn-export" id="quotePDFBtn" style="display: none;" onclick="exportQuotePDF()">ğŸ“„ æŠ¥ä»·PDF</button>
                    </div>
                </div>
                <div class="manage-container" id="manageContainer">
                    <h2>ğŸ› ï¸ ç®¡ç†äº§å“</h2>
                    <div class="manage-section">
                        <h3>â• æ·»åŠ /ç¼–è¾‘äº§å“</h3>
                        <form class="manage-form" id="manageForm">
                            <div class="manage-input-group">
                                <label for="codeInput">äº§å“ä»£ç </label>
                                <input type="text" id="codeInput" class="manage-input" required>
                            </div>
                            <div class="manage-input-group">
                                <label for="priceInput">ç ä»·</label>
                                <input type="text" id="priceInput" class="manage-input">
                            </div>
                            <div class="manage-input-group">
                                <label for="priceAltInput">ç±³ä»·</label>
                                <input type="text" id="priceAltInput" class="manage-input">
                            </div>
                            <div class="manage-input-group">
                                <label for="widthInput">é—¨å¹…</label>
                                <input type="text" id="widthInput" class="manage-input">
                            </div>
                            <div class="manage-input-group">
                                <label for="compositionInput">æˆåˆ†</label>
                                <input type="text" id="compositionInput" class="manage-input">
                            </div>
                            <div class="manage-input-group">
                                <label for="weightInput">å…‹é‡</label>
                                <input type="text" id="weightInput" class="manage-input">
                            </div>
                            <div class="manage-input-group">
                                <label for="notesInput">å¤‡æ³¨</label>
                                <input type="text" id="notesInput" class="manage-input">
                            </div>
                            <div class="manage-input-group">
                                <label for="supplierInput">ä¾›åº”å•†</label>
                                <input type="text" id="supplierInput" class="manage-input">
                            </div>
                            <div class="manage-input-group">
                                <label for="imageInput">åº•å¡å›¾ç‰‡</label>
                                <input type="file" id="imageInput" class="manage-file-input" accept="image/*">
                            </div>
                            <div class="manage-input-group">
                                <label>ğŸ“¤ æ‰¹é‡ä¸Šä¼ å›¾ç‰‡</label>
                                <input type="file" id="bulkImageInput" class="bulk-input" multiple accept="image/*">
                                <button type="button" class="bulk-upload-btn" onclick="document.getElementById('bulkImageInput').click()">é€‰æ‹©æ‰¹é‡å›¾ç‰‡</button>
                                <small class="hint-text">æ–‡ä»¶åéœ€ä¸º"äº§å“ä»£ç .jpg"æ ¼å¼ï¼Œç³»ç»Ÿè‡ªåŠ¨åŒ¹é…</small>
                            </div>
                            <div class="manage-btn-row">
                                <button type="button" class="btn-add" id="addBtn" onclick="addOrUpdateProduct()">æ·»åŠ äº§å“</button>
                                <button type="button" class="btn-update" id="updateBtn" onclick="addOrUpdateProduct()" style="display: none;">æ›´æ–°äº§å“</button>
                                <button type="button" class="btn-delete" id="deleteBtn" onclick="deleteProduct()" style="display: none;">åˆ é™¤äº§å“</button>
                                <button type="button" class="btn-clear" onclick="clearForm()">æ¸…ç©ºè¡¨å•</button>
                            </div>
                        </form>
                    </div>
                    <div class="manage-section">
                        <h3>ğŸ” æœç´¢äº§å“</h3>
                        <input type="text" id="manageSearchInput" class="manage-search" placeholder="æœç´¢äº§å“ä»£ç æˆ–ä¾›åº”å•†..." oninput="filterManageProducts()">
                        <div class="manage-product-list" id="manageProductList"></div>
                    </div>
                </div>
                <div id="resultsArea"></div>
            </div>
        </div>
        <div id="imageModal" class="image-modal">
            <div class="modal-content">
                <img id="modalImage" class="modal-image" src="" alt="äº§å“åº•å¡">
                <button class="close-modal" onclick="closeImageModal()">&times;</button>
            </div>
        </div>
    </div>
    <script>
        var catalogData = {};
        var uploadedFiles = [];
        var searchResults = [];
        var fuzzyMatches = [];
        var rangeResults = [];
        var searchTimeout;
        var searchHistory = JSON.parse(localStorage.getItem('search-history') || '[]');
        var editingCode = null;
        var manageSearchTerm = '';
        let db;
        const DB_NAME = 'YudongFabricDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'catalogData';

```
    function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                db = request.result;
                resolve(db);
            };
            request.onupgradeneeded = (e) => {
                db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { keyPath: 'code' });
                }
            };
        });
    }

    async function saveData() {
        if (!db) await initDB();
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);

        Object.entries(catalogData).forEach(([code, product]) => {
            store.put({ ...product, code });
        });

        localStorage.setItem('fabric-uploaded-files', JSON.stringify(uploadedFiles));
        localStorage.setItem('search-history', JSON.stringify(searchHistory));

        return new Promise((resolve, reject) => {
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
    }

    async function loadData() {
        try {
            if (!db) await initDB();
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.getAll();

            return new Promise((resolve, reject) => {
                request.onsuccess = () => {
                    const dataArray = request.result;
                    catalogData = dataArray.reduce((acc, item) => {
                        acc[item.code] = item;
                        return acc;
                    }, {});

                    uploadedFiles = JSON.parse(localStorage.getItem('fabric-uploaded-files') || '[]');
                    resolve();
                };
                request.onerror = () => reject(request.error);
            });
        } catch (error) {
            console.error("IndexedDB load failed, attempting localStorage fallback:", error);
            // Fallback to old localStorage data (if any)
            const localStorageData = localStorage.getItem('fabric-catalog-data');
            if (localStorageData) {
                catalogData = JSON.parse(localStorageData);
                localStorage.removeItem('fabric-catalog-data'); // Clear old data
                await saveData(); // Save to IndexedDB
                console.log("Migrated old localStorage data to IndexedDB.");
            }
            uploadedFiles = JSON.parse(localStorage.getItem('fabric-uploaded-files') || '[]');
            return Promise.resolve();
        }
    }

    function updateStats() {
        document.getElementById('dataCount').textContent = Object.keys(catalogData).length;
        document.getElementById('fileCount').textContent = uploadedFiles.length;
        document.getElementById('resultCount').textContent = searchResults.length + rangeResults.reduce((sum, r) => sum + r.matches.length, 0);

        var hasData = Object.keys(catalogData).length > 0;
        document.getElementById('sidebarExportAll').style.display = hasData ? 'block' : 'none';
        document.getElementById('toolbarExportAll').style.display = hasData ? 'block' : 'none';

        var hasResults = searchResults.length > 0 || rangeResults.length > 0;
        document.getElementById('toolbarQuotePDF').style.display = hasResults ? 'block' : 'none';
        document.getElementById('quotePDFBtn').style.display = hasResults ? 'block' : 'none';
    }

    function showStatus(message, type) {
        var statusDiv = document.getElementById('statusMsg');
        statusDiv.className = 'status-msg status-' + type;
        statusDiv.textContent = message;
        if (type === 'success') {
            setTimeout(function() {
                statusDiv.textContent = '';
            }, 3000);
        }
    }

    function renderHistory() {
        var historyDiv = document.getElementById('searchHistory');
        if (searchHistory.length === 0) {
            historyDiv.innerHTML = '';
            return;
        }
        var html = '';
        searchHistory.slice(-5).reverse().forEach(function(h) {
            html += '<div class="history-item" onclick="loadHistory(\'' + h.replace(/'/g, "\\'") + '\')">' + h + '</div>';
        });
        historyDiv.innerHTML = html;
    }

    function loadHistory(query) {
        document.getElementById('searchInput').value = query;
        handleSearch(query);
        renderResults();
    }

    function clearSearchHistory() {
        if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æœç´¢å†å²å—ï¼Ÿ')) {
            searchHistory = [];
            localStorage.setItem('search-history', JSON.stringify(searchHistory));
            renderHistory();
            showStatus('æœç´¢å†å²å·²æ¸…é™¤', 'success');
        }
    }

    function parseRangeInput(input) {
        var ranges = [];
        var items = input.split(/[,ï¼Œ\s]+/).map(function(item) { return item.trim(); }).filter(function(item) { return item; });
        var type = null;

        items.forEach(function(item) {
            var upper = item.toUpperCase();
            var min = null, max = null, label = item;

            if (upper.includes('å…ƒ')) {
                type = 'price';
                if (upper.includes('ä»¥ä¸Š')) {
                    min = parseFloat(upper.replace(/[^0-9.]/g, ''));
                    max = Infinity;
                } else if (upper.includes('å†…')) {
                    max = parseFloat(upper.replace(/[^0-9.]/g, ''));
                    min = 0;
                } else {
                    var match = upper.match(/(\d+(?:\.\d+)?)-(\d+(?:\.\d+)?)å…ƒ/);
                    if (match) {
                        min = parseFloat(match[1]);
                        max = parseFloat(match[2]);
                    }
                }
            } else if (upper.includes('å…‹')) {
                type = 'weight';
                if (upper.includes('ä»¥ä¸Š')) {
                    min = parseFloat(upper.replace(/[^0-9.]/g, ''));
                    max = Infinity;
                } else if (upper.includes('å†…')) {
                    max = parseFloat(upper.replace(/[^0-9.]/g, ''));
                    min = 0;
                } else {
                    var match = upper.match(/(\d+(?:\.\d+)?)-(\d+(?:\.\d+)?)å…‹/);
                    if (match) {
                        min = parseFloat(match[1]);
                        max = parseFloat(match[2]);
                    }
                }
            }

            if (min !== null || max !== null) {
                ranges.push({ min: min, max: max, label: label });
            }
        });

        return { ranges: ranges, type: type };
    }

    function performRangeQuery(ranges, type) {
        var results = [];
        var dataKeys = Object.keys(catalogData);

        ranges.forEach(function(range) {
            var matches = dataKeys.filter(function(key) {
                var product = catalogData[key];
                var value = (type === 'price') ? parseFloat(product.price) : parseFloat(product.weight);
                if (isNaN(value)) return false;

                var minCheck = (range.min === null || value >= range.min);
                var maxCheck = (range.max === null || value <= range.max);

                return minCheck && maxCheck;
            }).map(function(code) {
                var product = JSON.parse(JSON.stringify(catalogData[code]));
                product.matchType = 'range';
                return product;
            }).sort(function(a, b) {
                // è‡ªå®šä¹‰æ’åºé€»è¾‘ï¼šæŒ‰ç³»åˆ—å­—æ¯æ’åºï¼Œå†æŒ‰æ•°å­—æ’åº (ä¾‹å¦‚: Y6 < C100 < C6001)
                var seriesA = a.code.match(/^[YC]*[ACDFGJMST]/);
                var seriesB = b.code.match(/^[YC]*[ACDFGJMST]/);
                seriesA = seriesA ? seriesA[0] : '';
                seriesB = seriesB ? seriesB[0] : '';
                if (seriesA !== seriesB) return seriesA.localeCompare(seriesB);

                var numA = parseInt(a.code.replace(/^[YC]*[ACDFGJMST]/, '')) || 0;
                var numB = parseInt(b.code.replace(/^[YC]*[ACDFGJMST]/, '')) || 0;
                return numA - numB;
            });

            var result = JSON.parse(JSON.stringify(range));
            result.matches = matches;
            results.push(result);
        });

        return results;
    }

    document.getElementById('searchInput').addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        var value = e.target.value.trim();
        if (value && Object.keys(catalogData).length > 0) {
            searchTimeout = setTimeout(function() {
                handleSearch(value);
                renderResults();
            }, 300);
        } else {
            searchResults = [];
            fuzzyMatches = [];
            rangeResults = [];
            renderResults();
        }
    });

    function handleSearch(inputValue) {
        var input = (inputValue || document.getElementById('searchInput').value).trim().toUpperCase();
        if (!input) {
            searchResults = [];
            fuzzyMatches = [];
            rangeResults = [];
            return;
        }

        if (!searchHistory.includes(input)) {
            searchHistory.push(input);
            if (searchHistory.length > 10) searchHistory.shift();
            localStorage.setItem('search-history', JSON.stringify(searchHistory));
            renderHistory();
        }

        var parsed = parseRangeInput(input);
        if (parsed.ranges.length > 0 && (parsed.type === 'price' || parsed.type === 'weight')) {
            rangeResults = performRangeQuery(parsed.ranges, parsed.type);
            searchResults = [];
            fuzzyMatches = [];
        } else {
            var codes = input.split(/[\s,;\n]+/).map(function(c) { return c.trim(); }).filter(function(c) { return c.length > 0; });
            searchResults = [];
            fuzzyMatches = [];
            rangeResults = [];

            codes.forEach(function(code) {
                if (catalogData[code]) {
                    var result = JSON.parse(JSON.stringify(catalogData[code]));
                    result.found = true;
                    result.matchType = 'exact';
                    searchResults.push(result);
                } else {
                    var matches = Object.keys(catalogData).filter(function(key) {
                        var product = catalogData[key];
                        var codeMatch = key.toUpperCase().includes(code);
                        var supplierMatch = product.supplier && product.supplier !== '-' && product.supplier.toUpperCase().includes(code);
                        return codeMatch || supplierMatch;
                    });

                    if (matches.length === 1) {
                        var result = JSON.parse(JSON.stringify(catalogData[matches[0]]));
                        result.found = true;
                        result.matchType = 'fuzzy';
                        searchResults.push(result);
                    } else if (matches.length > 1) {
                        fuzzyMatches.push({ searchTerm: code, matches: matches.sort() });
                    } else {
                        searchResults.push({ code: code, found: false, error: 'æœªæ‰¾åˆ°ç²¾ç¡®æˆ–æ¨¡ç³ŠåŒ¹é…' });
                    }
                }
            });

            searchResults.sort(function(a, b) {
                return a.code.localeCompare(b.code);
            });
        }
    }

    function renderResults() {
        var area = document.getElementById('resultsArea');
        var html = '';

        updateStats();

        if (searchResults.length === 0 && fuzzyMatches.length === 0 && rangeResults.length === 0) {
            area.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“‚</div><div class="empty-text">ç­‰å¾…æŸ¥è¯¢</div><div class="empty-subtext">è¯·è¾“å…¥äº§å“ä»£ç æˆ–æŸ¥è¯¢æ¡ä»¶</div></div>';
            return;
        }

        var totalSearched = searchResults.length + fuzzyMatches.length;
        if (totalSearched > 0) {
            var foundCount = searchResults.filter(r => r.found).length + fuzzyMatches.length;
            html += '<div class="results-summary">æœ¬æ¬¡æŸ¥è¯¢å…±è¾“å…¥ <strong>' + totalSearched + '</strong> ä¸ªäº§å“ï¼Œæ‰¾åˆ° <strong>' + foundCount + '</strong> ä¸ªåŒ¹é…ç»“æœ</div>';
        }

        fuzzyMatches.forEach(function(fuzzy) {
            html += '<div class="fuzzy-matches"><div class="fuzzy-title">ğŸ” æœç´¢ "' + fuzzy.searchTerm + '" æ‰¾åˆ° ' + fuzzy.matches.length + ' ä¸ªåŒ¹é…</div><div class="fuzzy-buttons">';
            fuzzy.matches.forEach(function(m) {
                html += '<button class="fuzzy-btn" onclick="selectFuzzyMatch(\'' + m + '\')">' + m + '</button>';
            });
            html += '</div></div>';
        });

        if (rangeResults.length > 0) {
            rangeResults.forEach(function(range) {
                html += '<div class="range-section"><div class="range-header"><div class="range-title">' + range.label + '</div><div class="range-count">åŒ¹é… ' + range.matches.length + ' ä¸ªäº§å“</div></div>';
                if (range.matches.length > 0) {
                    var codes = range.matches.map(function(m) { return m.code; });
                    html += '<div class="code-list"><h4>ğŸ“‹ åŒ¹é…äº§å“ç¼–å· (' + codes.length + ' ä¸ª)</h4><div class="codes-grid">';
                    codes.forEach(function(code) {
                        html += '<div class="code-pill" onclick="selectCode(\'' + code + '\')">' + code + '</div>';
                    });
                    html += '</div></div>';
                    range.matches.forEach(function(product) {
                        html += renderProductCard(product);
                    });
                } else {
                    html += '<div class="empty-state"><div class="empty-icon">ğŸ”</div><div class="empty-text">æš‚æ— åŒ¹é…äº§å“</div><div class="empty-subtext">è¯¥åŒºé—´å†…æ²¡æœ‰æ‰¾åˆ°äº§å“</div></div>';
                }
                html += '</div>';
            });
        } else {
            searchResults.forEach(function(result) {
                if (result.found) {
                    html += renderProductCard(result);
                } else {
                    html += '<div class="product-card"><div class="not-found"><div class="not-found-icon">âŒ</div><div class="not-found-code">' + result.code + '</div><div class="not-found-text">' + result.error + '</div></div></div>';
                }
            });
        }

        area.innerHTML = html;
        bindImageEvents();
    }

    function renderProductCard(product) {
        var hasImage = product.image && product.image.length > 100;
        var html = '<div class="product-card" data-code="' + product.code + '">';
        html += '<div class="product-header">';
        html += '<div class="product-code">ğŸ“¦ ' + product.code + '</div>';
        html += '<div class="match-badge">' + (product.matchType === 'exact' ? 'âœ“ ç²¾ç¡®åŒ¹é…' : product.matchType === 'fuzzy' ? 'ğŸ¯ æ¨¡ç³ŠåŒ¹é…' : 'ğŸ“Š åŒºé—´åŒ¹é…') + '</div>';
        html += '</div>';
        html += '<div class="product-content">';
        html += '<div class="specs-grid"><div class="specs-row">';

        html += '<div class="spec-item"><label>ğŸ’° ç ä»·</label><div class="value">' + product.price + '</div></div>';
        html += '<div class="spec-item"><label>ğŸ’° ç±³ä»·</label><div class="value-normal">' + product.priceAlt + '</div></div>';
        html += '<div class="spec-item"><label>ğŸ“ é—¨å¹…</label><div class="value-normal">' + product.width + '</div></div>';
        html += '<div class="spec-item"><label>âš–ï¸ å…‹é‡</label><div class="value-normal">' + product.weight + '</div></div>';
        html += '<div class="spec-item"><label>æˆåˆ†</label><div class="value-normal">' + product.composition + '</div></div>';
        html += '</div></div>';

        if (product.notes && product.notes !== '-') {
            html += '<div class="notes-box"><div class="notes-label">âš ï¸ å¤‡æ³¨/ç‰¹åˆ«è¯´æ˜</div><div class="notes-text">' + product.notes + '</div></div>';
        }

        html += '<div class="supplier-box">';
        html += '<div class="supplier-label">ä¾›åº”å•†:</div>';
        html += '<div class="supplier-text">' + product.supplier + '</div>';
        if (hasImage) {
            html += '<a href="javascript:void(0);" class="view-image-link" data-code="' + product.code + '">ğŸ–¼ï¸ æŸ¥çœ‹åº•å¡</a>';
        }
        html += '</div>';

        html += '</div>';
        html += '</div>';
        return html;
    }

    function clearData() {
        if (confirm('è­¦å‘Šï¼šç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰äº§å“æ•°æ®ã€å·²ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯å’Œæœç´¢å†å²å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼')) {
            catalogData = {};
            uploadedFiles = [];
            searchHistory = [];
            localStorage.setItem('fabric-uploaded-files', JSON.stringify(uploadedFiles));
            localStorage.setItem('search-history', JSON.stringify(searchHistory));
            // æ¸…ç©º IndexedDB
            indexedDB.deleteDatabase(DB_NAME);
            db = null; // é‡ç½®dbè¿æ¥ï¼Œä¸‹æ¬¡ä¼šé‡æ–°åˆ›å»º

            searchResults = [];
            fuzzyMatches = [];
            rangeResults = [];
            renderResults();
            renderHistory();
            renderFilesList();
            updateStats();
            showStatus('ğŸ—‘ï¸ æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼', 'error');
        }
    }

    function parseSpreadsheetData(rows) {
        var data = {};
        if (rows.length < 2) return data;

        // è‡ªåŠ¨è¯†åˆ«åˆ—å¤´ï¼ˆå»é™¤ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦ååŒ¹é…å…³é”®è¯ï¼‰
        var header = rows[0].map(h => String(h).trim().toUpperCase().replace(/[\s\W_]+/g, ''));
        const headerMap = {
            'äº§å“ä»£ç ': ['äº§å“ä»£ç ', 'CODE', 'ç¼–å·', 'è´§å·'],
            'ç ä»·': ['ç ä»·', 'ä»·æ ¼', 'PRICE', 'Mä»·', 'MCODE'],
            'ç±³ä»·': ['ç±³ä»·', 'PRICEALT', 'Yä»·', 'YCODE'],
            'é—¨å¹…': ['é—¨å¹…', 'WIDTH'],
            'æˆåˆ†': ['æˆåˆ†', 'COMPOSITION', 'çº±æ”¯'],
            'å…‹é‡': ['å…‹é‡', 'WEIGHT', 'KG'],
            'å¤‡æ³¨': ['å¤‡æ³¨', 'NOTES'],
            'ä¾›åº”å•†': ['ä¾›åº”å•†', 'SUPPLIER']
        };

        const columnIndex = {};
        Object.entries(headerMap).forEach(([key, aliases]) => {
            for (let alias of aliases) {
                const index = header.indexOf(alias);
                if (index !== -1) {
                    columnIndex[key] = index;
                    break;
                }
            }
        });

        // æ£€æŸ¥å¿…å¤‡åˆ—
        if (columnIndex['äº§å“ä»£ç '] === undefined) {
            showStatus('æ–‡ä»¶è§£æå¤±è´¥ï¼šæœªæ‰¾åˆ° "äº§å“ä»£ç " åˆ—', 'error');
            return {};
        }

        // ä»ç¬¬äºŒè¡Œå¼€å§‹å¤„ç†æ•°æ®
        for (var i = 1; i < rows.length; i++) {
            var row = rows[i];
            if (!row || !String(row[columnIndex['äº§å“ä»£ç ']]).trim()) continue; // è·³è¿‡ç©ºè¡Œæˆ–ä»£ç ä¸ºç©ºçš„è¡Œ

            var code = String(row[columnIndex['äº§å“ä»£ç ']]).trim().toUpperCase();
            // ç¡®ä¿äº§å“ä»£ç æ ¼å¼æœ‰æ•ˆ
            if (!code.match(/^[YC]*[ACDFGJMST0-9][A-Z0-9\-\/]*$/)) {
                console.warn('Skipping invalid code:', code);
                continue;
            }

            data[code] = {
                price: String(row[columnIndex['ç ä»·']] || '-').trim(),
                priceAlt: String(row[columnIndex['ç±³ä»·']] || '-').trim(),
                width: String(row[columnIndex['é—¨å¹…']] || '-').trim(),
                composition: String(row[columnIndex['æˆåˆ†']] || '-').trim(),
                weight: String(row[columnIndex['å…‹é‡']] || '-').trim(),
                notes: String(row[columnIndex['å¤‡æ³¨']] || '-').trim(),
                supplier: String(row[columnIndex['ä¾›åº”å•†']] || '-').trim(),
                image: catalogData[code] ? catalogData[code].image : null // ä¿ç•™å·²æœ‰å›¾ç‰‡
            };
        }

        showStatus('å·²ä»æ–‡ä»¶ä¸­æˆåŠŸè§£æ ' + Object.keys(data).length + ' æ¡äº§å“æ•°æ®', 'success');
        return data;
    }

    document.getElementById('fileInput').addEventListener('change', function(e) {
        var files = e.target.files;
        if (files.length === 0) return;

        showStatus('æ­£åœ¨å¤„ç† ' + files.length + ' ä¸ªæ–‡ä»¶...', 'loading');
        var processed = 0;

        Array.from(files).forEach(function(file) {
            var fileType = file.name.toLowerCase().endsWith('.csv') ? 'csv' : 'xlsx';
            var reader = new FileReader();

            reader.onload = function(ev) {
                var rows;
                try {
                    if (fileType === 'csv') {
                        var results = Papa.parse(ev.target.result, { skipEmptyLines: true });
                        rows = results.data;
                    } else {
                        var data = new Uint8Array(ev.target.result);
                        var workbook = XLSX.read(data, {type: 'array'});
                        var sheetName = workbook.SheetNames[0];
                        rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {header:1});
                    }
                } catch (err) {
                    showStatus('æ–‡ä»¶è§£æé”™è¯¯: ' + err.message, 'error');
                    processed++;
                    if (processed === files.length) {
                        updateStats();
                    }
                    return;
                }

                var newData = parseSpreadsheetData(rows);
                Object.assign(catalogData, newData);

                uploadedFiles = uploadedFiles.filter(function(f) { return f.name !== file.name; });
                uploadedFiles.push({
                    name: file.name,
                    uploadTime: new Date().toLocaleString('zh-CN'),
                    count: Object.keys(newData).length
                });

                processed++;
                if (processed === files.length) {
                    saveData().then(() => {
                        updateStats();
                        renderFilesList();
                        renderManageProducts();
                        showStatus('âœ… ' + files.length + ' ä¸ªæ–‡ä»¶å¯¼å…¥å®Œæˆï¼', 'success');
                        e.target.value = '';
                    });
                }
            };

            reader.onerror = function() {
                showStatus('æ–‡ä»¶è¯»å–å¤±è´¥: ' + file.name, 'error');
                processed++;
                if (processed === files.length) {
                    updateStats();
                }
            };

            if (fileType === 'csv') {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        });
    });

    function renderFilesList() {
        var listDiv = document.getElementById('filesList');
        if (uploadedFiles.length === 0) {
            listDiv.innerHTML = '';
            return;
        }

        var html = '<div class="files-section"><h3>ğŸ“„ å·²å¯¼å…¥æ–‡ä»¶ (' + uploadedFiles.length + ')</h3>';
        uploadedFiles.slice().reverse().forEach(function(file) {
            html += '<div class="file-item">';
            html += '<div class="file-name">' + file.name + '</div>';
            html += '<div class="file-info">' + file.count + ' æ¡æ•°æ® | ' + file.uploadTime + '</div>';
            html += '</div>';
        });
        html += '</div>';
        listDiv.innerHTML = html;
    }

    function exportAllData() {
        if (Object.keys(catalogData).length === 0) {
            showStatus('æ— æ•°æ®å¯å¯¼å‡º', 'error');
            return;
        }

        showStatus('æ­£åœ¨ç”Ÿæˆå®Œæ•´å¤‡ä»½æ–‡ä»¶...', 'loading');

        var zip = new JSZip();
        var timestamp = new Date().toISOString().replace(/[:.]/g, '-');

        // 1. ç”Ÿæˆ database.json
        var dbData = {
            catalogData: catalogData,
            uploadedFiles: uploadedFiles,
            searchHistory: searchHistory,
            exportTime: timestamp
        };
        zip.file('database.json', JSON.stringify(dbData, null, 2));

        // 2. å‹ç¼©å›¾ç‰‡
        var imageFolder = zip.folder('images');
        Object.values(catalogData).forEach(function(product) {
            if (product.image && product.image.startsWith('data:image')) {
                var base64 = product.image.split(',')[1];
                var mimeType = product.image.split(';')[0].split(':')[1];
                var extension = mimeType.split('/')[1] || 'png';
                // ç¡®ä¿ä»£ç æ˜¯æœ‰æ•ˆçš„æ–‡ä»¶å¤¹åç§°
                var safeCode = product.code.replace(/[^a-zA-Z0-9\-\.]/g, '_');
                imageFolder.file(safeCode + '.' + extension, base64, { base64: true });
            }
        });

        // 3. ç”Ÿæˆ XLSX æ•°æ®è¡¨
        try {
            var rows = [
                ['äº§å“ä»£ç ', 'ç ä»·', 'ç±³ä»·', 'é—¨å¹…', 'æˆåˆ†', 'å…‹é‡', 'å¤‡æ³¨', 'ä¾›åº”å•†']
            ];
            Object.keys(catalogData).forEach(function(code) {
                var p = catalogData[code];
                rows.push([ code, p.price || '-', p.priceAlt || '-', p.width || '-', p.composition || '-', p.weight || '-', p.notes || '-', p.supplier || '-' ]);
            });
            var wb = XLSX.utils.book_new();
            var ws = XLSX.utils.aoa_to_sheet(rows);
            XLSX.utils.book_append_sheet(wb, ws, 'äº§å“æ•°æ®');
            var xlsxBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            zip.file('äº§å“æ•°æ®è¡¨.xlsx', xlsxBuffer);
        } catch (xlsxError) {
            console.error('XLSX generation error:', xlsxError);
        }

        // ç”ŸæˆZIP
        zip.generateAsync({
            type: 'blob',
            compression: 'DEFLATE',
            compressionOptions: {
                level: 6
            }
        }).then(function(content) {
            var link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = 'å®‡ä¸œçººç»‡å…¨åº“å¤‡ä»½_' + timestamp + '.zip';
            link.click();
            URL.revokeObjectURL(link.href);
            showStatus('âœ… å®Œæ•´å¤‡ä»½å¯¼å‡ºæˆåŠŸï¼ˆå«å›¾ç‰‡ï¼‰ï¼', 'success');
        }).catch(function(error) {
            console.error('ZIP generation error:', error);
            showStatus('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
        });
    }

    function importDatabase(files) {
        if (files.length === 0) return;
        var file = files[0];
        showStatus('æ­£åœ¨å¯¼å…¥æ•°æ®åº“...', 'loading');

        if (file.name.endsWith('.json')) {
            // ç›´æ¥å¯¼å…¥JSONæ–‡ä»¶
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = JSON.parse(e.target.result);
                    // å…¼å®¹æ–°æ—§æ ¼å¼
                    if (data.catalogData) {
                        catalogData = data.catalogData;
                        uploadedFiles = data.uploadedFiles || [];
                        searchHistory = data.searchHistory || [];
                    } else {
                        // æ—§æ ¼å¼ï¼šç›´æ¥æ˜¯catalogData
                        catalogData = data;
                    }

                    localStorage.setItem('search-history', JSON.stringify(searchHistory));
                    saveData().then(() => {
                        updateStats();
                        renderFilesList();
                        renderManageProducts();
                        renderResults();
                        renderHistory();
                        showStatus('âœ… æ•°æ®åº“å¯¼å…¥æˆåŠŸï¼', 'success');
                    });
                } catch (err) {
                    console.error('JSON parse error:', err);
                    showStatus('å¯¼å…¥å¤±è´¥ï¼šJSONæ ¼å¼é”™è¯¯ - ' + err.message, 'error');
                }
            };
            reader.onerror = function() {
                showStatus('æ–‡ä»¶è¯»å–å¤±è´¥', 'error');
            };
            reader.readAsText(file);
        } else if (file.name.endsWith('.zip')) {
            // å¯¼å…¥ZIPæ–‡ä»¶
            var reader = new FileReader();
            reader.onload = function(e) {
                JSZip.loadAsync(e.target.result).then(function(zip) {
                    // ä¼˜å…ˆæŸ¥æ‰¾database.jsonï¼ˆæ–°æ ¼å¼ï¼‰
                    var jsonFile = zip.file('database.json');
                    if (!jsonFile) {
                        showStatus('å¯¼å…¥å¤±è´¥ï¼šZIPæ–‡ä»¶ä¸­æœªæ‰¾åˆ° database.json', 'error');
                        return;
                    }

                    jsonFile.async('string').then(function(content) {
                        try {
                            var data = JSON.parse(content);
                            catalogData = data.catalogData;
                            uploadedFiles = data.uploadedFiles || [];
                            searchHistory = data.searchHistory || [];

                            // å¤„ç†å›¾ç‰‡
                            var imagePromises = [];
                            zip.folder('images').forEach(function (relativePath, zipEntry) {
                                var match = relativePath.match(/^([A-Z0-9\-\/]+)\.(jpg|png|jpeg|gif)$/i);
                                if (match) {
                                    var code = match[1].replace(/_/g, '-').toUpperCase();
                                    if (catalogData[code]) {
                                        imagePromises.push(zipEntry.async('base64').then(function(base64Data) {
                                            var mimeType = match[2] === 'jpg' ? 'jpeg' : match[2];
                                            catalogData[code].image = 'data:image/' + mimeType + ';base64,' + base64Data;
                                        }).catch(err => console.error('Image load failed for ' + code, err)));
                                    }
                                }
                            });

                            Promise.all(imagePromises).then(() => {
                                localStorage.setItem('search-history', JSON.stringify(searchHistory));
                                saveData().then(() => {
                                    updateStats();
                                    renderFilesList();
                                    renderManageProducts();
                                    renderResults();
                                    renderHistory();
                                    showStatus('âœ… å®Œæ•´æ•°æ®åº“ï¼ˆå«å›¾ç‰‡ï¼‰å¯¼å…¥æˆåŠŸï¼', 'success');
                                });
                            });

                        } catch (err) {
                            console.error('JSON parse error in ZIP:', err);
                            showStatus('å¯¼å…¥å¤±è´¥ï¼šdatabase.jsonæ ¼å¼é”™è¯¯ - ' + err.message, 'error');
                        }
                    });
                }).catch(function(err) {
                    console.error('ZIP load error:', err);
                    showStatus('å¯¼å…¥å¤±è´¥ï¼šZIPæ–‡ä»¶æŸåæˆ–æ ¼å¼é”™è¯¯', 'error');
                });
            };
            reader.readAsArrayBuffer(file);
        } else {
            showStatus('å¯¼å…¥å¤±è´¥ï¼šä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ã€‚è¯·å¯¼å…¥ .json æˆ– .zip æ–‡ä»¶ã€‚', 'error');
        }
    }

    document.getElementById('restoreInput').addEventListener('change', function(e) {
        importDatabase(e.target.files);
        e.target.value = '';
    });

    // PDF å¯¼å‡ºåŠŸèƒ½
    function exportQuotePDF() {
        showStatus('æ­£åœ¨ç”ŸæˆæŠ¥ä»·PDF...', 'loading');

        var allResults = [];
        searchResults.filter(r => r.found).forEach(r => allResults.push(r));
        rangeResults.forEach(r => { r.matches.forEach(r => allResults.push(r)); });

        // å»é‡
        var uniqueResults = {};
        allResults.forEach(r => { uniqueResults[r.code] = r; });
        allResults = Object.values(uniqueResults);

        // å†æ¬¡æ’åº
        allResults.sort(function(a, b) {
            var seriesA = a.code.match(/^[YC]*[ACDFGJMST]/);
            var seriesB = b.code.match(/^[YC]*[ACDFGJMST]/);
            seriesA = seriesA ? seriesA[0] : '';
            seriesB = seriesB ? seriesB[0] : '';
            if (seriesA !== seriesB) return seriesA.localeCompare(seriesB);

            var numA = parseInt(a.code.replace(/^[YC]*[ACDFGJMST]/, '')) || 0;
            var numB = parseInt(b.code.replace(/^[YC]*[ACDFGJMST]/, '')) || 0;
            return numA - numB;
        });

        if (allResults.length === 0) {
            showStatus('æ— ç»“æœå¯å¯¼å‡º', 'error');
            return;
        }

        var printContainer = document.createElement('div');
        printContainer.id = 'pdf-content';
        printContainer.style.cssText = 'position: absolute; left: -9999px; width: 250mm; font-family: "Microsoft YaHei", "å¾®è½¯é›…é»‘", sans-serif; background: white; padding: 15mm; line-height: 1.1;';
        document.body.appendChild(printContainer);

        var html = '<h1 style="text-align: center; color: #007AFF; font-size: 16pt; margin-bottom: 8mm; border-bottom: 2px solid #007AFF; padding-bottom: 4mm;">ğŸ­ å®‡ä¸œçººç»‡æŠ¥ä»·å•</h1>';
        html += '<div style="text-align: center; color: #666; margin-bottom: 6mm; font-size: 8pt;">ç”Ÿæˆæ—¶é—´ï¼š' + new Date().toLocaleString('zh-CN') + ' | äº§å“æ•°é‡ï¼š' + allResults.length + ' é¡¹</div>';

        html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 4mm; page-break-inside: auto; font-size: 7pt;">';
        html += '<thead><tr style="page-break-inside: avoid; page-break-after: auto;">';
        html += '<th style="width: 6%; background-color: #007AFF; color: white; padding: 5pt 3pt; text-align: center; font-size: 8pt; border: 1px solid #333; font-weight: bold;">åºå·</th>';
        html += '<th style="width: 14%; background-color: #007AFF; color: white; padding: 5pt 3pt; text-align: center; font-size: 8pt; border: 1px solid #333; font-weight: bold;">äº§å“ä»£ç </th>';
        html += '<th style="width: 9%; background-color: #007AFF; color: white; padding: 5pt 3pt; text-align: center; font-size: 8pt; border: 1px solid #333; font-weight: bold;">ç ä»·</th>';
        html += '<th style="width: 9%; background-color: #007AFF; color: white; padding: 5pt 3pt; text-align: center; font-size: 8pt; border: 1px solid #333; font-weight: bold;">ç±³ä»·</th>';
        html += '<th style="width: 9%; background-color: #007AFF; color: white; padding: 5pt 3pt; text-align: center; font-size: 8pt; border: 1px solid #333; font-weight: bold;">é—¨å¹…</th>';
        html += '<th style="width: 18%; background-color: #007AFF; color: white; padding: 5pt 3pt; text-align: center; font-size: 8pt; border: 1px solid #333; font-weight: bold;">æˆåˆ†</th>';
        html += '<th style="width: 9%; background-color: #007AFF; color: white; padding: 5pt 3pt; text-align: center; font-size: 8pt; border: 1px solid #333; font-weight: bold;">å…‹é‡</th>';
        html += '<th style="width: 26%; background-color: #007AFF; color: white; padding: 5pt 3pt; text-align: center; font-size: 8pt; border: 1px solid #333; font-weight: bold;">å¤‡æ³¨/è¯´æ˜</th>';
        html += '</tr></thead>';

        html += '<tbody>';
        allResults.forEach(function(product, index) {
            html += '<tr style="page-break-inside: avoid; page-break-after: auto;">';
            html += '<td style="padding: 3pt 2pt; text-align: center; border: 1px solid #ddd; font-size: 7pt; vertical-align: middle;">' + (index + 1) + '</td>';
            html += '<td style="padding: 3pt 2pt; text-align: center; border: 1px solid #ddd; font-size: 8pt; font-weight: bold; vertical-align: middle; color: #007AFF;">' + product.code + '</td>';
            html += '<td style="padding: 3pt 2pt; text-align: center; border: 1px solid #ddd; font-size: 8pt; font-weight: bold; vertical-align: middle; color: #34C759;">' + product.price + '</td>';
            html += '<td style="padding: 3pt 2pt; text-align: center; border: 1px solid #ddd; font-size: 7pt; vertical-align: middle;">' + product.priceAlt + '</td>';
            html += '<td style="padding: 3pt 2pt; text-align: center; border: 1px solid #ddd; font-size: 7pt; vertical-align: middle;">' + product.width + '</td>';
            html += '<td style="padding: 3pt 2pt; text-align: center; border: 1px solid #ddd; font-size: 7pt; vertical-align: middle; word-wrap: break-word;">' + product.composition + '</td>';
            html += '<td style="padding: 3pt 2pt; text-align: center; border: 1px solid #ddd; font-size: 7pt; vertical-align: middle;">' + product.weight + '</td>';
            html += '<td style="padding: 3pt 2pt; text-align: left; border: 1px solid #ddd; font-size: 6pt; vertical-align: top; color: #d32f2f; word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap; line-height: 1.2; hyphens: auto; display: block;">' + (product.notes && product.notes !== '-' ? product.notes : '') + '</td>';
            html += '</tr>';
        });
        html += '</tbody></table>';
        html += '<div style="text-align: center; color: #999; font-size: 6pt; margin-top: 8mm; border-top: 1px solid #ddd; padding-top: 4mm;">æœ¬æŠ¥ä»·å•ç”±å®‡ä¸œçººç»‡æŠ¥ä»·ç³»ç»Ÿç”Ÿæˆ | ç³»ç»Ÿç‰ˆæœ¬ï¼šv2.0</div>';

        printContainer.innerHTML = html;

        html2canvas(printContainer, {
            scale: 2,
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#ffffff',
            width: printContainer.scrollWidth,
            height: printContainer.scrollHeight,
            logging: false
        }).then(function(canvas) {
            var { jsPDF } = window.jspdf;
            var pdf = new jsPDF('l', 'mm', 'a4');
            var pdfWidth = pdf.internal.pageSize.getWidth();
            var pdfHeight = pdf.internal.pageSize.getHeight();
            var imgData = canvas.toDataURL('image/jpeg', 1.0);
            var imgWidth = 287; // A4 landscape width in mm (297 - 10*2 margin)
            var imgHeight = canvas.height * imgWidth / canvas.width;
            var heightLeft = imgHeight;
            var position = 5;

            pdf.addImage(imgData, 'JPEG', 5, position, imgWidth, imgHeight);
            heightLeft -= pdfHeight;

            while (heightLeft >= 0) {
                position = heightLeft - imgHeight + 5;
                pdf.addPage();
                pdf.addImage(imgData, 'JPEG', 5, position, imgWidth, imgHeight);
                heightLeft -= pdfHeight;
            }

            pdf.save('å®‡ä¸œçººç»‡æŠ¥ä»·å•_' + new Date().toLocaleDateString('zh-CN') + '.pdf');
            document.body.removeChild(printContainer);
            showStatus('âœ… æŠ¥ä»·PDFç”ŸæˆæˆåŠŸï¼', 'success');
        }).catch(function(error) {
            console.error('PDF generation error:', error);
            document.body.removeChild(printContainer);
            showStatus('PDFç”Ÿæˆå¤±è´¥ï¼š' + error.message, 'error');
        });
    }

    // --- ç®¡ç†æ¨¡å¼åŠŸèƒ½ ---
    function showImage(imageSrc, productCode) {
        var modal = document.getElementById('imageModal');
        var modalImg = document.getElementById('modalImage');
        modalImg.src = imageSrc;
        modalImg.alt = 'äº§å“ ' + productCode + ' åº•å¡å›¾ç‰‡';
        modal.classList.add('active');
    }

    function closeImageModal() {
        var modal = document.getElementById('imageModal');
        modal.classList.remove('active');
    }

    document.getElementById('imageModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeImageModal();
        }
    });

    function showImageByData(event) {
        const target = event.target.closest('a') || event.target;
        const code = target.dataset.code;
        if (code && catalogData[code] && catalogData[code].image) {
            showImage(catalogData[code].image, code);
        } else {
            showStatus('å›¾ç‰‡åŠ è½½å¤±è´¥', 'error');
        }
    }

    function bindImageEvents() {
        const resultsArea = document.getElementById('resultsArea');
        if (resultsArea) {
            resultsArea.addEventListener('click', function(e) {
                if (e.target.classList.contains('view-image-link')) {
                    showImageByData(e);
                }
            });
        }
        const manageList = document.getElementById('manageProductList');
        if (manageList) {
            manageList.addEventListener('click', function(e) {
                if (e.target.classList.contains('manage-product-image')) {
                    showImageByData(e);
                }
            });
        }
    }

    function selectFuzzyMatch(code) {
        document.getElementById('searchInput').value = code;
        handleSearch(code);
        renderResults();
    }

    function selectCode(code) {
        document.getElementById('searchInput').value = code;
        handleSearch(code);
        renderResults();
    }

    function toggleManageMode() {
        var btn = document.getElementById('manageBtn');
        var container = document.getElementById('manageContainer');
        var mainContent = document.getElementById('mainContent');
        var isActive = btn.classList.contains('active');

        if (isActive) {
            btn.classList.remove('active');
            container.classList.remove('active');
            mainContent.classList.remove('manage-mode');
            document.querySelector('h2').textContent = 'ğŸ” äº§å“æŸ¥è¯¢';
        } else {
            btn.classList.add('active');
            container.classList.add('active');
            mainContent.classList.add('manage-mode');
            document.querySelector('h2').textContent = 'ğŸ› ï¸ ç®¡ç†äº§å“';
            renderManageProducts();
        }
        bindImageEvents();
    }

    function addOrUpdateProduct() {
        var code = document.getElementById('codeInput').value.trim().toUpperCase();
        if (!code || !code.match(/^[YC]*[ACDFGJMST0-9][A-Z0-9\-\/]*$/)) {
            showStatus('äº§å“ä»£ç æ ¼å¼æ— æ•ˆï¼ˆä¾‹å¦‚ï¼šC6001ï¼‰', 'error');
            return;
        }

        if (catalogData[code] && editingCode !== code) {
            if (!confirm('äº§å“ä»£ç å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ')) return;
        }

        var imageFile = document.getElementById('imageInput').files[0];
        var imageBase64 = catalogData[code] ? catalogData[code].image : null;
        var isNewImage = !!imageFile;

        if (imageFile) {
            if (imageFile.size > 5 * 1024 * 1024) {
                showStatus('å›¾ç‰‡è¿‡å¤§ï¼ˆ>5MBï¼‰ï¼Œè¯·å‹ç¼©åä¸Šä¼ ', 'error');
                return;
            }
            var reader = new FileReader();
            reader.onload = function(e) {
                imageBase64 = e.target.result;
                saveProduct(code, imageBase64, isNewImage);
            };
            reader.onerror = function() {
                showStatus('å›¾ç‰‡è¯»å–å¤±è´¥', 'error');
            };
            reader.readAsDataURL(imageFile);
        } else {
            saveProduct(code, imageBase64, isNewImage);
        }
    }

    function saveProduct(code, imageBase64, isNewImage) {
        var isUpdate = !!catalogData[code];
        var newProduct = {
            price: document.getElementById('priceInput').value.trim() || '-',
            priceAlt: document.getElementById('priceAltInput').value.trim() || '-',
            width: document.getElementById('widthInput').value.trim() || '-',
            composition: document.getElementById('compositionInput').value.trim() || '-',
            weight: document.getElementById('weightInput').value.trim() || '-',
            notes: document.getElementById('notesInput').value.trim() || '-',
            supplier: document.getElementById('supplierInput').value.trim() || '-',
            image: imageBase64 // Base64 or null
        };

        // æ£€æŸ¥æ•°æ®åº“æ€»å¤§å°æ˜¯å¦ä¼šè¶…è¿‡é™åˆ¶ï¼ˆç²—ç•¥æ£€æŸ¥ï¼ŒIndexedDBä¸€èˆ¬æœ‰å‡ ç™¾MBï¼Œè¿™é‡Œé™åˆ¶åˆ° 150MBï¼‰
        const totalSize = JSON.stringify(catalogData).length + JSON.stringify(newProduct).length;
        if (totalSize > 150 * 1024 * 1024) {
            showStatus('æ•°æ®åº“å®¹é‡å°†è¶…å‡ºé™åˆ¶ (150MB)ï¼Œè¯·æ¸…ç†æˆ–åˆ†æ‰¹ä¸Šä¼ ã€‚', 'error');
            return;
        }

        catalogData[code] = newProduct;
        saveData().then(() => {
            updateStats();
            renderManageProducts();
            clearForm();
            editingCode = null;
            showStatus('äº§å“ ' + code + (isUpdate ? ' å·²æ›´æ–°' : ' å·²æ·»åŠ ') + 'ï¼', 'success');
        }).catch(error => {
            console.error('Save error:', error);
            showStatus('æ•°æ®ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
        });
    }


    function editProduct(code) {
        var product = catalogData[code];
        if (!product) return;

        editingCode = code;
        document.getElementById('codeInput').value = code;
        document.getElementById('priceInput').value = product.price;
        document.getElementById('priceAltInput').value = product.priceAlt;
        document.getElementById('widthInput').value = product.width;
        document.getElementById('compositionInput').value = product.composition;
        document.getElementById('weightInput').value = product.weight;
        document.getElementById('notesInput').value = product.notes;
        document.getElementById('supplierInput').value = product.supplier;

        document.getElementById('addBtn').style.display = 'none';
        document.getElementById('updateBtn').style.display = 'inline-block';
        document.getElementById('deleteBtn').style.display = 'inline-block';

        showStatus('ç¼–è¾‘æ¨¡å¼ï¼šä¿®æ”¹åç‚¹å‡»"æ›´æ–°äº§å“"', 'warning');
    }

    function deleteProduct() {
        if (!editingCode || !confirm('ç¡®å®šåˆ é™¤æ­¤äº§å“ï¼Ÿ')) return;

        delete catalogData[editingCode];

        saveData().then(() => {
            updateStats();
            renderManageProducts();
            clearForm();
            editingCode = null;
            document.getElementById('addBtn').style.display = 'inline-block';
            document.getElementById('updateBtn').style.display = 'none';
            document.getElementById('deleteBtn').style.display = 'none';
            showStatus('äº§å“å·²åˆ é™¤', 'success');
        });
    }

    function deleteProductFromList(code) {
        if (!confirm('ç¡®å®šåˆ é™¤äº§å“ ' + code + ' å—ï¼Ÿ')) return;
        delete catalogData[code];
        saveData().then(() => {
            updateStats();
            renderManageProducts();
            if (editingCode === code) clearForm();
            showStatus('äº§å“ ' + code + ' å·²åˆ é™¤', 'success');
        });
    }

    function clearForm() {
        document.getElementById('manageForm').reset();
        document.getElementById('imageInput').value = '';
        document.getElementById('bulkImageInput').value = '';
        editingCode = null;
        document.getElementById('addBtn').style.display = 'inline-block';
        document.getElementById('updateBtn').style.display = 'none';
        document.getElementById('deleteBtn').style.display = 'none';
    }

    function filterManageProducts() {
        manageSearchTerm = document.getElementById('manageSearchInput').value.toUpperCase();
        renderManageProducts();
    }

    function renderManageProducts() {
        var list = document.getElementById('manageProductList');
        var html = '';
        var count = 0;

        Object.keys(catalogData).sort().forEach(function(code) {
            var product = catalogData[code];
            if (manageSearchTerm && !code.toUpperCase().includes(manageSearchTerm) && !(product.supplier && product.supplier.toUpperCase().includes(manageSearchTerm))) {
                return;
            }

            count++;
            html += '<div class="manage-product-card">';
            html += '<div class="manage-product-actions">';
            html += '<button class="btn-edit" onclick="editProduct(\'' + code.replace(/'/g, "\\'") + '\')">ç¼–è¾‘</button>';
            html += '<button class="btn-remove" onclick="deleteProductFromList(\'' + code.replace(/'/g, "\\'") + '\')">åˆ é™¤</button>';
            html += '</div>';
            html += '<div class="manage-product-code">' + code + '</div>';
            if (product.image) {
                html += '<img src="' + product.image + '" alt="åº•å¡" class="manage-product-image" data-code="' + code + '">';
            }
            html += '<div class="manage-product-specs">';
            html += '<div class="manage-product-spec"><span>ç ä»·:</span><span>' + product.price + '</span></div>';
            html += '<div class="manage-product-spec"><span>ç±³ä»·:</span><span>' + product.priceAlt + '</span></div>';
            html += '<div class="manage-product-spec"><span>é—¨å¹…:</span><span>' + product.width + '</span></div>';
            html += '<div class="manage-product-spec"><span>å…‹é‡:</span><span>' + product.weight + '</span></div>';
            html += '<div class="manage-product-spec"><span>æˆåˆ†:</span><span>' + product.composition + '</span></div>';
            html += '<div class="manage-product-spec"><span>ä¾›åº”å•†:</span><span>' + product.supplier + '</span></div>';
            html += '<div class="manage-product-spec"><span>å¤‡æ³¨:</span><span>' + product.notes.substring(0, 10) + '...' + '</span></div>';
            html += '</div>';
            html += '</div>';
        });

        if (count === 0) {
            list.innerHTML = '<div class="empty-state" style="opacity:1"><div class="empty-text">æœªæ‰¾åˆ°äº§å“</div><div class="empty-subtext">è¯·å°è¯•æ›´æ”¹æœç´¢è¯</div></div>';
        } else {
            list.innerHTML = html;
        }
        // é‡æ–°ç»‘å®šå›¾ç‰‡äº‹ä»¶ï¼Œç¡®ä¿æ–°æ¸²æŸ“çš„å…ƒç´ ä¹Ÿç”Ÿæ•ˆ
        bindImageEvents();
    }

    document.getElementById('bulkImageInput').addEventListener('change', function(e) {
        var files = Array.from(e.target.files);
        if (files.length === 0) return;

        showStatus(`å¤„ç† ${files.length} å¼ å›¾ç‰‡...`, 'loading');

        let success = 0, fail = 0;
        const processFile = (file) => {
            return new Promise(resolve => {
                const name = file.name.toUpperCase();
                // åŒ¹é… äº§å“ä»£ç .jpg/png/jpeg/gif
                const match = name.match(/^([A-Z0-9\-\/]+)\.(JPG|PNG|JPEG|GIF)$/i);

                if (!match || file.size > 5 * 1024 * 1024) {
                    fail++;
                    return resolve();
                }

                const code = match[1];
                if (!catalogData[code]) {
                    fail++;
                    return resolve();
                }

                const reader = new FileReader();
                reader.onload = function(ev) {
                    catalogData[code].image = ev.target.result;
                    success++;
                    resolve();
                };
                reader.onerror = function() {
                    fail++;
                    resolve();
                };
                reader.readAsDataURL(file);
            });
        };

        Promise.all(files.map(processFile)).then(() => {
            saveData().then(() => {
                showStatus(`æ‰¹é‡ä¸Šä¼ å®Œæˆï¼š${success} æˆåŠŸï¼Œ${fail} å¤±è´¥`, 'success');
                renderManageProducts();
                e.target.value = '';
            });
        });
    });

    async function initApp() {
        await loadData();
        renderHistory();
        updateStats();
        renderManageProducts();
        renderFilesList();
        bindImageEvents();
    }

    initApp();
</script>
```

</body>
</html>