<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="å®‡ä¸œæŠ¥ä»·">
    <title>å®‡ä¸œçººç»‡æŠ¥ä»·ç³»ç»Ÿ</title>
    
    <!-- å¼•å…¥å¿…è¦çš„åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- AWS S3 SDK (å…¼å®¹Cloudflare R2) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aws-sdk/2.1462.0/aws-sdk.min.js"></script>

    <!-- PhotoSwipe å›¾ç‰‡æŸ¥çœ‹å™¨ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/5.4.4/photoswipe.min.css">
    
    <style>
        /* =========================================
           ğŸ iOS è®¾è®¡ç³»ç»Ÿ - å“åº”å¼ä¼˜åŒ–ç‰ˆ
           ========================================= */
        :root {
            /* --- iOS ç³»ç»Ÿé¢œè‰² --- */
            --ios-system-blue: #007AFF;
            --ios-system-green: #34C759;
            --ios-system-indigo: #5856D6;
            --ios-system-orange: #FF9500;
            --ios-system-pink: #FF2D55;
            --ios-system-purple: #AF52DE;
            --ios-system-red: #FF3B30;
            --ios-system-teal: #5AC8FA;
            --ios-system-yellow: #FFCC00;
            
            /* --- iOS èƒŒæ™¯ä¸è¡¨é¢ --- */
            --ios-system-background: #FFFFFF;
            --ios-system-background-secondary: #F2F2F7;
            --ios-system-background-tertiary: #FFFFFF;
            --ios-system-grouped-background: #F2F2F7;
            --ios-system-grouped-background-secondary: #FFFFFF;
            
            /* --- iOS æ ‡ç­¾ä¸æ–‡æœ¬ --- */
            --ios-label-primary: #000000;
            --ios-label-secondary: #3C3C4399;
            --ios-label-tertiary: #3C3C434D;
            --ios-label-quaternary: #3C3C432E;
            
            /* --- iOS åˆ†éš”çº¿ --- */
            --ios-separator: #C6C6C8;
            --ios-separator-opaque: #C6C6C8;
            
            /* --- é˜´å½±ç³»ç»Ÿ --- */
            --ios-shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --ios-shadow-md: 0 4px 12px rgba(0,0,0,0.15);
            --ios-shadow-lg: 0 10px 30px rgba(0,0,0,0.2);
            
            /* --- åœ†è§’ç³»ç»Ÿ --- */
            --ios-radius-sm: 8px;
            --ios-radius-md: 12px;
            --ios-radius-lg: 16px;
            --ios-radius-xl: 20px;
            
            /* --- é—´è·ç³»ç»Ÿ --- */
            --ios-spacing-xs: 8px;
            --ios-spacing-sm: 12px;
            --ios-spacing-md: 16px;
            --ios-spacing-lg: 20px;
            --ios-spacing-xl: 24px;
            --ios-spacing-xxl: 32px;
            
            /* --- å®‰å…¨åŒºåŸŸ --- */
            --ios-safe-area-top: env(safe-area-inset-top);
            --ios-safe-area-bottom: env(safe-area-inset-bottom);
        }

        /* =========================================
           åŸºç¡€é‡ç½®ä¸æ’ç‰ˆ - å“åº”å¼ä¼˜åŒ–
           ========================================= */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            height: 100%;
            -webkit-text-size-adjust: 100%;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--ios-system-grouped-background);
            color: var(--ios-label-primary);
            line-height: 1.47059;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
            padding: 0;
            display: flex;
            justify-content: center;
            /* iOS æ»šåŠ¨è¡Œä¸º */
            -webkit-overflow-scrolling: touch;
            overflow-scrolling: touch;
        }

        /* å“åº”å¼å®¹å™¨ */
        .ios-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            background: var(--ios-system-background);
            min-height: 100vh;
            position: relative;
            transition: all 0.3s ease;
        }

        /* =========================================
           æ¡Œé¢ç«¯é€‚é… - åª’ä½“æŸ¥è¯¢
           ========================================= */
        @media (min-width: 768px) {
            .ios-container {
                max-width: 100%;
                margin: 20px auto;
                border-radius: 20px;
                box-shadow: var(--ios-shadow-lg);
                min-height: calc(100vh - 40px);
                max-height: calc(100vh - 40px);
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            
            body {
                padding: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            
            /* æ¡Œé¢ç«¯å¸ƒå±€ä¼˜åŒ– - ä¿®å¤æ»šåŠ¨é—®é¢˜ */
            .ios-content {
                display: grid;
                grid-template-columns: 1fr 300px;
                gap: var(--ios-spacing-lg);
                flex: 1;
                min-height: 0;
                overflow: hidden;
            }
            
            .ios-main-content {
                overflow-y: auto;
                padding-right: 10px;
                height: 100%;
            }
            
            .ios-tab-content {
                height: auto;
                min-height: 100%;
            }
            
            /* æ¡Œé¢ç«¯ä¾§è¾¹æ  */
            .ios-sidebar {
                background: var(--ios-system-background-secondary);
                border-radius: var(--ios-radius-lg);
                padding: var(--ios-spacing-lg);
                height: 100%;
                overflow-y: auto;
                display: block;
            }
            
            /* æ¡Œé¢ç«¯ç»Ÿè®¡å¡ç‰‡ä¼˜åŒ– */
            .ios-stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            /* æ¡Œé¢ç«¯äº§å“å¡ç‰‡ä¼˜åŒ– */
            .ios-product-card {
                display: flex;
                flex-direction: column;
            }
            
            .ios-product-header {
                flex-shrink: 0;
            }
            
            .ios-product-details {
                flex-grow: 1;
            }
            
            /* æ¡Œé¢ç«¯æœç´¢ä¼˜åŒ– */
            .ios-search-bar {
                margin-bottom: var(--ios-spacing-lg);
            }
            
            /* æ¡Œé¢ç«¯æŒ‰é’®ä¼˜åŒ– */
            .ios-button {
                transition: all 0.2s ease;
            }
            
            .ios-button:hover {
                transform: translateY(-1px);
                box-shadow: var(--ios-shadow-md);
            }
            
            /* æ¡Œé¢ç«¯æ¨¡æ€æ¡†ä¼˜åŒ– */
            .ios-modal-content {
                max-width: 600px;
            }
        }

        /* å¤§æ¡Œé¢ç«¯ä¼˜åŒ– */
        @media (min-width: 1200px) {
            .ios-container {
                max-width: 1400px;
            }
            
            .ios-content {
                grid-template-columns: 1fr 350px;
            }
            
            .ios-stats-grid {
                grid-template-columns: repeat(6, 1fr);
            }
            
            /* å¤§å±å¹•äº§å“ç½‘æ ¼å¸ƒå±€ */
            .ios-product-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: var(--ios-spacing-md);
            }
            
            .ios-product-card {
                margin-bottom: 0;
            }
        }

        /* å¹³æ¿ç«¯ä¼˜åŒ– */
        @media (min-width: 768px) and (max-width: 1199px) {
            .ios-container {
                max-width: 900px;
            }
            
            .ios-content {
                grid-template-columns: 1fr;
            }
            
            .ios-sidebar {
                display: none;
            }
            
            .ios-stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* =========================================
           é‡æ–°è®¾è®¡é¡¶éƒ¨åŒºåŸŸ - ç§»é™¤çŠ¶æ€æ åä¼˜åŒ–
           ========================================= */
        .ios-header {
            padding: calc(var(--ios-safe-area-top) + var(--ios-spacing-md)) var(--ios-spacing-md) var(--ios-spacing-sm);
            background: var(--ios-system-background);
            border-bottom: 0.5px solid var(--ios-separator);
        }

        .ios-brand {
            font-size: 22px;
            font-weight: 700;
            color: var(--ios-label-primary);
            margin-bottom: var(--ios-spacing-xs);
        }

        .ios-brand-accent {
            color: var(--ios-system-blue);
        }

        .ios-nav-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--ios-label-primary);
        }

        /* æ¡Œé¢ç«¯å¤´éƒ¨ä¼˜åŒ– */
        @media (min-width: 768px) {
            .ios-header {
                padding: var(--ios-spacing-lg) var(--ios-spacing-xl) var(--ios-spacing-md);
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-shrink: 0;
            }
            
            .ios-brand {
                margin-bottom: 0;
                font-size: 24px;
            }
            
            .ios-nav-title {
                font-size: 18px;
            }
        }

        /* =========================================
           2. iOS å†…å®¹åŒºåŸŸ - å“åº”å¼ä¼˜åŒ–
           ========================================= */
        .ios-content {
            padding: var(--ios-spacing-md);
            padding-bottom: calc(84px + var(--ios-safe-area-bottom));
        }

        .ios-tab-content {
            display: none;
        }

        .ios-tab-content.active {
            display: block;
            animation: iosFadeIn 0.3s ease-out;
        }

        .ios-section {
            margin-bottom: var(--ios-spacing-xl);
        }

        .ios-section-header {
            font-size: 13px;
            font-weight: 600;
            color: var(--ios-label-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--ios-spacing-sm);
            padding: 0 var(--ios-spacing-md);
        }

        /* æ¡Œé¢ç«¯å†…å®¹åŒºåŸŸä¼˜åŒ– */
        @media (min-width: 768px) {
            .ios-content {
                padding: var(--ios-spacing-xl);
                padding-bottom: var(--ios-spacing-xl);
                flex: 1;
                min-height: 0;
                overflow: hidden;
            }
            
            .ios-section {
                margin-bottom: var(--ios-spacing-xxl);
            }
            
            .ios-section-header {
                font-size: 14px;
                padding: 0;
            }
        }

        /* =========================================
           3. iOS å¡ç‰‡è®¾è®¡ - å“åº”å¼ä¼˜åŒ–ç‰ˆ
           ========================================= */
        .ios-card {
            background: var(--ios-system-background);
            border-radius: var(--ios-radius-lg);
            overflow: hidden;
            margin-bottom: var(--ios-spacing-md);
            box-shadow: var(--ios-shadow-sm);
            border: 0.5px solid var(--ios-separator);
            transition: all 0.3s ease;
        }

        .ios-card-header {
            padding: var(--ios-spacing-md);
            border-bottom: 0.5px solid var(--ios-separator);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ios-card-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--ios-label-primary);
        }

        .ios-card-content {
            padding: var(--ios-spacing-md);
        }

        .ios-card-footer {
            padding: var(--ios-spacing-md);
            border-top: 0.5px solid var(--ios-separator);
            background: var(--ios-system-background-secondary);
        }

        /* æ¡Œé¢ç«¯å¡ç‰‡ä¼˜åŒ– */
        @media (min-width: 768px) {
            .ios-card {
                margin-bottom: var(--ios-spacing-lg);
            }
            
            .ios-card:hover {
                transform: translateY(-2px);
                box-shadow: var(--ios-shadow-md);
            }
        }

        /* =========================================
           4. iOS æŒ‰é’®è®¾è®¡ - å“åº”å¼ä¼˜åŒ–ç‰ˆ
           ========================================= */
        .ios-button {
            background: var(--ios-system-blue);
            color: white;
            border: none;
            border-radius: var(--ios-radius-md);
            padding: 10px 16px;
            font-size: 15px;
            font-weight: 600;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 36px;
            transition: all 0.1s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .ios-button:active {
            opacity: 0.7;
            transform: scale(0.98);
        }

        .ios-button-secondary {
            background: var(--ios-system-background-secondary);
            color: var(--ios-system-blue);
            border: 1px solid var(--ios-system-blue);
        }

        .ios-button-destructive {
            background: var(--ios-system-red);
        }

        .ios-button-full {
            width: 100%;
        }

        .ios-button-small {
            padding: 6px 10px;
            font-size: 13px;
            min-height: 32px;
        }

        .ios-button-compact {
            padding: 4px 8px;
            font-size: 12px;
            min-height: 28px;
        }

        /* æ–°å¢ï¼šä¿å­˜æŒ‰é’®çŠ¶æ€æ ·å¼ */
        .ios-button-saving {
            background-color: var(--ios-label-tertiary) !important;
            pointer-events: none;
        }

        .ios-button-saving::after {
            content: '';
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }

        /* æ–°å¢ï¼šç¦»çº¿æ¨¡å¼æŒ‰é’®æ ·å¼ */
        .ios-button:disabled,
        .ios-button.offline-disabled {
            background-color: var(--ios-label-tertiary) !important;
            color: var(--ios-label-quaternary) !important;
            border-color: var(--ios-separator) !important;
            pointer-events: none;
            cursor: not-allowed;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* æ¡Œé¢ç«¯æŒ‰é’®ä¼˜åŒ– */
        @media (min-width: 768px) {
            .ios-button {
                padding: 12px 20px;
                font-size: 16px;
                min-height: 40px;
            }
            
            .ios-button-small {
                padding: 8px 12px;
                font-size: 14px;
                min-height: 34px;
            }
            
            .ios-button-compact {
                padding: 6px 10px;
                font-size: 13px;
                min-height: 30px;
            }
            
            .ios-button:hover {
                transform: translateY(-1px);
                box-shadow: var(--ios-shadow-md);
            }
        }

        /* =========================================
           5. iOS è¡¨å•å…ƒç´  - å“åº”å¼ä¼˜åŒ–
           ========================================= */
        .ios-input-group {
            margin-bottom: var(--ios-spacing-lg);
        }

        .ios-input-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--ios-label-secondary);
            margin-bottom: var(--ios-spacing-xs);
            display: block;
        }

        .ios-input {
            width: 100%;
            background: var(--ios-system-background);
            border: 1px solid var(--ios-separator);
            border-radius: var(--ios-radius-md);
            padding: var(--ios-spacing-md);
            font-size: 17px;
            color: var(--ios-label-primary);
            min-height: 44px;
            -webkit-appearance: none;
        }

        .ios-input:focus {
            outline: none;
            border-color: var(--ios-system-blue);
        }

        .ios-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
            line-height: 1.4;
        }

        /* æ¡Œé¢ç«¯è¡¨å•ä¼˜åŒ– */
        @media (min-width: 768px) {
            .ios-input-group {
                margin-bottom: var(--ios-spacing-xl);
            }
            
            .ios-input-label {
                font-size: 14px;
            }
            
            .ios-input {
                padding: var(--ios-spacing-lg);
                font-size: 16px;
                min-height: 48px;
            }
        }

        /* =========================================
           6. iOS åº•éƒ¨æ ‡ç­¾æ  - å“åº”å¼ä¼˜åŒ–
           ========================================= */
        .ios-tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--ios-system-background);
            border-top: 0.5px solid var(--ios-separator);
            display: flex;
            justify-content: space-around;
            padding-bottom: var(--ios-safe-area-bottom);
            height: 84px;
            z-index: 1000;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .ios-tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 0;
            color: var(--ios-label-tertiary);
            text-decoration: none;
            transition: all 0.2s ease;
            position: relative;
            cursor: pointer;
        }

        .ios-tab-item.active {
            color: var(--ios-system-blue);
        }

        .ios-tab-icon {
            width: 28px;
            height: 28px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .ios-tab-icon svg {
            width: 24px;
            height: 24px;
        }

        .ios-tab-label {
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .ios-tab-indicator {
            position: absolute;
            top: -4px;
            width: 4px;
            height: 4px;
            border-radius: 2px;
            background: var(--ios-system-blue);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .ios-tab-item.active .ios-tab-indicator {
            opacity: 1;
        }

        /* æ¡Œé¢ç«¯å¯¼èˆªä¼˜åŒ– */
        @media (min-width: 768px) {
            .ios-tab-bar {
                position: static;
                height: auto;
                padding: 0;
                border-top: none;
                border-bottom: 0.5px solid var(--ios-separator);
                justify-content: flex-start;
                padding: 0 var(--ios-spacing-xl);
                flex-shrink: 0;
            }
            
            .ios-tab-item {
                flex: 0 0 auto;
                flex-direction: row;
                padding: var(--ios-spacing-md) var(--ios-spacing-lg);
                margin-right: var(--ios-spacing-md);
            }
            
            .ios-tab-icon {
                margin-bottom: 0;
                margin-right: var(--ios-spacing-sm);
            }
            
            .ios-tab-label {
                font-size: 16px;
            }
            
            .ios-tab-indicator {
                top: auto;
                bottom: 0;
                width: 100%;
                height: 3px;
                border-radius: 3px 3px 0 0;
            }
        }

        /* =========================================
           7. iOS æœç´¢æ  - å“åº”å¼ä¼˜åŒ–
           ========================================= */
        .ios-search-bar {
            position: relative;
            background: var(--ios-system-background-secondary);
            border-radius: var(--ios-radius-lg);
            padding: var(--ios-spacing-sm) var(--ios-spacing-md);
            margin-bottom: var(--ios-spacing-md);
            display: flex;
            align-items: center;
        }

        .ios-search-icon {
            color: var(--ios-label-tertiary);
            margin-right: var(--ios-spacing-sm);
        }

        .ios-search-input {
            flex: 1;
            background: none;
            border: none;
            font-size: 17px;
            color: var(--ios-label-primary);
            outline: none;
            padding-right: 30px; /* ä¸ºé‡ç½®æŒ‰é’®ç•™å‡ºç©ºé—´ */
        }

        .ios-search-input::placeholder {
            color: var(--ios-label-tertiary);
        }

        /* æ–°å¢ï¼šæœç´¢æ¡†é‡ç½®æŒ‰é’®æ ·å¼ */
        .ios-search-reset {
            position: absolute;
            right: var(--ios-spacing-md);
            background: var(--ios-label-tertiary);
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease, background-color 0.2s ease;
            pointer-events: none;
        }

        .ios-search-reset.show {
            opacity: 1;
            pointer-events: auto;
        }

        .ios-search-reset:active {
            background: var(--ios-label-secondary);
        }

        /* æ¡Œé¢ç«¯æœç´¢ä¼˜åŒ– */
        @media (min-width: 768px) {
            .ios-search-bar {
                padding: var(--ios-spacing-md) var(--ios-spacing-lg);
                margin-bottom: var(--ios-spacing-lg);
            }
            
            .ios-search-input {
                font-size: 16px;
            }
            
            .ios-search-reset {
                right: var(--ios-spacing-lg);
                width: 22px;
                height: 22px;
                font-size: 16px;
            }
            
            .ios-search-reset:hover {
                background: var(--ios-label-secondary);
            }
        }

        /* =========================================
           8. iOS äº§å“å¡ç‰‡ - å“åº”å¼ä¼˜åŒ–ç‰ˆ
           ========================================= */
        .ios-product-card {
            background: var(--ios-system-background);
            border-radius: var(--ios-radius-lg);
            padding: var(--ios-spacing-md);
            margin-bottom: var(--ios-spacing-md);
            box-shadow: var(--ios-shadow-sm);
            border: 0.5px solid var(--ios-separator);
            position: relative;
            transition: all 0.3s ease;
        }

        /* é‡æ–°è®¾è®¡äº§å“å¤´éƒ¨ - å›¾ç‰‡åœ¨å³ä¸Šè§’ */
        .ios-product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--ios-spacing-md);
        }

        .ios-product-code-container {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .ios-product-code {
            font-size: 18px;
            font-weight: 700;
            color: var(--ios-label-primary);
            font-family: 'SF Mono', Menlo, monospace;
        }

        .ios-product-status {
            width: 8px;
            height: 8px;
            border-radius: 4px;
            background: var(--ios-system-green);
            margin-left: var(--ios-spacing-xs);
        }

        .ios-product-status.missing {
            background: var(--ios-system-orange);
        }

        /* å³ä¸Šè§’å›¾ç‰‡å®¹å™¨ */
        .ios-product-image-container {
            margin-left: var(--ios-spacing-sm);
        }

        .ios-product-image {
            width: 60px;
            height: 60px;
            border-radius: var(--ios-radius-md);
            background: var(--ios-system-background-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 0.5px solid var(--ios-separator);
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .ios-product-image:hover {
            transform: scale(1.05);
        }

        .ios-product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* é‡æ–°è®¾è®¡äº§å“è¯¦æƒ…å¸ƒå±€ - ä¿æŒ2åˆ—ç½‘æ ¼ */
        .ios-product-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--ios-spacing-sm);
            margin-bottom: var(--ios-spacing-md);
        }

        .ios-product-detail {
            display: flex;
            flex-direction: column;
            padding: var(--ios-spacing-sm);
            background: var(--ios-system-background-secondary);
            border-radius: var(--ios-radius-md);
        }

        .ios-product-detail-label {
            font-size: 11px;
            color: var(--ios-label-tertiary);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ios-product-detail-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--ios-label-primary);
        }

        /* ç ä»·å’Œç±³ä»·çªå‡ºæ˜¾ç¤º */
        .ios-product-detail:nth-child(1) .ios-product-detail-value,
        .ios-product-detail:nth-child(2) .ios-product-detail-value {
            color: var(--ios-system-blue);
            font-weight: 700;
        }

        /* å¤‡æ³¨ä¿¡æ¯æ ·å¼ */
        .ios-product-notes {
            background: var(--ios-system-orange);
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 8px 12px;
            border-radius: var(--ios-radius-sm);
            display: inline-block;
            margin-top: var(--ios-spacing-sm);
            width: 100%;
            text-align: center;
        }

        /* äº§å“ç®¡ç†å¡ç‰‡ä¸­çš„ç¼–è¾‘åˆ é™¤æŒ‰é’®ä¼˜åŒ– */
        .ios-product-actions {
            display: flex;
            gap: var(--ios-spacing-sm);
            margin-top: var(--ios-spacing-md);
            justify-content: center;
        }

        .ios-product-actions .ios-button {
            flex: 0 0 30%; /* è¿›ä¸€æ­¥ç¼©å°æŒ‰é’®å®½åº¦ */
            min-width: 0;
            padding: 6px 8px;
            font-size: 12px;
        }

        /* æ¡Œé¢ç«¯äº§å“å¡ç‰‡ä¼˜åŒ– */
        @media (min-width: 768px) {
            .ios-product-card {
                padding: var(--ios-spacing-lg);
                margin-bottom: var(--ios-spacing-lg);
            }
            
            .ios-product-code {
                font-size: 20px;
            }
            
            .ios-product-image {
                width: 80px;
                height: 80px;
            }
            
            .ios-product-details {
                grid-template-columns: repeat(3, 1fr);
                gap: var(--ios-spacing-md);
            }
            
            .ios-product-detail {
                padding: var(--ios-spacing-md);
            }
            
            .ios-product-detail-label {
                font-size: 12px;
            }
            
            .ios-product-detail-value {
                font-size: 16px;
            }
            
            .ios-product-actions .ios-button {
                padding: 8px 12px;
                font-size: 14px;
            }
        }

        /* å¤§å±å¹•äº§å“ç½‘æ ¼å¸ƒå±€ */
        @media (min-width: 1200px) {
            .ios-product-card {
                display: flex;
                flex-direction: column;
                height: 100%;
            }
            
            .ios-product-header {
                flex-shrink: 0;
            }
            
            .ios-product-details {
                flex-grow: 1;
            }
            
            .ios-product-actions {
                flex-shrink: 0;
            }
        }

        /* =========================================
           9. iOS æ¨¡æ€æ¡† - å“åº”å¼ä¼˜åŒ–ç‰ˆ
           ========================================= */
        .ios-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: var(--ios-spacing-md);
        }

        .ios-modal.active {
            display: flex;
        }

        .ios-modal-content {
            background: var(--ios-system-background);
            border-radius: var(--ios-radius-xl);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--ios-shadow-lg);
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .ios-modal.active .ios-modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .ios-modal-header {
            padding: var(--ios-spacing-md);
            border-bottom: 0.5px solid var(--ios-separator);
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 44px; /* ç¡®ä¿æœ€å°è§¦æ‘¸åŒºåŸŸ */
        }

        .ios-modal-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--ios-label-primary);
        }

        .ios-modal-body {
            padding: var(--ios-spacing-md);
            max-height: 70vh;
            overflow-y: auto;
        }

        /* æ–°å¢ï¼šæ¨¡æ€æ¡†æŒ‰é’®ä¼˜åŒ– */
        .ios-modal-header .ios-nav-button {
            background: transparent;
            border: none;
            color: var(--ios-system-blue);
            font-size: 17px;
            font-weight: 600;
            padding: 10px 16px;
            border-radius: var(--ios-radius-md);
            min-height: 36px;
            min-width: 60px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ios-modal-header .ios-nav-button:active {
            background-color: rgba(0, 122, 255, 0.1);
        }

        /* æ¡Œé¢ç«¯æ¨¡æ€æ¡†ä¼˜åŒ– */
        @media (min-width: 768px) {
            .ios-modal-content {
                max-width: 600px;
            }
            
            .ios-modal-header {
                padding: var(--ios-spacing-lg);
            }
            
            .ios-modal-title {
                font-size: 20px;
            }
            
            .ios-modal-body {
                padding: var(--ios-spacing-lg);
            }
            
            .ios-modal-header .ios-nav-button {
                font-size: 18px;
                padding: 12px 20px;
                min-height: 40px;
                min-width: 70px;
            }
            
            .ios-modal-header .ios-nav-button:hover {
                background-color: rgba(0, 122, 255, 0.05);
            }
        }

        /* =========================================
           10. iOS ç»Ÿè®¡å¡ç‰‡ - å“åº”å¼ä¼˜åŒ–
           ========================================= */
        .ios-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--ios-spacing-md);
        }

        .ios-stat-item {
            text-align: center;
            padding: var(--ios-spacing-md);
            background: var(--ios-system-background);
            border-radius: var(--ios-radius-lg);
            box-shadow: var(--ios-shadow-sm);
            border: 0.5px solid var(--ios-separator);
            transition: all 0.3s ease;
        }

        .ios-stat-value {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: var(--ios-spacing-xs);
            line-height: 1.2;
            white-space: nowrap; /* é˜²æ­¢æ–‡å­—æ¢è¡Œ */
        }

        .ios-stat-label {
            font-size: 13px;
            color: var(--ios-label-secondary);
        }

        /* ç¼“å­˜å¤§å°å•ä½ç‰¹æ®Šæ ·å¼ - ä¿®å¤ç”µè„‘ç«¯æ¢è¡Œé—®é¢˜ */
        .cache-size-unit {
            font-size: 14px;
            color: var(--ios-system-blue);
            font-weight: 600;
            display: inline-block;
            line-height: 1;
            vertical-align: baseline;
        }

        /* æ¡Œé¢ç«¯ç»Ÿè®¡å¡ç‰‡ä¼˜åŒ– */
        @media (min-width: 768px) {
            .ios-stats-grid {
                gap: var(--ios-spacing-lg);
            }
            
            .ios-stat-item {
                padding: var(--ios-spacing-lg);
            }
            
            .ios-stat-value {
                font-size: 24px;
            }
            
            .ios-stat-label {
                font-size: 14px;
            }
            
            .ios-stat-item:hover {
                transform: translateY(-2px);
                box-shadow: var(--ios-shadow-md);
            }
            
            /* æ¡Œé¢ç«¯ç¼“å­˜å¤§å°å•ä½ - ä¿®å¤æ¢è¡Œé—®é¢˜ */
            .cache-size-unit {
                font-size: 16px;
                line-height: 1;
                vertical-align: baseline;
            }
        }

        /* å¤§æ¡Œé¢ç«¯ç»Ÿè®¡å¡ç‰‡ä¼˜åŒ– */
        @media (min-width: 1200px) {
            .ios-stats-grid {
                grid-template-columns: repeat(6, 1fr);
            }
            
            .ios-stat-item {
                padding: var(--ios-spacing-md);
            }
            
            .ios-stat-value {
                font-size: 20px;
            }
            
            /* å¤§æ¡Œé¢ç«¯ç¼“å­˜å¤§å°å•ä½ä¼˜åŒ– */
            .cache-size-unit {
                font-size: 14px;
            }
        }

        /* =========================================
           11. iOS çŠ¶æ€æ¶ˆæ¯ - å“åº”å¼ä¼˜åŒ–
           ========================================= */
        .ios-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: var(--ios-spacing-md) var(--ios-spacing-lg);
            border-radius: var(--ios-radius-lg);
            font-size: 16px;
            font-weight: 600;
            z-index: 3000;
            display: none;
            text-align: center;
            max-width: 280px;
            box-shadow: var(--ios-shadow-lg);
        }

        .ios-toast.show {
            display: block;
            animation: toastFadeIn 0.3s ease-out;
        }

        @keyframes toastFadeIn {
            from { opacity: 0; transform: translate(-50%, -40%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

        /* æ–°å¢ï¼šç¦»çº¿çŠ¶æ€æç¤ºæ¡ */
        .ios-offline-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--ios-system-orange);
            color: white;
            padding: var(--ios-spacing-sm) var(--ios-spacing-md);
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            z-index: 1500;
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        .ios-offline-bar.show {
            display: block;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        /* æ¡Œé¢ç«¯Toastä¼˜åŒ– */
        @media (min-width: 768px) {
            .ios-toast {
                max-width: 350px;
                font-size: 17px;
                padding: var(--ios-spacing-lg) var(--ios-spacing-xl);
            }
            
            .ios-offline-bar {
                padding: var(--ios-spacing-md) var(--ios-spacing-lg);
                font-size: 16px;
            }
        }

        /* =========================================
           12. iOS åˆ—è¡¨è®¾è®¡ - å“åº”å¼ä¼˜åŒ–
           ========================================= */
        .ios-list {
            background: var(--ios-system-background);
            border-radius: var(--ios-radius-lg);
            overflow: hidden;
            box-shadow: var(--ios-shadow-sm);
            border: 0.5px solid var(--ios-separator);
        }

        .ios-list-item {
            display: flex;
            align-items: center;
            padding: var(--ios-spacing-md);
            min-height: 44px;
            border-bottom: 0.5px solid var(--ios-separator);
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .ios-list-item:last-child {
            border-bottom: none;
        }

        .ios-list-item:active {
            background-color: var(--ios-system-background-secondary);
        }

        .ios-list-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--ios-radius-md);
            background: var(--ios-system-background-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: var(--ios-spacing-md);
            flex-shrink: 0;
        }

        .ios-list-content {
            flex: 1;
            min-width: 0;
        }

        .ios-list-title {
            font-size: 17px;
            font-weight: 400;
            color: var(--ios-label-primary);
            margin-bottom: 2px;
        }

        .ios-list-subtitle {
            font-size: 13px;
            font-weight: 400;
            color: var(--ios-label-secondary);
        }

        /* æ¡Œé¢ç«¯åˆ—è¡¨ä¼˜åŒ– */
        @media (min-width: 768px) {
            .ios-list-item {
                padding: var(--ios-spacing-lg);
                min-height: 50px;
            }
            
            .ios-list-icon {
                width: 36px;
                height: 36px;
            }
            
            .ios-list-title {
                font-size: 18px;
            }
            
            .ios-list-subtitle {
                fontSize: 14px;
            }
            
            .ios-list-item:hover {
                background-color: var(--ios-system-background-secondary);
            }
        }

        /* =========================================
           13. è®¾ç½®é¡µé¢ä¼˜åŒ– - äº‘å­˜å‚¨é…ç½®
           ========================================= */
        .ios-settings-section {
            background: var(--ios-system-background);
            border-radius: var(--ios-radius-lg);
            padding: var(--ios-spacing-md);
            margin-bottom: var(--ios-spacing-md);
            box-shadow: var(--ios-shadow-sm);
            border: 0.5px solid var(--ios-separator);
        }

        .ios-settings-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--ios-label-primary);
            margin-bottom: var(--ios-spacing-md);
        }

        .ios-settings-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--ios-spacing-md);
        }

        .ios-settings-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--ios-spacing-sm);
        }

        .ios-settings-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--ios-spacing-sm);
            margin-top: var(--ios-spacing-md);
        }

        /* æ¡Œé¢ç«¯è®¾ç½®ä¼˜åŒ– */
        @media (min-width: 768px) {
            .ios-settings-section {
                padding: var(--ios-spacing-lg);
                margin-bottom: var(--ios-spacing-lg);
            }
            
            .ios-settings-title {
                font-size: 20px;
                margin-bottom: var(--ios-spacing-lg);
            }
            
            .ios-settings-grid {
                gap: var(--ios-spacing-lg);
            }
            
            .ios-settings-row {
                grid-template-columns: 1fr 1fr;
                gap: var(--ios-spacing-md);
            }
            
            .ios-settings-actions {
                grid-template-columns: repeat(4, 1fr);
                gap: var(--ios-spacing-md);
            }
        }

        /* =========================================
           å“åº”å¼è°ƒæ•´ - ç§»åŠ¨ç«¯ä¼˜åŒ–
           ========================================= */
        @media (max-width: 375px) {
            .ios-container {
                max-width: 100%;
            }
            
            .ios-content {
                padding: var(--ios-spacing-sm);
                padding-bottom: calc(84px + var(--ios-safe-area-bottom));
            }
            
            .ios-product-details {
                grid-template-columns: 1fr;
            }
            
            .ios-stats-grid {
                grid-template-columns: 1fr;
            }
            
            .ios-settings-grid {
                grid-template-columns: 1fr;
            }
            
            /* å°å±å¹•è°ƒæ•´å›¾ç‰‡å°ºå¯¸ */
            .ios-product-image {
                width: 50px;
                height: 50px;
            }
        }

        /* =========================================
           å·¥å…·ç±»
           ========================================= */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mb-sm { margin-bottom: var(--ios-spacing-sm); }
        .mb-md { margin-bottom: var(--ios-spacing-md); }
        .mb-lg { margin-bottom: var(--ios-spacing-lg); }
        .mt-sm { margin-top: var(--ios-spacing-sm); }
        .mt-md { margin-top: var(--ios-spacing-md); }
        .mt-lg { margin-top: var(--ios-spacing-lg); }
        .flex { display: flex; }
        .flex-1 { flex: 1; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .hidden { display: none; }

        /* =========================================
           åŠ¨ç”»
           ========================================= */
        @keyframes iosFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ios-fade-in {
            animation: iosFadeIn 0.3s ease-out;
        }

        /* =========================================
           ä¾§è¾¹æ æ ·å¼
           ========================================= */
        .ios-sidebar {
            display: none; /* é»˜è®¤åœ¨æ‰‹æœºç«¯éšè—ä¾§è¾¹æ  */
        }

        .ios-sidebar-section {
            margin-bottom: var(--ios-spacing-xl);
        }

        .ios-sidebar-section-header {
            font-size: 13px;
            font-weight: 600;
            color: var(--ios-label-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--ios-spacing-sm);
        }

        /* æ¡Œé¢ç«¯ä¾§è¾¹æ ä¼˜åŒ– */
        @media (min-width: 768px) {
            .ios-sidebar {
                display: block; /* åœ¨æ¡Œé¢ç«¯æ˜¾ç¤ºä¾§è¾¹æ  */
            }
            
            .ios-sidebar-section {
                margin-bottom: var(--ios-spacing-xxl);
            }
            
            .ios-sidebar-section-header {
                font-size: 14px;
            }
        }

        /* =========================================
           æ–°å¢ï¼šäº§å“ä»£ç æ±‡æ€»å¡ç‰‡æ ·å¼
           ========================================= */
        .ios-code-summary-card {
            background: var(--ios-system-background);
            border-radius: var(--ios-radius-lg);
            padding: var(--ios-spacing-md);
            margin-bottom: var(--ios-spacing-md);
            box-shadow: var(--ios-shadow-sm);
            border: 0.5px solid var(--ios-separator);
        }

        .ios-code-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--ios-spacing-md);
        }

        .ios-code-summary-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--ios-label-primary);
        }

        .ios-code-summary-count {
            font-size: 15px;
            font-weight: 600;
            color: var(--ios-system-blue);
        }

        .ios-code-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: var(--ios-spacing-sm);
        }

        .ios-code-item {
            background: var(--ios-system-background-secondary);
            border-radius: var(--ios-radius-md);
            padding: var(--ios-spacing-sm);
            text-align: center;
            font-family: 'SF Mono', Menlo, monospace;
            font-weight: 600;
            color: var(--ios-label-primary);
            transition: all 0.2s ease;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .ios-code-item:hover {
            background: var(--ios-system-blue);
            color: white;
            transform: translateY(-1px);
            box-shadow: var(--ios-shadow-sm);
        }

        .ios-code-item:active {
            transform: scale(0.98);
        }

        /* æ¡Œé¢ç«¯ä»£ç æ±‡æ€»å¡ç‰‡ä¼˜åŒ– */
        @media (min-width: 768px) {
            .ios-code-summary-card {
                padding: var(--ios-spacing-lg);
                margin-bottom: var(--ios-spacing-lg);
            }
            
            .ios-code-summary-title {
                font-size: 20px;
            }
            
            .ios-code-summary-count {
                font-size: 18px;
            }
            
            .ios-code-summary-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: var(--ios-spacing-md);
            }
            
            .ios-code-item {
                padding: var(--ios-spacing-md);
                font-size: 16px;
            }
        }
        
        /* =========================================
           æ–°å¢ï¼šç¼“å­˜çŠ¶æ€æŒ‡ç¤ºå™¨
           ========================================= */
        .ios-cache-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--ios-system-green);
            border: 1px solid white;
            z-index: 1;
        }
        
        .ios-cache-indicator.offline {
            background: var(--ios-system-orange);
        }
        
        .ios-cache-indicator.missing {
            background: var(--ios-system-red);
        }
        
        /* =========================================
           æ–°å¢ï¼šåå°ç¼“å­˜çŠ¶æ€æŒ‡ç¤ºå™¨
           ========================================= */
        .ios-cache-status {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: var(--ios-system-blue);
            color: white;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: var(--ios-shadow-md);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            opacity: 0.9;
        }
        
        .ios-cache-status.hidden {
            transform: translateY(20px);
            opacity: 0;
            pointer-events: none;
        }
        
        .ios-cache-status .cache-spinner {
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <!-- ç¦»çº¿çŠ¶æ€æç¤ºæ¡ -->
    <div class="ios-offline-bar" id="offlineBar">
        ğŸ“¶ å½“å‰å¤„äºç¦»çº¿æ¨¡å¼ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ®ï¼ˆåªè¯»ï¼‰
    </div>

    <!-- åå°ç¼“å­˜çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="ios-cache-status hidden" id="cacheStatus">
        <div class="cache-spinner"></div>
        <span id="cacheStatusText">åå°ç¼“å­˜ä¸­...</span>
    </div>

    <!-- iOS å®¹å™¨ -->
    <div class="ios-container">
        <!-- é‡æ–°è®¾è®¡çš„é¡¶éƒ¨åŒºåŸŸ - ç§»é™¤çŠ¶æ€æ åä¼˜åŒ– -->
        <div class="ios-header">
            <div class="ios-brand"><span class="ios-brand-accent">YUDONG</span> TEXTILE</div>
            <div class="ios-nav-title" id="navTitle">æŠ¥ä»·å·¥ä½œå°</div>
        </div>

        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="ios-content">
            <!-- ä¸»å†…å®¹åŒºåŸŸ -->
            <div class="ios-main-content">
                <!-- æŸ¥è¯¢é¡µé¢ -->
                <div class="ios-tab-content active" id="tabQuery">
                    <!-- æœç´¢æ  -->
                    <div class="ios-search-bar">
                        <div class="ios-search-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                        </div>
                        <textarea class="ios-search-input ios-textarea" id="searchInput" placeholder="è¾“å…¥äº§å“ä»£ç ã€ä¾›åº”å•†æˆ–ä»·æ ¼/å…‹é‡åŒºé—´..." rows="3"></textarea>
                        <button class="ios-search-reset" id="searchReset" onclick="resetSearch()">Ã—</button>
                    </div>

                    <!-- ç»Ÿè®¡å¡ç‰‡ -->
                    <div class="ios-section">
                        <div class="ios-section-header">ç³»ç»Ÿæ¦‚è§ˆ</div>
                        <div class="ios-stats-grid">
                            <div class="ios-stat-item">
                                <div class="ios-stat-value" id="dataCount">0</div>
                                <div class="ios-stat-label">äº§å“æ€»æ•°</div>
                            </div>
                            <div class="ios-stat-item">
                                <div class="ios-stat-value" id="r2ImageCount">0</div>
                                <div class="ios-stat-label">äº‘ç«¯å›¾ç‰‡</div>
                            </div>
                            <div class="ios-stat-item">
                                <div class="ios-stat-value" id="missingImageCount">0</div>
                                <div class="ios-stat-label">ç¼ºå¤±å›¾ç‰‡</div>
                            </div>
                            <div class="ios-stat-item">
                                <div class="ios-stat-value" id="cachedImageCount">0</div>
                                <div class="ios-stat-label">ç¼“å­˜å›¾ç‰‡</div>
                            </div>
                            <div class="ios-stat-item">
                                <div class="ios-stat-value" id="cacheSize">0 <span class="cache-size-unit">MB</span></div>
                                <div class="ios-stat-label">ç¼“å­˜å¤§å°</div>
                            </div>
                            <div class="ios-stat-item">
                                <div class="ios-stat-value" id="networkStatus">åœ¨çº¿</div>
                                <div class="ios-stat-label">ç½‘ç»œçŠ¶æ€</div>
                            </div>
                        </div>
                    </div>

                    <!-- æœç´¢ç»“æœ -->
                    <div class="ios-section" id="resultsSection" style="display: none;">
                        <div class="ios-section-header">æœç´¢ç»“æœ</div>
                        
                        <!-- äº§å“ä»£ç æ±‡æ€»å¡ç‰‡ -->
                        <div id="codeSummaryCard" class="ios-code-summary-card" style="display: none;">
                            <div class="ios-code-summary-header">
                                <div class="ios-code-summary-title">åŒ¹é…äº§å“ä»£ç </div>
                                <div class="ios-code-summary-count" id="codeSummaryCount">0 ä¸ª</div>
                            </div>
                            <div class="ios-code-summary-grid" id="codeSummaryGrid"></div>
                        </div>
                        
                        <div id="resultsArea"></div>
                    </div>

                    <!-- å†å²è®°å½• -->
                    <div class="ios-section">
                        <div class="ios-section-header">æœ€è¿‘æœç´¢</div>
                        <div class="ios-card">
                            <div class="ios-card-content">
                                <div id="searchHistory" style="display: flex; flex-wrap: wrap; gap: var(--ios-spacing-sm);"></div>
                            </div>
                            <div class="ios-card-footer">
                                <button class="ios-button ios-button-secondary ios-button-full ios-button-small" onclick="clearSearchHistory()">
                                    æ¸…é™¤æœç´¢å†å²
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- PDFå¯¼å‡ºæŒ‰é’® -->
                    <div class="ios-section" id="pdfExportSection" style="display: none;">
                        <button class="ios-button ios-button-full" onclick="exportQuotePDF()">
                            ğŸ“„ å¯¼å‡ºæŠ¥ä»·PDF
                        </button>
                    </div>
                </div>

                <!-- ç®¡ç†é¡µé¢ -->
                <div class="ios-tab-content" id="tabManage">
                    <div class="ios-section">
                        <div class="ios-section-header">å¿«é€Ÿæ“ä½œ</div>
                        <div class="ios-card">
                            <div class="ios-card-content">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--ios-spacing-md);">
                                    <button class="ios-button ios-button-secondary ios-button-compact" id="addProductBtn" onclick="showAddProductModal()">
                                        <div style="text-align: center;">
                                            <div style="font-size: 20px; margin-bottom: 4px;">â•</div>
                                            <div style="font-size: 12px;">æ·»åŠ äº§å“</div>
                                        </div>
                                    </button>
                                    <button class="ios-button ios-button-secondary ios-button-compact" id="bulkUploadBtn" onclick="document.getElementById('bulkImageInput').click()">
                                        <div style="text-align: center;">
                                            <div style="font-size: 20px; margin-bottom: 4px;">ğŸ“¸</div>
                                            <div style="font-size: 12px;">æ‰¹é‡ä¸Šä¼ </div>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="ios-section">
                        <div class="ios-section-header">äº§å“åˆ—è¡¨</div>
                        
                        <!-- æœç´¢æ¡† -->
                        <div class="ios-search-bar mb-md">
                            <div class="ios-search-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="m21 21-4.35-4.35"></path>
                                </svg>
                            </div>
                            <input type="text" class="ios-search-input" id="manageSearchInput" placeholder="æœç´¢äº§å“..." oninput="filterManageProducts()">
                            <button class="ios-search-reset" id="manageSearchReset" onclick="resetManageSearch()">Ã—</button>
                        </div>

                        <!-- äº§å“åˆ—è¡¨ -->
                        <div id="manageProductList"></div>
                        
                        <!-- åŠ è½½æ›´å¤š -->
                        <div class="text-center mt-md" id="loadMoreContainer" style="display: none;">
                            <button class="ios-button ios-button-secondary ios-button-small" onclick="loadMoreProducts()">åŠ è½½æ›´å¤šäº§å“</button>
                        </div>
                    </div>
                </div>

                <!-- è®¾ç½®é¡µé¢ -->
                <div class="ios-tab-content" id="tabData">
                    <!-- äº‘å­˜å‚¨é…ç½® - ä¼˜åŒ–å¸ƒå±€ -->
                    <div class="ios-section">
                        <div class="ios-section-header">äº‘å­˜å‚¨é…ç½®</div>
                        <div class="ios-settings-section">
                            <div class="ios-settings-title">Cloudflare R2 é…ç½®</div>
                            <div class="ios-settings-grid">
                                <div class="ios-settings-row">
                                    <div class="ios-input-group">
                                        <label class="ios-input-label">Account ID</label>
                                        <input type="text" class="ios-input" id="r2AccountId" placeholder="Cloudflare Account ID">
                                    </div>
                                    <div class="ios-input-group">
                                        <label class="ios-input-label">Bucket åç§°</label>
                                        <input type="text" class="ios-input" id="r2Bucket" placeholder="å­˜å‚¨æ¡¶åç§°">
                                    </div>
                                </div>
                                <div class="ios-settings-row">
                                    <div class="ios-input-group">
                                        <label class="ios-input-label">Access Key</label>
                                        <input type="text" class="ios-input" id="r2AccessKey" placeholder="R2 Access Key">
                                    </div>
                                    <div class="ios-input-group">
                                        <label class="ios-input-label">Secret Key</label>
                                        <input type="password" class="ios-input" id="r2SecretKey" placeholder="R2 Secret Key">
                                    </div>
                                </div>
                                <div class="ios-input-group">
                                    <label class="ios-input-label">è‡ªå®šä¹‰åŸŸå</label>
                                    <input type="text" class="ios-input" id="r2CustomDomain" placeholder="https://img.yudong-textile.top" value="https://img.yudong-textile.top">
                                </div>
                                <div class="ios-settings-actions">
                                    <button class="ios-button ios-button-secondary" onclick="testR2Connection()">æµ‹è¯•è¿æ¥</button>
                                    <button class="ios-button" onclick="saveR2Config()">ä¿å­˜é…ç½®</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç¼“å­˜ç®¡ç† -->
                    <div class="ios-section">
                        <div class="ios-section-header">ç¼“å­˜ç®¡ç†</div>
                        <div class="ios-list">
                            <div class="ios-list-item" onclick="clearImageCache()">
                                <div class="ios-list-icon">ğŸ—‘ï¸</div>
                                <div class="ios-list-content">
                                    <div class="ios-list-title">æ¸…ç©ºå›¾ç‰‡ç¼“å­˜</div>
                                    <div class="ios-list-subtitle">åˆ é™¤æ‰€æœ‰ç¼“å­˜çš„å›¾ç‰‡æ•°æ®</div>
                                </div>
                            </div>
                            <div class="ios-list-item" onclick="checkCacheStatus()">
                                <div class="ios-list-icon">ğŸ“Š</div>
                                <div class="ios-list-content">
                                    <div class="ios-list-title">ç¼“å­˜çŠ¶æ€æ£€æŸ¥</div>
                                    <div class="ios-list-subtitle">æŸ¥çœ‹å½“å‰ç¼“å­˜çŠ¶æ€å’Œç»Ÿè®¡ä¿¡æ¯</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="ios-section">
                        <div class="ios-section-header">æ•°æ®ç®¡ç†</div>
                        <div class="ios-list">
                            <div class="ios-list-item" onclick="document.getElementById('localDbInput').click()">
                                <div class="ios-list-icon">ğŸ“‚</div>
                                <div class="ios-list-content">
                                    <div class="ios-list-title">æœ¬åœ°æ•°æ®å¯¼å…¥</div>
                                    <div class="ios-list-subtitle">ä»JSONæˆ–ZIPæ–‡ä»¶å¯¼å…¥</div>
                                </div>
                            </div>
                            <div class="ios-list-item" onclick="loadR2BackupFiles()">
                                <div class="ios-list-icon">â˜ï¸</div>
                                <div class="ios-list-content">
                                    <div class="ios-list-title">Cloudflare R2å¯¼å…¥</div>
                                    <div class="ios-list-subtitle">ä»äº‘ç«¯å¤‡ä»½æ¢å¤</div>
                                </div>
                            </div>
                            <div class="ios-list-item" onclick="exportAndUploadBackup()">
                                <div class="ios-list-icon">ğŸ’¾</div>
                                <div class="ios-list-content">
                                    <div class="ios-list-title">å¯¼å‡ºå®Œæ•´å¤‡ä»½</div>
                                    <div class="ios-list-subtitle">åŒ…å«æ•°æ®å’Œå›¾ç‰‡çš„ZIPæ–‡ä»¶</div>
                                </div>
                            </div>
                            <div class="ios-list-item" onclick="clearData()" style="color: var(--ios-system-red);">
                                <div class="ios-list-icon">âš ï¸</div>
                                <div class="ios-list-content">
                                    <div class="ios-list-title">æ¸…ç©ºæ‰€æœ‰æ•°æ®</div>
                                    <div class="ios-list-subtitle">æ°¸ä¹…åˆ é™¤æ‰€æœ‰äº§å“å’Œå›¾ç‰‡</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- R2å¤‡ä»½æ–‡ä»¶åˆ—è¡¨ -->
                    <div class="ios-section" id="r2BackupSection" style="display: none;">
                        <div class="ios-section-header">äº‘ç«¯å¤‡ä»½æ–‡ä»¶</div>
                        <div class="ios-card">
                            <div class="ios-card-content">
                                <div id="r2BackupList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¾§è¾¹æ  - æ¡Œé¢ç«¯æ˜¾ç¤º -->
            <div class="ios-sidebar">
                <div class="ios-sidebar-section">
                    <div class="ios-sidebar-section-header">å¿«é€Ÿæ“ä½œ</div>
                    <div class="ios-card">
                        <div class="ios-card-content">
                            <button class="ios-button ios-button-full mb-sm" id="sidebarAddProductBtn" onclick="showAddProductModal()">
                                â• æ·»åŠ æ–°äº§å“
                            </button>
                            <button class="ios-button ios-button-secondary ios-button-full mb-sm" id="sidebarBulkUploadBtn" onclick="document.getElementById('bulkImageInput').click()">
                                ğŸ“¸ æ‰¹é‡ä¸Šä¼ å›¾ç‰‡
                            </button>
                            <button class="ios-button ios-button-secondary ios-button-full" onclick="exportAndUploadBackup()">
                                ğŸ’¾ å¯¼å‡ºå®Œæ•´å¤‡ä»½
                            </button>
                        </div>
                    </div>
                </div>

                <div class="ios-sidebar-section">
                    <div class="ios-sidebar-section-header">ç³»ç»ŸçŠ¶æ€</div>
                    <div class="ios-card">
                        <div class="ios-card-content">
                            <div class="ios-stat-item" style="border: none; box-shadow: none; padding: 0; margin-bottom: var(--ios-spacing-md);">
                                <div class="ios-stat-value" id="sidebarDataCount">0</div>
                                <div class="ios-stat-label">äº§å“æ€»æ•°</div>
                            </div>
                            <div class="ios-stat-item" style="border: none; box-shadow: none; padding: 0; margin-bottom: var(--ios-spacing-md);">
                                <div class="ios-stat-value" id="sidebarR2ImageCount">0</div>
                                <div class="ios-stat-label">äº‘ç«¯å›¾ç‰‡</div>
                            </div>
                            <div class="ios-stat-item" style="border: none; box-shadow: none; padding: 0; margin-bottom: var(--ios-spacing-md);">
                                <div class="ios-stat-value" id="sidebarCachedImageCount">0</div>
                                <div class="ios-stat-label">ç¼“å­˜å›¾ç‰‡</div>
                            </div>
                            <div class="ios-stat-item" style="border: none; box-shadow: none; padding: 0;">
                                <div class="ios-stat-value" id="sidebarNetworkStatus">åœ¨çº¿</div>
                                <div class="ios-stat-label">ç½‘ç»œçŠ¶æ€</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="ios-sidebar-section">
                    <div class="ios-sidebar-section-header">æœ€è¿‘æœç´¢</div>
                    <div class="ios-card">
                        <div class="ios-card-content">
                            <div id="sidebarSearchHistory"></div>
                        </div>
                        <div class="ios-card-footer">
                            <button class="ios-button ios-button-secondary ios-button-full ios-button-small" onclick="clearSearchHistory()">
                                æ¸…é™¤æœç´¢å†å²
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨æ ‡ç­¾æ  -->
        <div class="ios-tab-bar">
            <div class="ios-tab-item active" data-tab="query">
                <div class="ios-tab-indicator"></div>
                <div class="ios-tab-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </div>
                <div class="ios-tab-label">æŸ¥è¯¢</div>
            </div>
            <div class="ios-tab-item" data-tab="manage">
                <div class="ios-tab-indicator"></div>
                <div class="ios-tab-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                        <path d="M3 9h18"></path>
                        <path d="M9 21V9"></path>
                    </svg>
                </div>
                <div class="ios-tab-label">ç®¡ç†</div>
            </div>
            <div class="ios-tab-item" data-tab="data">
                <div class="ios-tab-indicator"></div>
                <div class="ios-tab-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                    </svg>
                </div>
                <div class="ios-tab-label">è®¾ç½®</div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ äº§å“æ¨¡æ€æ¡† -->
    <div class="ios-modal" id="addProductModal">
        <div class="ios-modal-content">
            <div class="ios-modal-header">
                <button class="ios-nav-button" onclick="hideAddProductModal()">å–æ¶ˆ</button>
                <div class="ios-modal-title">æ·»åŠ äº§å“</div>
                <button class="ios-nav-button" id="saveProductBtn" onclick="addOrUpdateProduct()">ä¿å­˜</button>
            </div>
            <div class="ios-modal-body">
                <div class="ios-input-group">
                    <label class="ios-input-label">äº§å“ä»£ç </label>
                    <input type="text" class="ios-input" id="codeInput" placeholder="ä¾‹å¦‚ï¼šC6001">
                </div>
                <div class="ios-input-group">
                    <label class="ios-input-label">ä¾›åº”å•†</label>
                    <input type="text" class="ios-input" id="supplierInput" placeholder="ä¾›åº”å•†åç§°">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--ios-spacing-md);">
                    <div class="ios-input-group">
                        <label class="ios-input-label">ç ä»·</label>
                        <input type="text" class="ios-input" id="priceInput" placeholder="0.00">
                    </div>
                    <div class="ios-input-group">
                        <label class="ios-input-label">ç±³ä»·</label>
                        <input type="text" class="ios-input" id="priceAltInput" placeholder="0.00">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--ios-spacing-md);">
                    <div class="ios-input-group">
                        <label class="ios-input-label">é—¨å¹…</label>
                        <input type="text" class="ios-input" id="widthInput" placeholder="150cm">
                    </div>
                    <div class="ios-input-group">
                        <label class="ios-input-label">å…‹é‡</label>
                        <input type="text" class="ios-input" id="weightInput" placeholder="90g">
                    </div>
                </div>
                
                <div class="ios-input-group">
                    <label class="ios-input-label">æˆåˆ†</label>
                    <input type="text" class="ios-input" id="compositionInput" placeholder="100%é”¦çº¶">
                </div>
                
                <div class="ios-input-group">
                    <label class="ios-input-label">å¤‡æ³¨</label>
                    <input type="text" class="ios-input" id="notesInput" placeholder="é€‰å¡«ä¿¡æ¯">
                </div>
                
                <div class="ios-input-group">
                    <label class="ios-input-label">äº§å“å›¾ç‰‡</label>
                    <input type="file" class="ios-input" id="imageInput" accept="image/*">
                </div>
            </div>
        </div>
    </div>

    <!-- Toastæç¤º -->
    <div class="ios-toast" id="toast"></div>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="localDbInput" accept=".json,.zip" style="display: none;">
    <input type="file" id="bulkImageInput" multiple accept="image/*" style="display: none;">

    <!-- PhotoSwipe JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/5.4.4/umd/photoswipe.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/5.4.4/umd/photoswipe-lightbox.umd.min.js"></script>
    
    <script>
        // ============== å…¨å±€å˜é‡å’Œåˆå§‹åŒ– ==============
        let catalogData = {};
        let uploadedFiles = [];
        let searchResults = [];
        let fuzzyMatches = [];
        let rangeResults = [];
        let searchTimeout;
        let searchHistory = [];
        let editingCode = null;
        let manageSearchTerm = '';
        
        // Cloudflare R2é…ç½®
        let r2Config = JSON.parse(localStorage.getItem('r2-config') || '{}');
        let s3Client = null;
        
        // äº§å“ç®¡ç†åˆ†é¡µå˜é‡
        let manageCurrentPage = 1;
        let managePageSize = window.innerWidth <= 600 ? 10 : 20;
        let filteredManageProducts = [];
        let hasMoreProducts = false;

        // PhotoSwipeå®ä¾‹
        let photoSwipeLightbox = null;

        // ============== æ–°å¢ï¼šç¦»çº¿ç¼“å­˜åŠŸèƒ½ ==============
        let isOnline = true;
        let isReadOnlyMode = false;
        const CACHE_KEY = 'yudong-fabric-cache';
        const CACHE_EXPIRY = 24 * 60 * 60 * 1000; // 24å°æ—¶ç¼“å­˜æœ‰æ•ˆæœŸ

        // IndexedDBå›¾ç‰‡ç¼“å­˜
        const IMAGE_DB_NAME = 'YudongImageCache';
        const IMAGE_DB_VERSION = 2; // ç‰ˆæœ¬å‡çº§ï¼Œä¿®å¤ç¼“å­˜é—®é¢˜
        const IMAGE_STORE_NAME = 'images';
        let imageDB = null;
        let isImageDBSupported = 'indexedDB' in window;

        // ============== æ–°å¢ï¼šä¼˜åŒ–çš„ç¼“å­˜é”®ç®¡ç†ç³»ç»Ÿ ==============
        // ä½¿ç”¨äº§å“ä»£ç ä½œä¸ºä¸»ç¼“å­˜é”®ï¼Œé¿å…ç‰ˆæœ¬å·æ— é™å¢æ®–
        const CACHE_VERSION = 'v2'; // ç¼“å­˜ç‰ˆæœ¬æ ‡è¯†ï¼Œç”¨äºæ•°æ®è¿ç§»
        
        /**
         * ç”Ÿæˆä¼˜åŒ–çš„ç¼“å­˜é”® - ä½¿ç”¨äº§å“ä»£ç ä½œä¸ºä¸»é”®
         */
        function getOptimizedCacheKey(productCode) {
            return `product:${productCode}:${CACHE_VERSION}`;
        }
        
        /**
         * è·å–å›¾ç‰‡çš„åŸå§‹URLï¼ˆå»æ‰å‚æ•°ï¼‰
         */
        function getOriginalImageUrl(url) {
            if (!url) return url;
            // ç§»é™¤URLä¸­çš„å‚æ•°
            return url.split('?')[0];
        }

        /**
         * è·å–å¸¦æ—¶é—´æˆ³çš„å›¾ç‰‡URLï¼ˆç”¨äºé˜²æ­¢æµè§ˆå™¨ç¼“å­˜ï¼‰
         */
        function getTimestampedImageUrl(url) {
            if (!url) return url;
            // å¦‚æœå·²ç»æ˜¯é»˜è®¤å›¾ç‰‡æˆ–data URLï¼Œç›´æ¥è¿”å›
            if (url.startsWith('data:') || url.includes('svg+xml')) {
                return url;
            }
            // ä¸ºR2å›¾ç‰‡æ·»åŠ æ—¶é—´æˆ³å‚æ•°
            const baseUrl = url.split('?')[0];
            return `${baseUrl}?t=${Date.now()}`;
        }

        /**
         * åˆå§‹åŒ–IndexedDB - å‡çº§ç‰ˆæœ¬ä¿®å¤ç¼“å­˜é—®é¢˜
         */
        function initImageDB() {
            return new Promise((resolve, reject) => {
                if (!isImageDBSupported) {
                    console.warn('IndexedDB is not supported in this browser');
                    resolve(false);
                    return;
                }
                
                const request = indexedDB.open(IMAGE_DB_NAME, IMAGE_DB_VERSION);
                
                request.onerror = function(event) {
                    console.error('IndexedDB initialization failed:', event.target.error);
                    reject(event.target.error);
                };
                
                request.onsuccess = function(event) {
                    imageDB = event.target.result;
                    console.log('IndexedDB initialized successfully');
                    
                    // åˆå§‹åŒ–åæ¸…ç†æ—§çš„ç¼“å­˜æ•°æ®
                    setTimeout(() => {
                        cleanupOldCacheData();
                    }, 1000);
                    
                    resolve(true);
                };
                
                request.onupgradeneeded = function(event) {
                    const db = event.target.result;
                    const oldVersion = event.oldVersion;
                    
                    console.log(`IndexedDB upgrading from version ${oldVersion} to ${IMAGE_DB_VERSION}`);
                    
                    // åˆ é™¤æ—§çš„å­˜å‚¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰å¹¶åˆ›å»ºæ–°çš„
                    if (db.objectStoreNames.contains(IMAGE_STORE_NAME)) {
                        db.deleteObjectStore(IMAGE_STORE_NAME);
                    }
                    
                    const store = db.createObjectStore(IMAGE_STORE_NAME, { keyPath: 'key' });
                    store.createIndex('timestamp', 'timestamp', { unique: false });
                    store.createIndex('productCode', 'productCode', { unique: false });
                    console.log('Image store created with optimized structure');
                };
            });
        }

        /**
         * æ¸…ç†æ—§çš„ç¼“å­˜æ•°æ®
         */
        async function cleanupOldCacheData() {
            if (!imageDB || !isImageDBSupported) return;
            
            try {
                // è·å–æ‰€æœ‰ç¼“å­˜é”®
                const allKeys = await new Promise((resolve, reject) => {
                    const transaction = imageDB.transaction([IMAGE_STORE_NAME], 'readonly');
                    const store = transaction.objectStore(IMAGE_STORE_NAME);
                    const request = store.getAllKeys();
                    
                    request.onsuccess = function() {
                        resolve(request.result);
                    };
                    
                    request.onerror = function(event) {
                        reject(event.target.error);
                    };
                });
                
                // åˆ é™¤æ‰€æœ‰æ—§ç‰ˆæœ¬çš„ç¼“å­˜ï¼ˆä¸ä»¥product:å¼€å¤´çš„é”®ï¼‰
                const deletePromises = [];
                for (const key of allKeys) {
                    if (!key.startsWith('product:')) {
                        deletePromises.push(deleteImageFromCache(key));
                    }
                }
                
                if (deletePromises.length > 0) {
                    await Promise.all(deletePromises);
                    console.log(`Cleaned up ${deletePromises.length} old cache entries`);
                }
                
                // æ¸…ç†è¿‡æœŸç¼“å­˜ï¼ˆè¶…è¿‡7å¤©ï¼‰
                await cleanupExpiredCache();
                
            } catch (error) {
                console.error('Failed to cleanup old cache data:', error);
            }
        }

        /**
         * æ¸…ç†è¿‡æœŸç¼“å­˜ï¼ˆè¶…è¿‡7å¤©ï¼‰
         */
        async function cleanupExpiredCache() {
            if (!imageDB || !isImageDBSupported) return;
            
            try {
                const maxAge = 7 * 24 * 60 * 60 * 1000; // 7å¤©
                const cutoffTime = Date.now() - maxAge;
                
                const transaction = imageDB.transaction([IMAGE_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(IMAGE_STORE_NAME);
                const index = store.index('timestamp');
                
                const range = IDBKeyRange.upperBound(cutoffTime);
                const request = index.openCursor(range);
                
                let deletedCount = 0;
                
                return new Promise((resolve, reject) => {
                    request.onsuccess = function(event) {
                        const cursor = event.target.result;
                        if (cursor) {
                            cursor.delete();
                            deletedCount++;
                            cursor.continue();
                        } else {
                            if (deletedCount > 0) {
                                console.log(`Cleaned up ${deletedCount} expired cache entries`);
                            }
                            resolve(deletedCount);
                        }
                    };
                    
                    request.onerror = function(event) {
                        reject(event.target.error);
                    };
                });
            } catch (error) {
                console.error('Failed to cleanup expired cache:', error);
                return 0;
            }
        }

        /**
         * ä¿å­˜å›¾ç‰‡åˆ°ç¼“å­˜ - ä½¿ç”¨ä¼˜åŒ–çš„ç¼“å­˜é”®
         */
        async function saveImageToCache(productCode, blob) {
            if (!imageDB || !isImageDBSupported) return false;
            
            return new Promise((resolve, reject) => {
                const transaction = imageDB.transaction([IMAGE_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(IMAGE_STORE_NAME);
                
                const item = {
                    key: getOptimizedCacheKey(productCode),
                    productCode: productCode,
                    blob: blob,
                    timestamp: Date.now()
                };
                
                const request = store.put(item);
                
                request.onsuccess = function() {
                    console.log('Image saved to cache:', productCode);
                    resolve(true);
                };
                
                request.onerror = function(event) {
                    console.error('Failed to save image to cache:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        /**
         * ä»ç¼“å­˜è·å–å›¾ç‰‡ - ä½¿ç”¨ä¼˜åŒ–çš„ç¼“å­˜é”®
         */
        async function getImageFromCache(productCode) {
            if (!imageDB || !isImageDBSupported) return null;
            
            return new Promise((resolve, reject) => {
                const transaction = imageDB.transaction([IMAGE_STORE_NAME], 'readonly');
                const store = transaction.objectStore(IMAGE_STORE_NAME);
                
                const request = store.get(getOptimizedCacheKey(productCode));
                
                request.onsuccess = function() {
                    if (request.result) {
                        // æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸï¼ˆ7å¤©ï¼‰
                        const cacheAge = Date.now() - request.result.timestamp;
                        const maxAge = 7 * 24 * 60 * 60 * 1000; // 7å¤©
                        
                        if (cacheAge > maxAge) {
                            // ç¼“å­˜è¿‡æœŸï¼Œåˆ é™¤å¹¶è¿”å›null
                            deleteImageFromCacheByKey(request.result.key);
                            resolve(null);
                        } else {
                            console.log('Image loaded from cache:', productCode);
                            resolve(request.result.blob);
                        }
                    } else {
                        resolve(null);
                    }
                };
                
                request.onerror = function(event) {
                    console.error('Failed to get image from cache:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        /**
         * ä»ç¼“å­˜åˆ é™¤å›¾ç‰‡ - ä½¿ç”¨ä¼˜åŒ–çš„ç¼“å­˜é”®
         */
        async function deleteImageFromCache(productCode) {
            return deleteImageFromCacheByKey(getOptimizedCacheKey(productCode));
        }

        /**
         * é€šè¿‡é”®åˆ é™¤ç¼“å­˜
         */
        async function deleteImageFromCacheByKey(key) {
            if (!imageDB || !isImageDBSupported) return false;
            
            return new Promise((resolve, reject) => {
                const transaction = imageDB.transaction([IMAGE_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(IMAGE_STORE_NAME);
                
                const request = store.delete(key);
                
                request.onsuccess = function() {
                    console.log('Image deleted from cache:', key);
                    resolve(true);
                };
                
                request.onerror = function(event) {
                    console.error('Failed to delete image from cache:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        /**
         * æ¸…é™¤äº§å“å›¾ç‰‡çš„æ‰€æœ‰ç¼“å­˜ç‰ˆæœ¬
         */
        async function clearProductImageCache(productCode) {
            if (!imageDB || !isImageDBSupported) return false;
            
            try {
                // ä½¿ç”¨ä¼˜åŒ–çš„ç¼“å­˜é”®ï¼Œç›´æ¥åˆ é™¤å¯¹åº”çš„ç¼“å­˜
                await deleteImageFromCache(productCode);
                console.log(`Cleared cached image for product ${productCode}`);
                return true;
            } catch (error) {
                console.error('Failed to clear product image cache:', error);
                return false;
            }
        }

        /**
         * æ¸…ç©ºå›¾ç‰‡ç¼“å­˜
         */
        async function clearImageCache() {
            if (!imageDB || !isImageDBSupported) return false;
            
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡ç¼“å­˜å—ï¼Ÿè¿™ä¸ä¼šåˆ é™¤äº‘ç«¯å›¾ç‰‡ã€‚')) {
                return;
            }
            
            return new Promise((resolve, reject) => {
                const transaction = imageDB.transaction([IMAGE_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(IMAGE_STORE_NAME);
                
                const request = store.clear();
                
                request.onsuccess = function() {
                    console.log('Image cache cleared');
                    showToast('å›¾ç‰‡ç¼“å­˜å·²æ¸…ç©º');
                    updateStats();
                    resolve(true);
                };
                
                request.onerror = function(event) {
                    console.error('Failed to clear image cache:', event.target.error);
                    showToast('æ¸…ç©ºç¼“å­˜å¤±è´¥');
                    reject(event.target.error);
                };
            });
        }

        /**
         * è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
         */
        async function getCacheStats() {
            if (!imageDB || !isImageDBSupported) {
                return { count: 0, size: 0 };
            }
            
            return new Promise((resolve, reject) => {
                const transaction = imageDB.transaction([IMAGE_STORE_NAME], 'readonly');
                const store = transaction.objectStore(IMAGE_STORE_NAME);
                const request = store.getAll();
                
                request.onsuccess = function() {
                    const items = request.result;
                    let totalSize = 0;
                    
                    items.forEach(item => {
                        if (item.blob && item.blob.size) {
                            totalSize += item.blob.size;
                        }
                    });
                    
                    resolve({
                        count: items.length,
                        size: totalSize
                    });
                };
                
                request.onerror = function(event) {
                    console.error('Failed to get cache stats:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        /**
         * æ™ºèƒ½å›¾ç‰‡åŠ è½½å‡½æ•° - ä½¿ç”¨ä¼˜åŒ–çš„ç¼“å­˜ç³»ç»Ÿ
         */
        async function loadImageWithCache(productCode, imageUrl, imgElement) {
            if (!imageUrl) {
                // æ²¡æœ‰å›¾ç‰‡URLï¼Œæ˜¾ç¤ºé»˜è®¤å›¾ç‰‡
                imgElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2YwZjBmMCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7lm77niYc8L3RleHQ+PC9zdmc+';
                return;
            }
            
            // é¦–å…ˆå°è¯•ä»ç¼“å­˜åŠ è½½
            const cachedBlob = await getImageFromCache(productCode);
            if (cachedBlob) {
                const cachedUrl = URL.createObjectURL(cachedBlob);
                imgElement.src = cachedUrl;
                imgElement.dataset.cached = 'true';
                
                // ä¸ºPhotoSwipeæ›´æ–°data-pswp-srcå±æ€§ï¼Œç¡®ä¿ç¦»çº¿æ¨¡å¼ä¸‹ä¹Ÿèƒ½æŸ¥çœ‹å¤§å›¾
                const parentLink = imgElement.closest('a[data-pswp-src]');
                if (parentLink) {
                    parentLink.href = cachedUrl;
                    parentLink.dataset.pswpSrc = cachedUrl;
                }
                
                // æ·»åŠ ç¼“å­˜æŒ‡ç¤ºå™¨
                if (!imgElement.parentElement.querySelector('.ios-cache-indicator')) {
                    const indicator = document.createElement('div');
                    indicator.className = 'ios-cache-indicator';
                    indicator.title = 'å·²ç¼“å­˜';
                    imgElement.parentElement.style.position = 'relative';
                    imgElement.parentElement.appendChild(indicator);
                }
                
                return;
            }
            
            // ç¼“å­˜ä¸­æ²¡æœ‰ï¼Œæ ¹æ®ç½‘ç»œçŠ¶æ€å†³å®š
            if (isOnline && !isReadOnlyMode) {
                // åœ¨çº¿çŠ¶æ€ï¼Œä»ç½‘ç»œåŠ è½½å¹¶ç¼“å­˜
                try {
                    // ä½¿ç”¨å¸¦æ—¶é—´æˆ³çš„URLåŠ è½½ï¼Œé¿å…æµè§ˆå™¨ç¼“å­˜
                    const timestampedUrl = getTimestampedImageUrl(imageUrl);
                    const response = await fetch(timestampedUrl);
                    if (response.ok) {
                        const blob = await response.blob();
                        
                        // ä¿å­˜åˆ°ç¼“å­˜ï¼ˆä½¿ç”¨ä¼˜åŒ–çš„ç¼“å­˜é”®ï¼‰
                        await saveImageToCache(productCode, blob);
                        
                        const blobUrl = URL.createObjectURL(blob);
                        imgElement.src = blobUrl;
                        imgElement.dataset.cached = 'true';
                        
                        // ä¸ºPhotoSwipeæ›´æ–°data-pswp-srcå±æ€§
                        const parentLink = imgElement.closest('a[data-pswp-src]');
                        if (parentLink) {
                            parentLink.href = blobUrl;
                            parentLink.dataset.pswpSrc = blobUrl;
                        }
                        
                        // æ·»åŠ ç¼“å­˜æŒ‡ç¤ºå™¨
                        if (!imgElement.parentElement.querySelector('.ios-cache-indicator')) {
                            const indicator = document.createElement('div');
                            indicator.className = 'ios-cache-indicator';
                            indicator.title = 'å·²ç¼“å­˜';
                            imgElement.parentElement.style.position = 'relative';
                            imgElement.parentElement.appendChild(indicator);
                        }
                    } else {
                        throw new Error('Network response was not ok');
                    }
                } catch (error) {
                    console.error('Failed to load image from network:', error);
                    // ç½‘ç»œåŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºé»˜è®¤å›¾ç‰‡
                    imgElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2YwZjBmMCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7lm77niYc8L3RleHQ+PC9zdmc+';
                    imgElement.dataset.cached = 'false';
                    
                    // æ·»åŠ ç¦»çº¿æŒ‡ç¤ºå™¨
                    if (!imgElement.parentElement.querySelector('.ios-cache-indicator')) {
                        const indicator = document.createElement('div');
                        indicator.className = 'ios-cache-indicator offline';
                        indicator.title = 'ç¦»çº¿æ¨¡å¼';
                        imgElement.parentElement.style.position = 'relative';
                        imgElement.parentElement.appendChild(indicator);
                    }
                }
            } else {
                // ç¦»çº¿çŠ¶æ€ï¼Œæ˜¾ç¤ºé»˜è®¤å›¾ç‰‡
                imgElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2YwZjBmMCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7lm77niYc8L3RleHQ+PC9zdmc+';
                imgElement.dataset.cached = 'false';
                
                // æ·»åŠ ç¦»çº¿æŒ‡ç¤ºå™¨
                if (!imgElement.parentElement.querySelector('.ios-cache-indicator')) {
                    const indicator = document.createElement('div');
                    indicator.className = 'ios-cache-indicator offline';
                    indicator.title = 'ç¦»çº¿æ¨¡å¼';
                    imgElement.parentElement.style.position = 'relative';
                    imgElement.parentElement.appendChild(indicator);
                }
            }
        }

        /**
         * æ£€æŸ¥ç¼“å­˜çŠ¶æ€
         */
        async function checkCacheStatus() {
            const stats = await getCacheStats();
            const cacheSizeMB = (stats.size / (1024 * 1024)).toFixed(2);
            
            showToast(`ç¼“å­˜çŠ¶æ€: ${stats.count} å¼ å›¾ç‰‡, ${cacheSizeMB} MB`, 4000);
        }

        // ============== æ–°å¢ï¼šä¼˜åŒ–çš„åå°è‡ªåŠ¨ç¼“å­˜ç³»ç»Ÿ ==============
        let backgroundCacheManager = {
            isRunning: false,
            queue: [],
            processed: 0,
            total: 0,
            concurrency: 3, // åŒæ—¶ä¸‹è½½çš„å›¾ç‰‡æ•°é‡
            activeDownloads: 0,
            userActivity: false,
            lastActivityTime: Date.now(),
            cacheProgress: localStorage.getItem('background-cache-progress') || '{}',
            
            // åˆå§‹åŒ–åå°ç¼“å­˜
            init() {
                // åŠ è½½ç¼“å­˜è¿›åº¦
                try {
                    this.cacheProgress = JSON.parse(localStorage.getItem('background-cache-progress') || '{}');
                } catch (e) {
                    this.cacheProgress = {};
                }
                
                // ç›‘å¬ç”¨æˆ·æ´»åŠ¨
                this.setupActivityListeners();
                
                // å¯åŠ¨åå°ç¼“å­˜ï¼ˆå»¶è¿Ÿå¯åŠ¨ï¼Œè®©UIå…ˆåŠ è½½ï¼‰
                setTimeout(() => {
                    this.start();
                }, 3000);
            },
            
            // è®¾ç½®ç”¨æˆ·æ´»åŠ¨ç›‘å¬
            setupActivityListeners() {
                const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];
                activityEvents.forEach(event => {
                    document.addEventListener(event, () => {
                        this.userActivity = true;
                        this.lastActivityTime = Date.now();
                        
                        // ç”¨æˆ·æ´»åŠ¨æ—¶é™ä½ç¼“å­˜ä¼˜å…ˆçº§
                        if (this.isRunning && this.activeDownloads > 1) {
                            this.concurrency = Math.max(1, this.concurrency - 1);
                        }
                    }, { passive: true });
                });
                
                // å®šæœŸæ£€æŸ¥ç”¨æˆ·æ´»åŠ¨çŠ¶æ€
                setInterval(() => {
                    const inactiveTime = Date.now() - this.lastActivityTime;
                    if (inactiveTime > 10000) { // 10ç§’æ— æ´»åŠ¨
                        this.userActivity = false;
                        // æ¢å¤æ­£å¸¸çš„å¹¶å‘æ•°
                        this.concurrency = 3;
                    }
                }, 5000);
            },
            
            // å¼€å§‹åå°ç¼“å­˜
            async start() {
                if (this.isRunning || !isOnline || isReadOnlyMode) {
                    return;
                }
                
                // è·å–éœ€è¦ç¼“å­˜çš„å›¾ç‰‡
                const productsWithImages = Object.values(catalogData).filter(product => 
                    product.image && (product.image.includes(r2Config.customDomain) || product.image.includes('.r2.cloudflarestorage.com'))
                );
                
                if (productsWithImages.length === 0) {
                    return;
                }
                
                // æ„å»ºç¼“å­˜é˜Ÿåˆ—ï¼Œæ’é™¤å·²ç¼“å­˜çš„å›¾ç‰‡
                this.queue = [];
                for (const product of productsWithImages) {
                    // ä½¿ç”¨ä¼˜åŒ–çš„ç¼“å­˜é”®æ£€æŸ¥ç¼“å­˜
                    const isCached = await getImageFromCache(product.code);
                    if (!isCached) {
                        this.queue.push({
                            code: product.code,
                            url: product.image
                        });
                    }
                }
                
                this.total = this.queue.length;
                this.processed = 0;
                this.isRunning = true;
                
                if (this.total === 0) {
                    this.isRunning = false;
                    return;
                }
                
                // æ˜¾ç¤ºç¼“å­˜çŠ¶æ€æŒ‡ç¤ºå™¨
                this.showStatusIndicator();
                
                // å¼€å§‹å¤„ç†é˜Ÿåˆ—
                this.processQueue();
            },
            
            // å¤„ç†ç¼“å­˜é˜Ÿåˆ—
            async processQueue() {
                while (this.queue.length > 0 && this.isRunning) {
                    // æ£€æŸ¥å¹¶å‘é™åˆ¶
                    if (this.activeDownloads >= this.concurrency) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        continue;
                    }
                    
                    // æ£€æŸ¥ç”¨æˆ·æ´»åŠ¨çŠ¶æ€ï¼Œè°ƒæ•´ä¼˜å…ˆçº§
                    if (this.userActivity && this.activeDownloads > 0) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                        continue;
                    }
                    
                    const item = this.queue.shift();
                    if (!item) continue;
                    
                    this.activeDownloads++;
                    this.downloadImage(item)
                        .finally(() => {
                            this.activeDownloads--;
                            this.processed++;
                            this.updateStatusIndicator();
                            this.saveProgress();
                        });
                    
                    // æ·»åŠ å°å»¶è¿Ÿä»¥é¿å…è¿‡äºé¢‘ç¹çš„è¯·æ±‚
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                
                // é˜Ÿåˆ—å¤„ç†å®Œæˆ
                if (this.queue.length === 0) {
                    this.isRunning = false;
                    setTimeout(() => {
                        this.hideStatusIndicator();
                        if (this.processed > 0) {
                            console.log(`åå°ç¼“å­˜å®Œæˆï¼å·²ç¼“å­˜ ${this.processed} å¼ å›¾ç‰‡`);
                        }
                    }, 2000);
                }
            },
            
            // ä¸‹è½½å•å¼ å›¾ç‰‡
            async downloadImage(item) {
                try {
                    // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨ç¼“å­˜ä¸­ï¼ˆé˜²æ­¢é‡å¤ä¸‹è½½ï¼‰
                    const cachedBlob = await getImageFromCache(item.code);
                    if (cachedBlob) {
                        return;
                    }
                    
                    // ä»ç½‘ç»œåŠ è½½ï¼ˆä½¿ç”¨å¸¦æ—¶é—´æˆ³çš„URLé˜²æ­¢æµè§ˆå™¨ç¼“å­˜ï¼‰
                    const timestampedUrl = getTimestampedImageUrl(item.url);
                    const response = await fetch(timestampedUrl);
                    if (response.ok) {
                        const blob = await response.blob();
                        // ä½¿ç”¨ä¼˜åŒ–çš„ç¼“å­˜é”®ä¿å­˜åˆ°ç¼“å­˜
                        await saveImageToCache(item.code, blob);
                        
                        // æ›´æ–°äº§å“å›¾ç‰‡çŠ¶æ€
                        if (catalogData[item.code]) {
                            catalogData[item.code].cached = true;
                        }
                    }
                } catch (error) {
                    console.error(`åå°ç¼“å­˜å›¾ç‰‡å¤±è´¥ ${item.code}:`, error);
                }
            },
            
            // æ˜¾ç¤ºçŠ¶æ€æŒ‡ç¤ºå™¨
            showStatusIndicator() {
                const statusElement = document.getElementById('cacheStatus');
                const statusText = document.getElementById('cacheStatusText');
                
                if (statusElement && statusText) {
                    statusText.textContent = `åå°ç¼“å­˜ä¸­... (${this.processed}/${this.total})`;
                    statusElement.classList.remove('hidden');
                }
            },
            
            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            updateStatusIndicator() {
                const statusText = document.getElementById('cacheStatusText');
                if (statusText) {
                    statusText.textContent = `åå°ç¼“å­˜ä¸­... (${this.processed}/${this.total})`;
                    
                    // ç¼“å­˜å®Œæˆæ—¶æ˜¾ç¤ºå®ŒæˆçŠ¶æ€
                    if (this.processed >= this.total) {
                        statusText.textContent = `ç¼“å­˜å®Œæˆ (${this.processed}/${this.total})`;
                    }
                }
            },
            
            // éšè—çŠ¶æ€æŒ‡ç¤ºå™¨
            hideStatusIndicator() {
                const statusElement = document.getElementById('cacheStatus');
                if (statusElement) {
                    setTimeout(() => {
                        statusElement.classList.add('hidden');
                    }, 3000);
                }
            },
            
            // ä¿å­˜ç¼“å­˜è¿›åº¦
            saveProgress() {
                this.cacheProgress = {
                    processed: this.processed,
                    total: this.total,
                    timestamp: Date.now()
                };
                localStorage.setItem('background-cache-progress', JSON.stringify(this.cacheProgress));
            },
            
            // åœæ­¢åå°ç¼“å­˜
            stop() {
                this.isRunning = false;
                this.hideStatusIndicator();
            }
        };

        // ============== ç½‘ç»œçŠ¶æ€ç®¡ç† ==============
        /**
         * æ£€æµ‹ç½‘ç»œçŠ¶æ€
         */
        function checkNetworkStatus() {
            const wasOnline = isOnline;
            isOnline = navigator.onLine;
            
            // æ›´æ–°UIæ˜¾ç¤º
            document.getElementById('networkStatus').textContent = isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿';
            document.getElementById('networkStatus').style.color = isOnline ? 'var(--ios-system-green)' : 'var(--ios-system-orange)';
            
            if (!isMobileDevice()) {
                document.getElementById('sidebarNetworkStatus').textContent = isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿';
                document.getElementById('sidebarNetworkStatus').style.color = isOnline ? 'var(--ios-system-green)' : 'var(--ios-system-orange)';
            }
            
            if (wasOnline && !isOnline) {
                // ä»åœ¨çº¿åˆ‡æ¢åˆ°ç¦»çº¿
                console.log('ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œåˆ‡æ¢åˆ°ç¦»çº¿æ¨¡å¼');
                enableOfflineMode();
            } else if (!wasOnline && isOnline) {
                // ä»ç¦»çº¿åˆ‡æ¢åˆ°åœ¨çº¿
                console.log('ç½‘ç»œè¿æ¥å·²æ¢å¤ï¼Œåˆ‡æ¢åˆ°åœ¨çº¿æ¨¡å¼');
                disableOfflineMode();
            }
            
            // ç½‘ç»œæ¢å¤æ—¶é‡æ–°å¯åŠ¨åå°ç¼“å­˜
            if (!wasOnline && isOnline && !backgroundCacheManager.isRunning) {
                setTimeout(() => {
                    backgroundCacheManager.start();
                }, 5000);
            }
            
            return isOnline;
        }

        /**
         * å¯ç”¨ç¦»çº¿æ¨¡å¼
         */
        function enableOfflineMode() {
            isReadOnlyMode = true;
            
            // æ˜¾ç¤ºç¦»çº¿æç¤ºæ¡
            document.getElementById('offlineBar').classList.add('show');
            
            // ç¦ç”¨æ‰€æœ‰ä¿®æ”¹æ“ä½œ
            disableModificationButtons();
            
            // åœæ­¢åå°ç¼“å­˜
            backgroundCacheManager.stop();
            
            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            showToast('å·²åˆ‡æ¢åˆ°ç¦»çº¿æ¨¡å¼ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ®ï¼ˆåªè¯»ï¼‰', 3000);
            
            // é‡æ–°åˆå§‹åŒ–PhotoSwipeä»¥æ”¯æŒç¦»çº¿æŸ¥çœ‹
            setTimeout(initPhotoSwipe, 500);
        }

        /**
         * ç¦ç”¨ç¦»çº¿æ¨¡å¼
         */
        function disableOfflineMode() {
            isReadOnlyMode = false;
            
            // éšè—ç¦»çº¿æç¤ºæ¡
            document.getElementById('offlineBar').classList.remove('show');
            
            // å¯ç”¨æ‰€æœ‰ä¿®æ”¹æ“ä½œ
            enableModificationButtons();
            
            // é‡æ–°ä»R2åŠ è½½æ•°æ®
            loadDatabaseFromR2().then(success => {
                if (success) {
                    showToast('ç½‘ç»œå·²æ¢å¤ï¼Œæ•°æ®å·²åŒæ­¥', 2000);
                    updateStats();
                    renderManageProducts();
                    
                    // é‡æ–°å¯åŠ¨åå°ç¼“å­˜
                    setTimeout(() => {
                        backgroundCacheManager.start();
                    }, 3000);
                    
                    // é‡æ–°åˆå§‹åŒ–PhotoSwipe
                    setTimeout(initPhotoSwipe, 500);
                }
            });
        }

        /**
         * ç¦ç”¨æ‰€æœ‰ä¿®æ”¹æŒ‰é’®
         */
        function disableModificationButtons() {
            const modificationButtons = [
                'addProductBtn', 'bulkUploadBtn', 'sidebarAddProductBtn', 
                'sidebarBulkUploadBtn', 'saveProductBtn'
            ];
            
            modificationButtons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.classList.add('offline-disabled');
                    btn.disabled = true;
                }
            });
            
            // ç¦ç”¨ç®¡ç†é¡µé¢ä¸­çš„ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®
            document.querySelectorAll('.ios-product-actions .ios-button').forEach(btn => {
                btn.classList.add('offline-disabled');
                btn.disabled = true;
            });
        }

        /**
         * å¯ç”¨æ‰€æœ‰ä¿®æ”¹æŒ‰é’®
         */
        function enableModificationButtons() {
            const modificationButtons = [
                'addProductBtn', 'bulkUploadBtn', 'sidebarAddProductBtn', 
                'sidebarBulkUploadBtn', 'saveProductBtn'
            ];
            
            modificationButtons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.classList.remove('offline-disabled');
                    btn.disabled = false;
                }
            });
            
            // å¯ç”¨ç®¡ç†é¡µé¢ä¸­çš„ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®
            document.querySelectorAll('.ios-product-actions .ios-button').forEach(btn => {
                btn.classList.remove('offline-disabled');
                btn.disabled = false;
            });
        }

        /**
         * ä¿å­˜æ•°æ®åˆ°æœ¬åœ°ç¼“å­˜
         */
        function saveToLocalCache() {
            const cacheData = {
                catalogData: catalogData,
                searchHistory: searchHistory,
                uploadedFiles: uploadedFiles,
                cachedAt: new Date().toISOString(),
                version: '4.0-r2-offline-optimized'
            };
            
            localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
            console.log('æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜');
        }

        /**
         * ä»æœ¬åœ°ç¼“å­˜åŠ è½½æ•°æ®
         */
        function loadFromLocalCache() {
            try {
                const cachedData = localStorage.getItem(CACHE_KEY);
                if (!cachedData) {
                    console.log('æœ¬åœ°ç¼“å­˜ä¸å­˜åœ¨');
                    return false;
                }
                
                const data = JSON.parse(cachedData);
                
                // æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸ
                const cacheTime = new Date(data.cachedAt).getTime();
                const now = new Date().getTime();
                if (now - cacheTime > CACHE_EXPIRY) {
                    console.log('æœ¬åœ°ç¼“å­˜å·²è¿‡æœŸ');
                    localStorage.removeItem(CACHE_KEY);
                    return false;
                }
                
                catalogData = data.catalogData || {};
                searchHistory = data.searchHistory || [];
                uploadedFiles = data.uploadedFiles || [];
                
                console.log('ä»æœ¬åœ°ç¼“å­˜åŠ è½½æ•°æ®æˆåŠŸï¼Œäº§å“æ•°é‡:', Object.keys(catalogData).length);
                return true;
            } catch (error) {
                console.error('åŠ è½½æœ¬åœ°ç¼“å­˜å¤±è´¥:', error);
                return false;
            }
        }

        /**
         * æ¸…é™¤è¿‡æœŸçš„æœ¬åœ°ç¼“å­˜
         */
        function clearExpiredCache() {
            try {
                const cachedData = localStorage.getItem(CACHE_KEY);
                if (!cachedData) return;
                
                const data = JSON.parse(cachedData);
                const cacheTime = new Date(data.cachedAt).getTime();
                const now = new Date().getTime();
                
                if (now - cacheTime > CACHE_EXPIRY) {
                    localStorage.removeItem(CACHE_KEY);
                    console.log('å·²æ¸…é™¤è¿‡æœŸçš„æœ¬åœ°ç¼“å­˜');
                }
            } catch (error) {
                console.error('æ¸…é™¤ç¼“å­˜å¤±è´¥:', error);
            }
        }

        // ============== æ ¸å¿ƒæ”¹é€ ï¼šçº¯ç²¹çš„R2äº‘ç«¯å­˜å‚¨æ–¹æ¡ˆ ==============

        /**
         * ä»R2åŠ è½½å®Œæ•´æ•°æ®åº“
         */
        async function loadDatabaseFromR2() {
            if (!s3Client) {
                console.warn('R2å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                return false;
            }
            
            try {
                console.log('ä»R2åŠ è½½æ•°æ®åº“...');
                const data = await s3Client.getObject({
                    Bucket: r2Config.bucket,
                    Key: 'yudong-cloud/database.json'
                }).promise();
                
                const database = JSON.parse(data.Body.toString());
                catalogData = database.catalogData || {};
                searchHistory = database.searchHistory || [];
                uploadedFiles = database.uploadedFiles || {};
                
                console.log('æ•°æ®åº“åŠ è½½æˆåŠŸï¼Œäº§å“æ•°é‡:', Object.keys(catalogData).length);
                
                // æˆåŠŸåŠ è½½åä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
                saveToLocalCache();
                
                return true;
            } catch (error) {
                if (error.code === 'NoSuchKey') {
                    console.log('R2ä¸Šæœªæ‰¾åˆ°æ•°æ®åº“ï¼Œåˆå§‹åŒ–ç©ºæ•°æ®åº“');
                    catalogData = {};
                    searchHistory = [];
                    uploadedFiles = {};
                    // ç«‹å³åˆ›å»ºåˆå§‹æ•°æ®åº“
                    await saveDatabaseToR2();
                    return true;
                }
                console.error('ä»R2åŠ è½½æ•°æ®åº“å¤±è´¥:', error);
                throw error;
            }
        }

        /**
         * ä¿å­˜å®Œæ•´æ•°æ®åº“åˆ°R2
         */
        async function saveDatabaseToR2() {
            if (!s3Client) {
                throw new Error('R2å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
            }
            
            const database = {
                catalogData: catalogData,
                searchHistory: searchHistory,
                uploadedFiles: uploadedFiles,
                lastModified: new Date().toISOString(),
                version: '4.0-r2-offline-optimized'
            };
            
            const dataBlob = new Blob([JSON.stringify(database, null, 2)], { 
                type: 'application/json' 
            });
            
            try {
                await s3Client.putObject({
                    Bucket: r2Config.bucket,
                    Key: 'yudong-cloud/database.json',
                    Body: dataBlob,
                    ContentType: 'application/json'
                }).promise();
                
                console.log('æ•°æ®åº“å·²ä¿å­˜åˆ°R2');
                
                // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
                saveToLocalCache();
                
                return true;
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®åº“åˆ°R2å¤±è´¥:', error);
                throw error;
            }
        }

        /**
         * ç»Ÿä¸€çš„æ•°æ®åº“æ“ä½œå‡½æ•° - æ‰€æœ‰CRUDæ“ä½œéƒ½é€šè¿‡è¿™ä¸ªå‡½æ•°
         */
        async function withDatabaseOperation(operation) {
            // æ£€æŸ¥æ˜¯å¦å¤„äºåªè¯»æ¨¡å¼
            if (isReadOnlyMode) {
                showToast('ç¦»çº¿æ¨¡å¼ä¸‹æ— æ³•ä¿®æ”¹æ•°æ®', 2000);
                throw new Error('ç¦»çº¿æ¨¡å¼ä¸‹æ— æ³•ä¿®æ”¹æ•°æ®');
            }
            
            try {
                // æ‰§è¡Œæ“ä½œ
                const result = await operation();
                
                // æ“ä½œæˆåŠŸåç«‹å³åŒæ­¥åˆ°R2
                console.log('å¼€å§‹åŒæ­¥æ•°æ®åˆ°R2...');
                await saveDatabaseToR2();
                console.log('æ•°æ®å·²åŒæ­¥åˆ°R2');
                
                // æ›´æ–°UI
                updateStats();
                if (document.getElementById('tabManage').classList.contains('active')) {
                    renderManageProducts();
                }
                
                return result;
            } catch (error) {
                console.error('æ•°æ®åº“æ“ä½œå¤±è´¥:', error);
                showToast('æ“ä½œå¤±è´¥: ' + error.message);
                throw error;
            }
        }

        // ============== å›¾ç‰‡ä¸Šä¼ åˆ°R2çš„åŠŸèƒ½ ==============
        
        function generateImageUrl(productCode) {
            if (!r2Config.customDomain) {
                throw new Error('R2è‡ªå®šä¹‰åŸŸåæœªé…ç½®');
            }
            
            const baseUrl = r2Config.customDomain.endsWith('/') 
                ? r2Config.customDomain 
                : r2Config.customDomain + '/';
            
            return `${baseUrl}yudong-fabric/${productCode}.jpg`;
        }

        async function uploadToR2(file, productCode) {
            return new Promise((resolve, reject) => {
                if (!s3Client) {
                    reject(new Error('è¯·å…ˆé…ç½®Cloudflare R2'));
                    return;
                }
                
                const key = `yudong-fabric/${productCode}.jpg`;
                
                s3Client.putObject({
                    Bucket: r2Config.bucket,
                    Key: key,
                    Body: file,
                    ContentType: 'image/jpeg',
                }, function(err, data) {
                    if (err) {
                        console.error('R2ä¸Šä¼ å¤±è´¥:', err);
                        reject(err);
                    } else {
                        console.log('R2ä¸Šä¼ æˆåŠŸ:', data);
                        const imageUrl = generateImageUrl(productCode);
                        console.log('ç”Ÿæˆçš„å›¾ç‰‡URL:', imageUrl);
                        resolve(imageUrl);
                    }
                });
            });
        }

        /**
         * è·å–å›¾ç‰‡çœŸå®å°ºå¯¸
         */
        function getImageDimensions(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    const dimensions = {
                        width: this.naturalWidth,
                        height: this.naturalHeight
                    };
                    console.log(`è·å–å›¾ç‰‡å°ºå¯¸: ${file.name}, å®½åº¦: ${dimensions.width}, é«˜åº¦: ${dimensions.height}`);
                    URL.revokeObjectURL(img.src);
                    resolve(dimensions);
                };
                img.onerror = function() {
                    URL.revokeObjectURL(img.src);
                    reject(new Error(`æ— æ³•åŠ è½½å›¾ç‰‡: ${file.name}`));
                };
                img.src = URL.createObjectURL(file);
            });
        }

        // ============== iOS UI åŠŸèƒ½ ==============
        
        // æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll('.ios-tab-item').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                
                document.querySelectorAll('.ios-tab-item').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                document.querySelectorAll('.ios-tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
                
                updateNavBar(tabName);
                
                if (tabName === 'manage') {
                    setTimeout(renderManageProducts, 50);
                } else if (tabName === 'data') {
                    loadR2Config();
                }
            });
        });

        function updateNavBar(tabName) {
            const navTitle = document.getElementById('navTitle');
            
            switch(tabName) {
                case 'query':
                    navTitle.textContent = 'æŠ¥ä»·å·¥ä½œå°';
                    break;
                case 'manage':
                    navTitle.textContent = 'äº§å“ç®¡ç†';
                    break;
                case 'data':
                    navTitle.textContent = 'ç³»ç»Ÿè®¾ç½®';
                    break;
            }
        }

        // æ¨¡æ€æ¡†åŠŸèƒ½
        function showAddProductModal() {
            // æ£€æŸ¥æ˜¯å¦å¤„äºåªè¯»æ¨¡å¼
            if (isReadOnlyMode) {
                showToast('ç¦»çº¿æ¨¡å¼ä¸‹æ— æ³•æ·»åŠ äº§å“', 2000);
                return;
            }
            document.getElementById('addProductModal').classList.add('active');
        }

        function hideAddProductModal() {
            document.getElementById('addProductModal').classList.remove('active');
            clearForm();
        }

        // æ˜¾ç¤ºToastæ¶ˆæ¯
        function showToast(message, duration = 2000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // ============== æ ¸å¿ƒåŠŸèƒ½å®ç° - ä¼˜åŒ–ç‰ˆç»„åˆæŸ¥è¯¢ ==============
        
        /**
         * ä¼˜åŒ–ç‰ˆç»„åˆæŸ¥è¯¢è§£æå™¨
         */
        function parseCombinedQuery(input) {
            const conditions = [];
            const tokens = input.split(/[\s,ï¼Œã€\n]+/).filter(token => token.trim());
            
            tokens.forEach(token => {
                token = token.trim();
                
                // 1. ç³»åˆ—æ¡ä»¶
                const seriesMatch = token.match(/([A-Z]+)ç³»åˆ—/i);
                if (seriesMatch) {
                    conditions.push({
                        type: 'series',
                        value: seriesMatch[1].toUpperCase()
                    });
                    return;
                }
                
                // 2. ä»·æ ¼åŒºé—´
                const priceMatch = token.match(/(\d+(?:\.\d+)?)\s*å…ƒå†…/i) || 
                                   token.match(/(\d+(?:\.\d+)?)\s*-\s*(\d+(?:\.\d+)?)\s*å…ƒ/i) ||
                                   token.match(/(\d+(?:\.\d+)?)\s*å…ƒä»¥ä¸Š/i);
                if (priceMatch) {
                    if (token.includes('å…ƒå†…')) {
                        conditions.push({
                            type: 'price',
                            min: 0,
                            max: parseFloat(priceMatch[1])
                        });
                    } else if (token.includes('-')) {
                        conditions.push({
                            type: 'price',
                            min: parseFloat(priceMatch[1]),
                            max: parseFloat(priceMatch[2])
                        });
                    } else if (token.includes('å…ƒä»¥ä¸Š')) {
                        conditions.push({
                            type: 'price',
                            min: parseFloat(priceMatch[1]),
                            max: Infinity
                        });
                    }
                    return;
                }
                
                // 3. å…‹é‡åŒºé—´
                const weightMatch = token.match(/(\d+(?:\.\d+)?)\s*å…‹å†…/i) || 
                                    token.match(/(\d+(?:\.\d+)?)\s*-\s*(\d+(?:\.\d+)?)\s*å…‹/i) ||
                                    token.match(/(\d+(?:\.\d+)?)\s*å…‹ä»¥ä¸Š/i);
                if (weightMatch) {
                    if (token.includes('å…‹å†…')) {
                        conditions.push({
                            type: 'weight',
                            min: 0,
                            max: parseFloat(weightMatch[1])
                        });
                    } else if (token.includes('-')) {
                        conditions.push({
                            type: 'weight',
                            min: parseFloat(weightMatch[1]),
                            max: parseFloat(weightMatch[2])
                        });
                    } else if (token.includes('å…‹ä»¥ä¸Š')) {
                        conditions.push({
                            type: 'weight',
                            min: parseFloat(weightMatch[1]),
                            max: Infinity
                        });
                    }
                    return;
                }
                
                // 4. ä¾›åº”å•†æ¡ä»¶
                if (token.length > 1 && !token.match(/[\då…ƒå…‹]/) && !token.includes('ç³»åˆ—')) {
                    conditions.push({
                        type: 'supplier',
                        value: token
                    });
                    return;
                }
                
                // 5. æˆåˆ†æ¡ä»¶
                const compositionMatch = token.match(/(æ£‰|é”¦çº¶|æ¶¤çº¶|æ°¨çº¶|ç¾Šæ¯›|ä¸|éº»)/i);
                if (compositionMatch) {
                    conditions.push({
                        type: 'composition',
                        value: token
                    });
                    return;
                }
                
                // 6. äº§å“ä»£ç æ¨¡ç³ŠåŒ¹é…
                if (token.match(/^[A-Z\d]+$/i)) {
                    conditions.push({
                        type: 'code',
                        value: token.toUpperCase()
                    });
                }
            });
            
            return conditions;
        }

        /**
         * æ‰§è¡Œç»„åˆæŸ¥è¯¢
         */
        function performCombinedQuery(conditions) {
            return Object.values(catalogData).filter(product => {
                return conditions.every(condition => {
                    switch (condition.type) {
                        case 'series':
                            return product.code.startsWith(condition.value);
                        
                        case 'price':
                            const price = parseFloat(product.priceAlt);
                            return !isNaN(price) && price >= (condition.min || 0) && price <= (condition.max || Infinity);
                        
                        case 'weight':
                            const weight = parseFloat(product.weight);
                            return !isNaN(weight) && weight >= (condition.min || 0) && weight <= (condition.max || Infinity);
                        
                        case 'supplier':
                            return product.supplier && product.supplier.includes(condition.value);
                        
                        case 'composition':
                            if (!product.composition) return false;
                            const productComposition = product.composition.replace(/\s+/g, '').replace(/%/g, '');
                            const conditionComposition = condition.value.replace(/\s+/g, '').replace(/%/g, '');
                            const conditionParts = conditionComposition.match(/\d+|[^\d]+/g) || [];
                            const productParts = productComposition.match(/\d+|[^\d]+/g) || [];
                            
                            if (conditionParts.length === 1 && !/\d/.test(conditionParts[0])) {
                                return productComposition.includes(conditionParts[0]);
                            }
                            
                            return conditionParts.every(part => 
                                productParts.some(pPart => pPart.includes(part))
                            );
                        
                        case 'code':
                            return product.code.includes(condition.value);
                        
                        default:
                            return true;
                    }
                });
            });
        }

        /**
         * ä¼˜åŒ–ç‰ˆæœç´¢å¤„ç†å‡½æ•°
         */
        function handleSearch(inputValue) {
            const input = (inputValue || document.getElementById('searchInput').value).trim();
            if (!input) {
                searchResults = [];
                fuzzyMatches = [];
                rangeResults = [];
                renderResults();
                return;
            }
            
            // ä¿å­˜æœç´¢å†å²åˆ°R2
            if (!isReadOnlyMode) {
                withDatabaseOperation(async () => {
                    if (!searchHistory.includes(input)) {
                        searchHistory.push(input);
                        if (searchHistory.length > 10) searchHistory.shift();
                    }
                }).then(() => {
                    renderHistory();
                    updateSidebarHistory();
                });
            } else {
                // ç¦»çº¿æ¨¡å¼ä¸‹åªæ›´æ–°æœ¬åœ°ç¼“å­˜
                if (!searchHistory.includes(input)) {
                    searchHistory.push(input);
                    if (searchHistory.length > 10) searchHistory.shift();
                    saveToLocalCache();
                    renderHistory();
                    updateSidebarHistory();
                }
            }
            
            // é¦–å…ˆå°è¯•ç»„åˆæŸ¥è¯¢
            const conditions = parseCombinedQuery(input);
            if (conditions.length > 0) {
                console.log('ç»„åˆæŸ¥è¯¢æ¡ä»¶:', conditions);
                const combinedResults = performCombinedQuery(conditions);
                
                if (combinedResults.length > 0) {
                    searchResults = combinedResults.map(product => ({
                        ...product,
                        found: true,
                        matchType: 'combined'
                    }));
                    fuzzyMatches = [];
                    rangeResults = [];
                    renderResults();
                    return;
                }
            }
            
            // å¦‚æœç»„åˆæŸ¥è¯¢æ²¡æœ‰ç»“æœï¼Œå›é€€åˆ°åŸæ¥çš„æŸ¥è¯¢é€»è¾‘
            const parsed = parseRangeInput(input);
            if (parsed.ranges.length > 0 && (parsed.type === 'price' || parsed.type === 'weight')) {
                rangeResults = performRangeQuery(parsed.ranges, parsed.type);
                searchResults = [];
                fuzzyMatches = [];
            } else {
                const codes = input.split(/[\s,;\n]+/).map(c => c.trim()).filter(c => c.length > 0);
                searchResults = [];
                fuzzyMatches = [];
                rangeResults = [];
                
                codes.forEach(code => {
                    if (catalogData[code]) {
                        const result = {...catalogData[code]};
                        result.found = true;
                        result.matchType = 'exact';
                        searchResults.push(result);
                    } else {
                        const matches = Object.keys(catalogData).filter(key => {
                            const product = catalogData[key];
                            const codeMatch = key.toUpperCase().includes(code);
                            const supplierMatch = product.supplier && product.supplier.toUpperCase().includes(code);
                            return codeMatch || supplierMatch;
                        });
                        
                        if (matches.length === 1) {
                            const result = {...catalogData[matches[0]]};
                            result.found = true;
                            result.matchType = 'fuzzy';
                            searchResults.push(result);
                        } else if (matches.length > 1) {
                            fuzzyMatches.push({ searchTerm: code, matches: matches.slice(0, 50) });
                        } else {
                            searchResults.push({ code: code, found: false, error: 'æœªæ‰¾åˆ°è¯¥äº§å“' });
                        }
                    }
                });
            }
            
            renderResults();
        }

        // ä¿ç•™åŸæœ‰çš„èŒƒå›´æŸ¥è¯¢å‡½æ•°
        function parseRangeInput(input) {
            const ranges = [];
            const items = input.split(/[,ï¼Œ\s]+/).map(item => item.trim()).filter(item => item);
            let type = null;
            
            items.forEach(item => {
                const upper = item.toUpperCase();
                let min = null, max = null, label = item;
                
                if (upper.includes('å…ƒ')) {
                    type = 'price';
                    if (upper.includes('ä»¥ä¸Š')) {
                        min = parseFloat(upper.replace(/[^0-9.]/g, ''));
                        max = Infinity;
                    } else if (upper.includes('å†…')) {
                        max = parseFloat(upper.replace(/[^0-9.]/g, ''));
                        min = 0;
                    } else {
                        const match = upper.match(/(\d+(?:\.\d+)?)-(\d+(?:\.\d+)?)å…ƒ/);
                        if (match) {
                            min = parseFloat(match[1]);
                            max = parseFloat(match[2]);
                        }
                    }
                } else if (upper.includes('å…‹')) {
                    type = 'weight';
                    if (upper.includes('ä»¥ä¸Š')) {
                        min = parseFloat(upper.replace(/[^0-9.]/g, ''));
                        max = Infinity;
                    } else if (upper.includes('å†…')) {
                        max = parseFloat(upper.replace(/[^0-9.]/g, ''));
                        min = 0;
                    } else {
                        const match = upper.match(/(\d+(?:\.\d+)?)-(\d+(?:\.\d+)?)å…‹/);
                        if (match) {
                            min = parseFloat(match[1]);
                            max = parseFloat(match[2]);
                        }
                    }
                }
                
                if (min !== null || max !== null) {
                    ranges.push({ min, max, label, type });
                }
            });
            
            return { ranges, type };
        }

        function performRangeQuery(ranges, type) {
            const results = [];
            const field = type === 'price' ? 'priceAlt' : 'weight';
            
            ranges.forEach(range => {
                const matches = [];
                Object.values(catalogData).forEach(product => {
                    const value = parseFloat(product[field]);
                    if (!isNaN(value) && value >= (range.min || 0) && value <= (range.max || Infinity)) {
                        const match = JSON.parse(JSON.stringify(product));
                        match.matchType = 'range';
                        match.rangeLabel = range.label;
                        matches.push(match);
                    }
                });
                
                matches.sort((a, b) => {
                    const seriesA = a.code.match(/^[YC]*([ACDFGJMST])/);
                    const seriesB = b.code.match(/^[YC]*([ACDFGJMST])/);
                    const seriesAChar = seriesA ? seriesA[1] : '';
                    const seriesBChar = seriesB ? seriesB[1] : '';
                    if (seriesAChar !== seriesBChar) return seriesAChar.localeCompare(seriesBChar);
                    const numA = parseInt(a.code.replace(/^[YC]*[ACDFGJMST]/, '')) || 0;
                    const numB = parseInt(b.code.replace(/^[YC]*[ACDFGJMST]/, '')) || 0;
                    return numA - numB;
                });
                
                const result = JSON.parse(JSON.stringify(range));
                result.matches = matches;
                results.push(result);
            });
            
            return results;
        }

        // æ¸²æŸ“äº§å“ä»£ç æ±‡æ€»å¡ç‰‡
        function renderCodeSummaryCard(allResults) {
            const codeSummaryCard = document.getElementById('codeSummaryCard');
            const codeSummaryCount = document.getElementById('codeSummaryCount');
            const codeSummaryGrid = document.getElementById('codeSummaryGrid');
            
            if (allResults.length === 0) {
                codeSummaryCard.style.display = 'none';
                return;
            }
            
            const uniqueCodes = [...new Set(allResults.map(result => result.code))];
            
            codeSummaryCount.textContent = `${uniqueCodes.length} ä¸ª`;
            codeSummaryGrid.innerHTML = '';
            
            uniqueCodes.forEach(code => {
                const codeItem = document.createElement('div');
                codeItem.className = 'ios-code-item';
                codeItem.textContent = code;
                codeItem.onclick = () => {
                    const productCard = document.getElementById(`product-${code}`);
                    if (productCard) {
                        productCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        productCard.style.boxShadow = '0 0 0 2px var(--ios-system-blue)';
                        setTimeout(() => {
                            productCard.style.boxShadow = '';
                        }, 2000);
                    }
                };
                codeSummaryGrid.appendChild(codeItem);
            });
            
            codeSummaryCard.style.display = 'block';
        }

        // æ¸²æŸ“äº§å“å¡ç‰‡
        function renderProductCard(product, isSearchResult = false) {
            let imageUrl = product.image;
            
            const hasImage = imageUrl && imageUrl !== '';
            const imageWidth = product.imageWidth || 1200;
            const imageHeight = product.imageHeight || 800;
            
            // ç¦»çº¿æ¨¡å¼ä¸‹ç¦ç”¨ç¼–è¾‘åˆ é™¤æŒ‰é’®
            const actionButtonsDisabled = isReadOnlyMode ? 'offline-disabled" disabled="true' : '';
            
            return `
            <div class="ios-product-card ios-fade-in" id="product-${product.code}">
                <div class="ios-product-header">
                    <div class="ios-product-code-container">
                        <div class="ios-product-code">${product.code}</div>
                        <div class="ios-product-status ${hasImage ? '' : 'missing'}"></div>
                    </div>
                    
                    <div class="ios-product-image-container">
                        ${hasImage ? `
                        <a href="${imageUrl}" data-pswp-src="${imageUrl}" data-pswp-width="${imageWidth}" data-pswp-height="${imageHeight}">
                            <div class="ios-product-image">
                                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2YwZjBmMCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7lm77niYc8L3RleHQ+PC9zdmc+" alt="${product.code}" data-product-code="${product.code}" data-image-url="${imageUrl}">
                            </div>
                        </a>
                        ` : `
                        <div class="ios-product-image" style="color: var(--ios-label-tertiary); cursor: default;">
                            <div style="text-align: center;">
                                <div style="font-size: 16px; margin-bottom: 2px;">ğŸ“·</div>
                                <div style="font-size: 9px; font-weight: 600;">æ— å›¾ç‰‡</div>
                            </div>
                        </div>
                        `}
                    </div>
                </div>
                
                <div class="ios-product-details">
                    <div class="ios-product-detail">
                        <div class="ios-product-detail-label">ç ä»·</div>
                        <div class="ios-product-detail-value">${product.price}</div>
                    </div>
                    <div class="ios-product-detail">
                        <div class="ios-product-detail-label">ç±³ä»·</div>
                        <div class="ios-product-detail-value">${product.priceAlt}</div>
                    </div>
                    <div class="ios-product-detail">
                        <div class="ios-product-detail-label">é—¨å¹…</div>
                        <div class="ios-product-detail-value">${product.width}</div>
                    </div>
                    <div class="ios-product-detail">
                        <div class="ios-product-detail-label">å…‹é‡</div>
                        <div class="ios-product-detail-value">${product.weight}</div>
                    </div>
                    <div class="ios-product-detail">
                        <div class="ios-product-detail-label">æˆåˆ†</div>
                        <div class="ios-product-detail-value">${product.composition}</div>
                    </div>
                    <div class="ios-product-detail">
                        <div class="ios-product-detail-label">ä¾›åº”å•†</div>
                        <div class="ios-product-detail-value">${product.supplier}</div>
                    </div>
                </div>
                
                ${product.notes && product.notes !== '-' ? `<div class="ios-product-notes">${product.notes}</div>` : ''}
                
                ${!isSearchResult ? `
                <div class="ios-product-actions">
                    <button class="ios-button ios-button-small ${actionButtonsDisabled}" onclick="editProduct('${product.code}')">ç¼–è¾‘</button>
                    <button class="ios-button ios-button-destructive ios-button-small ${actionButtonsDisabled}" onclick="deleteProductFromList('${product.code}')">åˆ é™¤</button>
                </div>
                ` : ''}
            </div>
            `;
        }

        // åˆå§‹åŒ–å›¾ç‰‡åŠ è½½
        function initImageLoading() {
            // ä¸ºæ‰€æœ‰å›¾ç‰‡å…ƒç´ æ·»åŠ åŠ è½½ç›‘å¬
            document.addEventListener('DOMContentLoaded', function() {
                // ä½¿ç”¨MutationObserverç›‘å¬åŠ¨æ€æ·»åŠ çš„å›¾ç‰‡
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1) { // Element node
                                const images = node.querySelectorAll ? node.querySelectorAll('img[data-product-code]') : [];
                                images.forEach(img => {
                                    const productCode = img.getAttribute('data-product-code');
                                    const imageUrl = img.getAttribute('data-image-url');
                                    if (productCode && imageUrl) {
                                        loadImageWithCache(productCode, imageUrl, img);
                                    }
                                });
                            }
                        });
                    });
                });
                
                observer.observe(document.body, {
                    childList: true,
                    subtree: true
                });
                
                // åˆå§‹åŠ è½½ç°æœ‰å›¾ç‰‡
                document.querySelectorAll('img[data-product-code]').forEach(img => {
                    const productCode = img.getAttribute('data-product-code');
                    const imageUrl = img.getAttribute('data-image-url');
                    if (productCode && imageUrl) {
                        loadImageWithCache(productCode, imageUrl, img);
                    }
                });
            });
        }

        function renderResults() {
            let html = '';
            let allResults = [];
            
            if (rangeResults.length > 0) {
                rangeResults.forEach(range => {
                    range.matches.forEach(product => {
                        allResults.push(product);
                    });
                });
            } else {
                searchResults.filter(r => r.found).forEach(r => {
                    allResults.push(r);
                });
            }
            
            renderCodeSummaryCard(allResults);
            
            if (rangeResults.length > 0) {
                rangeResults.forEach(range => {
                    html += `<div class="ios-card mb-md">
                        <div class="ios-card-header">
                            <div class="ios-card-title">ğŸ“Š ${range.label} - ${range.matches.length} ä¸ªåŒ¹é…äº§å“</div>
                        </div>
                        <div class="ios-card-content">`;
                    
                    range.matches.forEach(product => {
                        html += renderProductCard(product, true);
                    });
                    
                    html += `</div></div>`;
                });
            } else {
                if (fuzzyMatches.length > 0) {
                    html += '<div class="ios-card mb-md">';
                    html += '<div class="ios-card-header"><div class="ios-card-title">æ¨¡ç³ŠåŒ¹é…ç»“æœ</div></div>';
                    html += '<div class="ios-card-content">';
                    fuzzyMatches.forEach(group => {
                        html += `<p class="mb-sm">æœç´¢è¯ "${group.searchTerm}" æ‰¾åˆ° ${group.matches.length} ä¸ªåŒ¹é…ï¼š</p>`;
                        html += '<div style="display: flex; flex-wrap: wrap; gap: var(--ios-spacing-sm);">';
                        group.matches.forEach(code => {
                            html += `<button class="ios-button ios-button-secondary ios-button-compact" onclick="selectFuzzyMatch('${code}')">${code}</button>`;
                        });
                        html += '</div>';
                    });
                    html += '</div></div>';
                }
                
                searchResults.forEach(result => {
                    if (result.found) {
                        html += renderProductCard(result, true);
                    } else {
                        html += `
                        <div class="ios-card mb-md">
                            <div class="ios-card-content">
                                <div style="text-align: center; color: var(--ios-system-red);">
                                    <div style="font-size: 24px; margin-bottom: var(--ios-spacing-sm);">âš ï¸</div>
                                    <div style="font-weight: 600;">${result.code}</div>
                                    <div style="font-size: 13px; color: var(--ios-label-secondary); margin-top: var(--ios-spacing-xs);">${result.error}</div>
                                </div>
                            </div>
                        </div>
                        `;
                    }
                });
            }
            
            document.getElementById('resultsArea').innerHTML = html;
            const hasResults = html.length > 0 || allResults.length > 0;
            document.getElementById('resultsSection').style.display = hasResults ? 'block' : 'none';
            document.getElementById('pdfExportSection').style.display = hasResults ? 'block' : 'none';
            
            // åˆå§‹åŒ–å›¾ç‰‡åŠ è½½
            setTimeout(() => {
                document.querySelectorAll('#resultsArea img[data-product-code]').forEach(img => {
                    const productCode = img.getAttribute('data-product-code');
                    const imageUrl = img.getAttribute('data-image-url');
                    if (productCode && imageUrl) {
                        loadImageWithCache(productCode, imageUrl, img);
                    }
                });
            }, 100);
            
            initPhotoSwipe();
        }

        function selectFuzzyMatch(code) {
            document.getElementById('searchInput').value = code;
            handleSearch(code);
        }

        // ============== PhotoSwipeå›¾ç‰‡æŸ¥çœ‹å™¨åˆå§‹åŒ– - ä¿®å¤ç¦»çº¿æ¨¡å¼æ”¯æŒ ==============
        function initPhotoSwipe() {
            if (photoSwipeLightbox) {
                photoSwipeLightbox.destroy();
            }
            
            photoSwipeLightbox = new PhotoSwipeLightbox({
                gallery: '#resultsArea, #manageProductList',
                children: 'a[data-pswp-src]',
                pswpModule: PhotoSwipe,
                
                wheelToZoom: true,
                initialZoomLevel: 'fit',
                secondaryZoomLevel: 1.5,
                maxZoomLevel: 4,
                closeOnVerticalDrag: true,
                hideAnimationDuration: 200,
                showAnimationDuration: 200,
                zoomAnimationDuration: 200,
                bgOpacity: 0.9,
                
                allowPanToNext: true,
                maxWidthToAnimate: 4000,
                maxHeightToAnimate: 4000,
                easing: 'cubic-bezier(.4, 0,.22,1)',
                
                preload: [1, 2],
                preloaderDelay: 0
            });
            
            // ä¿®å¤ç¦»çº¿æ¨¡å¼æ”¯æŒï¼šåœ¨æ‰“å¼€å‰æ£€æŸ¥ç¼“å­˜
            photoSwipeLightbox.on('beforeOpen', async () => {
                if (!isOnline) {
                    const dataSource = photoSwipeLightbox.pswp.options.dataSource;
                    if (Array.isArray(dataSource)) {
                        for (let i = 0; i < dataSource.length; i++) {
                            const item = dataSource[i];
                            // æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜
                            const productCode = item.element?.getAttribute('data-product-code');
                            if (productCode) {
                                const cachedBlob = await getImageFromCache(productCode);
                                if (cachedBlob) {
                                    const blobUrl = URL.createObjectURL(cachedBlob);
                                    // ä¿å­˜åŸå§‹URLä»¥ä¾¿å…³é—­æ—¶æ¢å¤
                                    item._originalSrc = item.src;
                                    item.src = blobUrl;
                                }
                            }
                        }
                    }
                }
            });
            
            // æ¸…ç†Blob URL
            photoSwipeLightbox.on('close', () => {
                if (!isOnline) {
                    const dataSource = photoSwipeLightbox.pswp.options.dataSource;
                    if (Array.isArray(dataSource)) {
                        dataSource.forEach(item => {
                            if (item._originalSrc) {
                                // é‡Šæ”¾Blob URL
                                URL.revokeObjectURL(item.src);
                                item.src = item._originalSrc;
                                delete item._originalSrc;
                            }
                        });
                    }
                }
            });
            
            photoSwipeLightbox.on('itemData', (e) => {
                const imgElement = e.itemData.element;
                if (imgElement) {
                    const width = parseInt(imgElement.getAttribute('data-pswp-width')) || 0;
                    const height = parseInt(imgElement.getAttribute('data-pswp-height')) || 0;
                    
                    if (width && height) {
                        e.itemData.width = width;
                        e.itemData.height = height;
                    } else {
                        e.itemData.width = 1200;
                        e.itemData.height = 800;
                    }
                }
            });
            
            photoSwipeLightbox.on('uiRegister', function() {
                photoSwipeLightbox.pswp.ui.registerElement({
                    name: 'download-button',
                    order: 8,
                    isButton: true,
                    tagName: 'a',
                    html: 'â¬‡ï¸',
                    onInit: (el, pswp) => {
                        el.setAttribute('download', '');
                        el.setAttribute('target', '_blank');
                        el.setAttribute('rel', 'noopener');
                        el.setAttribute('title', 'ä¸‹è½½å›¾ç‰‡');
                        
                        pswp.on('change', () => {
                            const slide = pswp.currSlide;
                            if (slide) {
                                el.href = slide.data.src;
                            }
                        });
                    }
                });
            });
            
            photoSwipeLightbox.init();
        }

        // ============== äº§å“ç®¡ç†åŠŸèƒ½ - çº¯ç²¹çš„R2äº‘ç«¯å­˜å‚¨ ==============
        async function addOrUpdateProduct() {
            // æ£€æŸ¥æ˜¯å¦å¤„äºåªè¯»æ¨¡å¼
            if (isReadOnlyMode) {
                showToast('ç¦»çº¿æ¨¡å¼ä¸‹æ— æ³•æ·»åŠ äº§å“', 2000);
                return;
            }
            
            const saveButton = document.querySelector('.ios-modal-header .ios-nav-button:last-child');
            const originalText = saveButton.textContent;
            
            saveButton.textContent = 'ä¿å­˜ä¸­...';
            saveButton.classList.add('ios-button-saving');
            
            const inputs = document.querySelectorAll('#addProductModal .ios-input, #addProductModal #imageInput');
            inputs.forEach(input => input.disabled = true);
            
            try {
                const code = document.getElementById('codeInput').value.trim().toUpperCase();
                if (!code || !code.match(/^[YC]*[ACDFGJMST]\d+/)) {
                    showToast('äº§å“ä»£ç æ ¼å¼æ— æ•ˆï¼ˆä¾‹å¦‚ï¼šC6001, YC2001ï¼‰');
                    return;
                }
                
                const imageFile = document.getElementById('imageInput').files[0];
                let imageUrl = catalogData[code] ? catalogData[code].image : null;
                let imageWidth = catalogData[code] ? catalogData[code].imageWidth : null;
                let imageHeight = catalogData[code] ? catalogData[code].imageHeight : null;
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æ–°å›¾ç‰‡ä¸Šä¼ 
                const hasNewImage = imageFile && imageFile.size > 0;
                
                if (hasNewImage) {
                    if (imageFile.size > 5 * 1024 * 1024) {
                        showToast('å›¾ç‰‡è¿‡å¤§ï¼ˆ>5MBï¼‰ï¼Œè¯·å‹ç¼©åä¸Šä¼ ');
                        return;
                    }
                    
                    try {
                        const dimensions = await getImageDimensions(imageFile);
                        imageWidth = dimensions.width;
                        imageHeight = dimensions.height;
                        
                        if (s3Client) {
                            imageUrl = await uploadToR2(imageFile, code);
                        } else {
                            throw new Error('è¯·å…ˆé…ç½®Cloudflare R2');
                        }
                    } catch (error) {
                        console.error('å›¾ç‰‡å¤„ç†å¤±è´¥:', error);
                        showToast('å›¾ç‰‡å¤„ç†å¤±è´¥: ' + error.message);
                        return;
                    }
                }
                
                // ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®åº“æ“ä½œå‡½æ•° - ç¡®ä¿æ•°æ®ä¿å­˜åˆ°R2
                await withDatabaseOperation(async () => {
                    // å¦‚æœæœ‰æ–°å›¾ç‰‡ä¸Šä¼ ï¼Œæ¸…é™¤è¯¥äº§å“çš„å›¾ç‰‡ç¼“å­˜
                    if (hasNewImage) {
                        await clearProductImageCache(code);
                    }
                    
                    catalogData[code] = {
                        code: code,
                        price: document.getElementById('priceInput').value || '-',
                        priceAlt: document.getElementById('priceAltInput').value || '-',
                        width: document.getElementById('widthInput').value || '-',
                        composition: document.getElementById('compositionInput').value || '-',
                        weight: document.getElementById('weightInput').value || '-',
                        notes: document.getElementById('notesInput').value || '-',
                        supplier: document.getElementById('supplierInput').value || '-',
                        image: imageUrl,
                        imageWidth: imageWidth,
                        imageHeight: imageHeight
                    };
                });
                
                if (editingCode) {
                    showToast('äº§å“å·²æ›´æ–°');
                } else {
                    showToast('äº§å“å·²æ·»åŠ ');
                }
                
                hideAddProductModal();
            } catch (error) {
                console.error('ä¿å­˜äº§å“å¤±è´¥:', error);
                showToast('ä¿å­˜å¤±è´¥: ' + error.message);
            } finally {
                saveButton.textContent = originalText;
                saveButton.classList.remove('ios-button-saving');
                inputs.forEach(input => input.disabled = false);
            }
        }

        function editProduct(code) {
            // æ£€æŸ¥æ˜¯å¦å¤„äºåªè¯»æ¨¡å¼
            if (isReadOnlyMode) {
                showToast('ç¦»çº¿æ¨¡å¼ä¸‹æ— æ³•ç¼–è¾‘äº§å“', 2000);
                return;
            }
            
            const product = catalogData[code];
            if (!product) return;
            
            document.getElementById('codeInput').value = product.code;
            document.getElementById('supplierInput').value = product.supplier;
            document.getElementById('priceInput').value = product.price;
            document.getElementById('priceAltInput').value = product.priceAlt;
            document.getElementById('widthInput').value = product.width;
            document.getElementById('weightInput').value = product.weight;
            document.getElementById('compositionInput').value = product.composition;
            document.getElementById('notesInput').value = product.notes;
            
            editingCode = code;
            showAddProductModal();
        }

        function clearForm() {
            document.getElementById('codeInput').value = '';
            document.getElementById('supplierInput').value = '';
            document.getElementById('priceInput').value = '';
            document.getElementById('priceAltInput').value = '';
            document.getElementById('widthInput').value = '';
            document.getElementById('weightInput').value = '';
            document.getElementById('compositionInput').value = '';
            document.getElementById('notesInput').value = '';
            document.getElementById('imageInput').value = '';
            
            editingCode = null;
        }

        async function deleteProductFromList(code) {
            // æ£€æŸ¥æ˜¯å¦å¤„äºåªè¯»æ¨¡å¼
            if (isReadOnlyMode) {
                showToast('ç¦»çº¿æ¨¡å¼ä¸‹æ— æ³•åˆ é™¤äº§å“', 2000);
                return;
            }
            
            if (confirm('ç¡®å®šåˆ é™¤äº§å“ ' + code + 'ï¼Ÿ')) {
                try {
                    // ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®åº“æ“ä½œå‡½æ•° - ç¡®ä¿æ•°æ®ä¿å­˜åˆ°R2
                    await withDatabaseOperation(async () => {
                        // æ¸…é™¤è¯¥äº§å“çš„æ‰€æœ‰å›¾ç‰‡ç¼“å­˜
                        await clearProductImageCache(code);
                        delete catalogData[code];
                    });
                    showToast('äº§å“å·²åˆ é™¤');
                } catch (error) {
                    showToast('åˆ é™¤å¤±è´¥: ' + error.message);
                }
            }
        }

        function filterManageProducts() {
            manageSearchTerm = document.getElementById('manageSearchInput').value.toUpperCase();
            manageCurrentPage = 1;
            renderManageProducts();
        }

        function renderManageProducts() {
            const listDiv = document.getElementById('manageProductList');
            let html = '';
            
            const products = Object.values(catalogData).filter(p => {
                return p.code.toUpperCase().includes(manageSearchTerm) || 
                       (p.supplier && p.supplier.toUpperCase().includes(manageSearchTerm));
            });
            
            filteredManageProducts = products.sort((a, b) => {
                const seriesA = a.code.match(/^[YC]*([ACDFGJMST])/);
                const seriesB = b.code.match(/^[YC]*([ACDFGJMST])/);
                const seriesAChar = seriesA ? seriesA[1] : '';
                const seriesBChar = seriesB ? seriesB[1] : '';
                if (seriesAChar !== seriesBChar) return seriesAChar.localeCompare(seriesBChar);
                const numA = parseInt(a.code.replace(/^[YC]*[ACDFGJMST]/, '')) || 0;
                const numB = parseInt(b.code.replace(/^[YC]*[ACDFGJMST]/, '')) || 0;
                return numA - numB;
            });
            
            const start = (manageCurrentPage - 1) * managePageSize;
            const end = start + managePageSize;
            const pageProducts = filteredManageProducts.slice(start, end);
            
            if (pageProducts.length === 0) {
                html = `
                <div class="ios-card">
                    <div class="ios-card-content" style="text-align: center; color: var(--ios-label-tertiary);">
                        <div style="font-size: 48px; margin-bottom: var(--ios-spacing-md);">ğŸ“¦</div>
                        <div style="font-size: 17px; font-weight: 600; margin-bottom: var(--ios-spacing-sm);">æš‚æ— äº§å“æ•°æ®</div>
                        <div style="font-size: 14px;">ç‚¹å‡»"æ·»åŠ äº§å“"å¼€å§‹åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªäº§å“</div>
                    </div>
                </div>
                `;
            } else {
                if (window.innerWidth >= 1200) {
                    html = '<div class="ios-product-grid">';
                    pageProducts.forEach(product => {
                        html += renderProductCard(product, false);
                    });
                    html += '</div>';
                } else {
                    pageProducts.forEach(product => {
                        html += renderProductCard(product, false);
                    });
                }
            }
            
            listDiv.innerHTML = html;
            hasMoreProducts = end < filteredManageProducts.length;
            document.getElementById('loadMoreContainer').style.display = hasMoreProducts ? 'block' : 'none';
            
            // åˆå§‹åŒ–å›¾ç‰‡åŠ è½½
            setTimeout(() => {
                document.querySelectorAll('#manageProductList img[data-product-code]').forEach(img => {
                    const productCode = img.getAttribute('data-product-code');
                    const imageUrl = img.getAttribute('data-image-url');
                    if (productCode && imageUrl) {
                        loadImageWithCache(productCode, imageUrl, img);
                    }
                });
            }, 100);
            
            initPhotoSwipe();
        }

        function loadMoreProducts() {
            manageCurrentPage++;
            renderManageProducts();
        }

        // ============== æœç´¢æ¡†é‡ç½®åŠŸèƒ½ ==============
        function resetSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchReset = document.getElementById('searchReset');
            
            searchInput.value = '';
            searchReset.classList.remove('show');
            
            searchResults = [];
            fuzzyMatches = [];
            rangeResults = [];
            renderResults();
        }

        function resetManageSearch() {
            const manageSearchInput = document.getElementById('manageSearchInput');
            const manageSearchReset = document.getElementById('manageSearchReset');
            
            manageSearchInput.value = '';
            manageSearchReset.classList.remove('show');
            
            manageSearchTerm = '';
            manageCurrentPage = 1;
            renderManageProducts();
        }

        // ============== R2é…ç½®ç®¡ç† ==============
        function saveR2Config() {
            r2Config = {
                accountId: document.getElementById('r2AccountId').value.trim(),
                accessKey: document.getElementById('r2AccessKey').value.trim(),
                secretKey: document.getElementById('r2SecretKey').value.trim(),
                bucket: document.getElementById('r2Bucket').value.trim(),
                customDomain: document.getElementById('r2CustomDomain').value.trim()
            };
            localStorage.setItem('r2-config', JSON.stringify(r2Config));
            loadR2Config();
            showToast('R2é…ç½®å·²ä¿å­˜');
        }

        function loadR2Config() {
            r2Config = JSON.parse(localStorage.getItem('r2-config') || '{}');
            document.getElementById('r2AccountId').value = r2Config.accountId || '';
            document.getElementById('r2AccessKey').value = r2Config.accessKey || '';
            document.getElementById('r2SecretKey').value = r2Config.secretKey || '';
            document.getElementById('r2Bucket').value = r2Config.bucket || '';
            document.getElementById('r2CustomDomain').value = r2Config.customDomain || 'https://img.yudong-textile.top';
            
            if (r2Config.accessKey && r2Config.secretKey && r2Config.accountId && r2Config.bucket) {
                s3Client = new AWS.S3({
                    endpoint: `https://${r2Config.accountId}.r2.cloudflarestorage.com`,
                    accessKeyId: r2Config.accessKey,
                    secretAccessKey: r2Config.secretKey,
                    s3ForcePathStyle: true,
                    signatureVersion: 'v4',
                    region: 'auto'
                });
                console.log('R2å®¢æˆ·ç«¯å·²åˆå§‹åŒ–');
            } else {
                s3Client = null;
                console.log('R2é…ç½®ä¸å®Œæ•´ï¼Œå®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
            }
        }

        function testR2Connection() {
            loadR2Config();
            if (!r2Config.accessKey || !r2Config.secretKey || !r2Config.bucket || !r2Config.accountId) {
                showToast('è¯·å…ˆå®Œæ•´å¡«å†™R2é…ç½®');
                return;
            }
            
            showToast('æ­£åœ¨æµ‹è¯•R2è¿æ¥...');
            
            s3Client = new AWS.S3({
                endpoint: `https://${r2Config.accountId}.r2.cloudflarestorage.com`,
                accessKeyId: r2Config.accessKey,
                secretAccessKey: r2Config.secretKey,
                s3ForcePathStyle: true,
                signatureVersion: 'v4',
                region: 'auto'
            });
            
            const testKey = `yudong-test/test-${Date.now()}.txt`;
            const testContent = 'Cloudflare R2 connection test';
            
            s3Client.putObject({
                Bucket: r2Config.bucket,
                Key: testKey,
                Body: testContent,
                ContentType: 'text/plain'
            }, function(err) {
                if (err) {
                    let errorMsg = 'R2è¿æ¥æµ‹è¯•å¤±è´¥: ';
                    if (err.code === 'AccessDenied') {
                        errorMsg += 'è®¿é—®æ‹’ç» - è¯·æ£€æŸ¥Access Keyæƒé™';
                    } else if (err.code === 'InvalidAccessKeyId') {
                        errorMsg += 'æ— æ•ˆçš„Access Key ID';
                    } else if (err.code === 'SignatureDoesNotMatch') {
                        errorMsg += 'ç­¾åä¸åŒ¹é… - è¯·æ£€æŸ¥Secret Key';
                    } else if (err.code === 'NoSuchBucket') {
                        errorMsg += 'å­˜å‚¨æ¡¶ä¸å­˜åœ¨ - è¯·æ£€æŸ¥Bucketåç§°';
                    } else {
                        errorMsg += err.message || 'æœªçŸ¥é”™è¯¯';
                    }
                    
                    showToast(errorMsg);
                } else {
                    s3Client.deleteObject({
                        Bucket: r2Config.bucket,
                        Key: testKey
                    }, function(deleteErr) {
                        if (deleteErr) {
                            console.warn('æµ‹è¯•æ–‡ä»¶åˆ é™¤å¤±è´¥:', deleteErr);
                        }
                    });
                    
                    showToast('âœ… R2è¿æ¥æµ‹è¯•æˆåŠŸï¼');
                }
            });
        }

        // ============== æ•°æ®ç®¡ç†åŠŸèƒ½ ==============
        function loadR2BackupFiles() {
            if (!s3Client) {
                showToast('è¯·å…ˆé…ç½®Cloudflare R2');
                return;
            }
            
            showToast('æ­£åœ¨åŠ è½½R2å¤‡ä»½æ–‡ä»¶...');
            
            s3Client.listObjectsV2({
                Bucket: r2Config.bucket,
                Prefix: 'yudong-cloud/'
            }, function(err, data) {
                if (err) {
                    console.error('åŠ è½½å¤‡ä»½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', err);
                    showToast('åŠ è½½å¤‡ä»½æ–‡ä»¶åˆ—è¡¨å¤±è´¥');
                    return;
                }
                
                const backupFiles = data.Contents.filter(item => 
                    item.Key.endsWith('.zip') && item.Key.startsWith('yudong-cloud/')
                ).sort((a, b) => new Date(b.LastModified) - new Date(a.LastModified));
                
                renderR2BackupList(backupFiles);
                showToast(`æ‰¾åˆ° ${backupFiles.length} ä¸ªå¤‡ä»½æ–‡ä»¶`);
            });
        }
        
        function renderR2BackupList(backupFiles) {
            const backupList = document.getElementById('r2BackupList');
            
            if (backupFiles.length === 0) {
                backupList.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--ios-label-tertiary);">æš‚æ— å¤‡ä»½æ–‡ä»¶</div>';
                document.getElementById('r2BackupSection').style.display = 'block';
                return;
            }
            
            let html = '';
            backupFiles.forEach(file => {
                const fileName = file.Key.replace('yudong-cloud/', '');
                const fileSize = formatBytes(file.Size);
                const lastModified = new Date(file.LastModified).toLocaleString('zh-CN');
                
                html += `
                    <div class="ios-list-item">
                        <div class="ios-list-content">
                            <div class="ios-list-title">${fileName}</div>
                            <div class="ios-list-subtitle">${fileSize} â€¢ ${lastModified}</div>
                        </div>
                        <button class="ios-button ios-button-small" onclick="importFromR2Backup('${file.Key}')">æ¢å¤</button>
                    </div>
                `;
            });
            
            backupList.innerHTML = html;
            document.getElementById('r2BackupSection').style.display = 'block';
        }

        function importFromR2Backup(fileKey) {
            if (!confirm('ç¡®å®šè¦ä»è¯¥å¤‡ä»½æ–‡ä»¶å¯¼å…¥æ•°æ®å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ã€‚')) {
                return;
            }
            
            showToast('æ­£åœ¨ä»R2å¤‡ä»½å¯¼å…¥æ•°æ®...');
            
            s3Client.getObject({
                Bucket: r2Config.bucket,
                Key: fileKey
            }, function(err, data) {
                if (err) {
                    console.error('ä¸‹è½½å¤‡ä»½æ–‡ä»¶å¤±è´¥:', err);
                    showToast('ä¸‹è½½å¤‡ä»½æ–‡ä»¶å¤±è´¥');
                    return;
                }
                
                const blob = new Blob([data.Body], { type: 'application/zip' });
                importDatabase([new File([blob], fileKey.split('/').pop())]);
            });
        }

        // å¤‡ä»½åŠŸèƒ½
        async function exportAndUploadBackup() {
            if (Object.keys(catalogData).length === 0) {
                showToast('æ— æ•°æ®å¯å¯¼å‡º');
                return;
            }
           
            showToast('æ­£åœ¨ç”Ÿæˆå¤‡ä»½æ–‡ä»¶...');
           
            const zip = new JSZip();
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
           
            const fullData = {
                catalogData: catalogData,
                uploadedFiles: uploadedFiles,
                searchHistory: searchHistory,
                exportTime: new Date().toISOString(),
                version: '4.0-r2-offline-optimized'
            };
           
            zip.file('database.json', JSON.stringify(fullData, null, 2));
           
            try {
                const rows = [['äº§å“ä»£ç ', 'ç ä»·', 'ç±³ä»·', 'é—¨å¹…', 'æˆåˆ†', 'å…‹é‡', 'å¤‡æ³¨', 'ä¾›åº”å•†', 'å›¾ç‰‡å®½åº¦', 'å›¾ç‰‡é«˜åº¦']];
                Object.values(catalogData).forEach(function(p) {
                    rows.push([
                        p.code || '-',
                        p.price || '-',
                        p.priceAlt || '-',
                        p.width || '-',
                        p.composition || '-',
                        p.weight || '-',
                        p.notes || '-',
                        p.supplier || '-',
                        p.imageWidth || '-',
                        p.imageHeight || '-'
                    ]);
                });
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(rows);
                XLSX.utils.book_append_sheet(wb, ws, 'äº§å“æ•°æ®');
                const xlsxBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                zip.file('äº§å“æ•°æ®è¡¨.xlsx', xlsxBuffer);
            } catch (xlsxError) {
                console.error('XLSX generation error:', xlsxError);
            }
           
            zip.generateAsync({
                type: 'blob',
                compression: 'DEFLATE',
                compressionOptions: { level: 6 }
            }).then(async function(content) {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = 'å®‡ä¸œçººç»‡å…¨åº“å¤‡ä»½_' + timestamp + '.zip';
                link.click();
                URL.revokeObjectURL(link.href);
                
                if (s3Client) {
                    try {
                        await uploadBackupToR2(content, link.download);
                        showToast('âœ… å®Œæ•´å¤‡ä»½å¯¼å‡ºæˆåŠŸï¼å·²åŒæ­¥åˆ°Cloudflare R2ã€‚');
                    } catch (error) {
                        console.error('å¤‡ä»½ä¸Šä¼ å¤±è´¥:', error);
                        showToast('âœ… å¤‡ä»½å¯¼å‡ºæˆåŠŸï¼Œä½†ä¸Šä¼ åˆ°R2å¤±è´¥');
                    }
                } else {
                    showToast('âœ… å¤‡ä»½å¯¼å‡ºæˆåŠŸï¼');
                }
            }).catch(function(error) {
                console.error('ZIP generation error:', error);
                showToast('å¯¼å‡ºå¤±è´¥');
            });
        }

        async function uploadBackupToR2(backupBlob, fileName) {
            return new Promise((resolve, reject) => {
                if (!s3Client) {
                    reject(new Error('è¯·å…ˆé…ç½®Cloudflare R2'));
                    return;
                }
                
                const key = `yudong-cloud/${fileName}`;
                
                s3Client.upload({
                    Bucket: r2Config.bucket,
                    Key: key,
                    Body: backupBlob,
                    ContentType: 'application/zip'
                }, function(err, data) {
                    if (err) {
                        console.error('å¤‡ä»½ä¸Šä¼ å¤±è´¥:', err);
                        reject(err);
                    } else {
                        resolve(data);
                    }
                });
            });
        }

        async function clearData() {
            if (confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                try {
                    // ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®åº“æ“ä½œå‡½æ•° - ç¡®ä¿æ•°æ®ä¿å­˜åˆ°R2
                    await withDatabaseOperation(async () => {
                        catalogData = {};
                        searchHistory = [];
                        uploadedFiles = {};
                    });
                    showToast('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º');
                } catch (error) {
                    showToast('æ¸…ç©ºæ•°æ®å¤±è´¥: ' + error.message);
                }
            }
        }

        async function clearSearchHistory() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æœç´¢å†å²å—ï¼Ÿ')) {
                try {
                    // ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®åº“æ“ä½œå‡½æ•° - ç¡®ä¿æ•°æ®ä¿å­˜åˆ°R2
                    await withDatabaseOperation(async () => {
                        searchHistory = [];
                    });
                    showToast('æœç´¢å†å²å·²æ¸…é™¤');
                } catch (error) {
                    showToast('æ¸…é™¤æœç´¢å†å²å¤±è´¥: ' + error.message);
                }
            }
        }

        // è¾…åŠ©å‡½æ•°
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        async function updateStats() {
            document.getElementById('dataCount').textContent = Object.keys(catalogData).length;
            
            let r2Images = 0;
            let missingImages = 0;
            
            Object.values(catalogData).forEach(product => {
                if (product.image) {
                    if (product.image.includes(r2Config.customDomain) || product.image.includes('.r2.cloudflarestorage.com')) {
                        r2Images++;
                    }
                } else {
                    missingImages++;
                }
            });
            
            document.getElementById('r2ImageCount').textContent = r2Images;
            document.getElementById('missingImageCount').textContent = missingImages;
            
            // æ›´æ–°ç¼“å­˜ç»Ÿè®¡
            const cacheStats = await getCacheStats();
            document.getElementById('cachedImageCount').textContent = cacheStats.count;
            document.getElementById('cacheSize').innerHTML = (cacheStats.size / (1024 * 1024)).toFixed(2) + ' <span class="cache-size-unit">MB</span>';
            
            updateSidebarStats();
        }

        // å“åº”å¼è¾…åŠ©å‡½æ•°
        function isMobileDevice() {
            return window.innerWidth <= 768;
        }

        async function updateSidebarStats() {
            if (!isMobileDevice()) {
                document.getElementById('sidebarDataCount').textContent = document.getElementById('dataCount').textContent;
                document.getElementById('sidebarR2ImageCount').textContent = document.getElementById('r2ImageCount').textContent;
                
                const cacheStats = await getCacheStats();
                document.getElementById('sidebarCachedImageCount').textContent = cacheStats.count;
                document.getElementById('sidebarNetworkStatus').textContent = isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿';
                document.getElementById('sidebarNetworkStatus').style.color = isOnline ? 'var(--ios-system-green)' : 'var(--ios-system-orange)';
            }
        }

        // æ¸²æŸ“æœç´¢å†å²
        function renderHistory() {
            const historyDiv = document.getElementById('searchHistory');
            let html = '';
            searchHistory.slice(-5).reverse().forEach(h => {
                html += `<button class="ios-button ios-button-secondary ios-button-compact" onclick="loadHistory('${h.replace(/'/g, "\\'")}')">${h}</button>`;
            });
            historyDiv.innerHTML = html;
            
            updateSidebarHistory();
        }

        function updateSidebarHistory() {
            if (!isMobileDevice()) {
                const historyDiv = document.getElementById('sidebarSearchHistory');
                let html = '';
                searchHistory.slice(-5).reverse().forEach(h => {
                    html += `<button class="ios-button ios-button-secondary ios-button-compact ios-button-full mb-sm" onclick="loadHistory('${h.replace(/'/g, "\\'")}')">${h}</button>`;
                });
                historyDiv.innerHTML = html;
            }
        }

        function loadHistory(query) {
            document.getElementById('searchInput').value = query;
            handleSearch(query);
            
            document.querySelectorAll('.ios-tab-item').forEach(t => t.classList.remove('active'));
            document.querySelector('.ios-tab-item[data-tab="query"]').classList.add('active');
            document.querySelectorAll('.ios-tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tabQuery').classList.add('active');
            updateNavBar('query');
        }

        // æ–‡ä»¶å¯¼å…¥åŠŸèƒ½
        function importDatabase(files) {
            if (files.length === 0) return;
            const file = files[0];
            
            showToast('æ­£åœ¨å¯¼å…¥æ•°æ®åº“...');
            
            if (file.name.endsWith('.json')) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®åº“æ“ä½œå‡½æ•° - ç¡®ä¿æ•°æ®ä¿å­˜åˆ°R2
                        await withDatabaseOperation(async () => {
                            if (data.catalogData) {
                                catalogData = data.catalogData;
                                uploadedFiles = data.uploadedFiles || {};
                                searchHistory = data.searchHistory || [];
                            } else {
                                catalogData = data;
                            }
                        });
                        
                        showToast('æ•°æ®åº“å¯¼å…¥æˆåŠŸï¼');
                    } catch (err) {
                        showToast('å¯¼å…¥å¤±è´¥ï¼šJSONæ ¼å¼é”™è¯¯');
                    }
                };
                reader.onerror = function() {
                    showToast('æ–‡ä»¶è¯»å–å¤±è´¥');
                };
                reader.readAsText(file);
            } else if (file.name.endsWith('.zip')) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    JSZip.loadAsync(e.target.result).then(async function(zip) {
                        const jsonFile = zip.file('database.json') || zip.file('æ•°æ®åº“å¤‡ä»½.json');
                       
                        if (jsonFile) {
                            jsonFile.async('string').then(async function(jsonStr) {
                                try {
                                    const data = JSON.parse(jsonStr);
                                    
                                    // ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®åº“æ“ä½œå‡½æ•° - ç¡®ä¿æ•°æ®ä¿å­˜åˆ°R2
                                    await withDatabaseOperation(async () => {
                                        if (data.catalogData) {
                                            catalogData = data.catalogData;
                                            uploadedFiles = data.uploadedFiles || {};
                                            searchHistory = data.searchHistory || [];
                                        } else {
                                            catalogData = data;
                                        }
                                    });
                                    
                                    showToast('æ•°æ®åº“å¯¼å…¥æˆåŠŸï¼');
                                } catch (err) {
                                    showToast('å¯¼å…¥å¤±è´¥ï¼šæ•°æ®æ ¼å¼é”™è¯¯');
                                }
                            }).catch(function(err) {
                                showToast('å¯¼å…¥å¤±è´¥ï¼šæ— æ³•è¯»å–JSONæ–‡ä»¶');
                            });
                        } else {
                            showToast('å¯¼å…¥å¤±è´¥ï¼šZIPä¸­æœªæ‰¾åˆ°æ•°æ®æ–‡ä»¶');
                        }
                    }).catch(function(err) {
                        showToast('å¯¼å…¥å¤±è´¥ï¼šæ— æ•ˆçš„ZIPæ–‡ä»¶');
                    });
                };
                reader.onerror = function() {
                    showToast('æ–‡ä»¶è¯»å–å¤±è´¥');
                };
                reader.readAsArrayBuffer(file);
            } else {
                showToast('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼');
            }
        }

        // PDFå¯¼å‡ºåŠŸèƒ½
        function exportQuotePDF() {
            let allResults = [];
            
            if (rangeResults.length > 0) {
                rangeResults.forEach(range => {
                    range.matches.forEach(product => {
                        allResults.push(product);
                    });
                });
            } else {
                searchResults.filter(r => r.found).forEach(r => {
                    allResults.push(r);
                });
            }
            
            if (allResults.length === 0) {
                showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„æœç´¢ç»“æœ');
                return;
            }
            
            showToast('æ­£åœ¨ç”ŸæˆPDF...');
            
            const printContainer = document.createElement('div');
            printContainer.style.cssText = 'position: absolute; left: -9999px; width: 210mm; font-family: "Microsoft YaHei", sans-serif; background: white; padding: 15mm; line-height: 1.1;';
            document.body.appendChild(printContainer);
            
            let html = '<h1 style="text-align: center; color: #333; font-size: 20pt; margin-bottom: 10mm; border-bottom: 2px solid #333; padding-bottom: 5mm;">å®‡ä¸œçººç»‡æŠ¥ä»·å•</h1>';
            html += '<div style="text-align: center; color: #666; margin-bottom: 8mm; font-size: 10pt;">ç”Ÿæˆæ—¶é—´ï¼š' + new Date().toLocaleString('zh-CN') + ' | äº§å“æ•°é‡ï¼š' + allResults.length + ' é¡¹</div>';
            html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 5mm; font-size: 9pt;">';
            html += '<thead><tr>';
            html += '<th style="width: 8%; background-color: #333; color: white; padding: 8pt 4pt; text-align: center; font-weight: bold;">åºå·</th>';
            html += '<th style="width: 15%; background-color: #333; color: white; padding: 8pt 4pt; text-align: center; font-weight: bold;">äº§å“ä»£ç </th>';
            html += '<th style="width: 10%; background-color: #333; color: white; padding: 8pt 4pt; text-align: center; font-weight: bold;">ç ä»·</th>';
            html += '<th style="width: 10%; background-color: #333; color: white; padding: 8pt 4pt; text-align: center; font-weight: bold;">ç±³ä»·</th>';
            html += '<th style="width: 10%; background-color: #333; color: white; padding: 8pt 4pt; text-align: center; font-weight: bold;">é—¨å¹…</th>';
            html += '<th style="width: 15%; background-color: #333; color: white; padding: 8pt 4pt; text-align: center; font-weight: bold;">æˆåˆ†</th>';
            html += '<th style="width: 10%; background-color: #333; color: white; padding: 8pt 4pt; text-align: center; font-weight: bold;">å…‹é‡</th>';
            html += '<th style="width: 22%; background-color: #333; color: white; padding: 8pt 4pt; text-align: center; font-weight: bold;">å¤‡æ³¨</th>';
            html += '</tr></thead><tbody>';
            
            allResults.forEach((product, index) => {
                html += '<tr>';
                html += '<td style="padding: 6pt 3pt; text-align: center; border: 1px solid #ddd; vertical-align: middle;">' + (index + 1) + '</td>';
                html += '<td style="padding: 6pt 3pt; text-align: center; border: 1px solid #ddd; vertical-align: middle;"><strong>' + product.code + '</strong></td>';
                html += '<td style="padding: 6pt 3pt; text-align: center; border: 1px solid #ddd; vertical-align: middle;">' + product.price + '</td>';
                html += '<td style="padding: 6pt 3pt; text-align: center; border: 1px solid #ddd; vertical-align: middle;">' + product.priceAlt + '</td>';
                html += '<td style="padding: 6pt 3pt; text-align: center; border: 1px solid #ddd; vertical-align: middle;">' + product.width + '</td>';
                html += '<td style="padding: 6pt 3pt; text-align: center; border: 1px solid #ddd; vertical-align: middle; word-wrap: break-word;">' + product.composition + '</td>';
                html += '<td style="padding: 6pt 3pt; text-align: center; border: 1px solid #ddd; vertical-align: middle;">' + product.weight + '</td>';
                html += '<td style="padding: 6pt 3pt; text-align: left; border: 1px solid #ddd; vertical-align: top; color: #d32f2f; word-wrap: break-word;">' + (product.notes && product.notes !== '-' ? product.notes : '') + '</td>';
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            html += '<div style="text-align: center; color: #999; font-size: 8pt; margin-top: 10mm; border-top: 1px solid #ddd; padding-top: 5mm;">æœ¬æŠ¥ä»·å•ç”±å®‡ä¸œçººç»‡æŠ¥ä»·ç³»ç»Ÿç”Ÿæˆ</div>';
            printContainer.innerHTML = html;
            
            html2canvas(printContainer, {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff'
            }).then(function(canvas) {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = pdfWidth - 20;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, 10, imgWidth, imgHeight);
                pdf.save('æŠ¥ä»·å•_' + new Date().toISOString().slice(0, 10) + '.pdf');
                
                document.body.removeChild(printContainer);
                showToast('PDFå¯¼å‡ºæˆåŠŸ');
            }).catch(function(error) {
                console.error('PDF generation error:', error);
                document.body.removeChild(printContainer);
                showToast('PDFç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }

        // ============== åˆå§‹åŒ–äº‹ä»¶ç›‘å¬ ==============
        document.getElementById('localDbInput').addEventListener('change', function(e) {
            importDatabase(e.target.files);
            e.target.value = '';
        });

        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchReset = document.getElementById('searchReset');
            
            if (e.target.value.trim()) {
                searchReset.classList.add('show');
            } else {
                searchReset.classList.remove('show');
            }
            
            clearTimeout(searchTimeout);
            const value = e.target.value.trim();
            if (value && Object.keys(catalogData).length > 0) {
                searchTimeout = setTimeout(() => {
                    handleSearch(value);
                }, 300);
            } else {
                searchResults = [];
                fuzzyMatches = [];
                rangeResults = [];
                renderResults();
            }
        });

        document.getElementById('manageSearchInput').addEventListener('input', function(e) {
            const manageSearchReset = document.getElementById('manageSearchReset');
            
            if (e.target.value.trim()) {
                manageSearchReset.classList.add('show');
            } else {
                manageSearchReset.classList.remove('show');
            }
            
            filterManageProducts();
        });

        // æ‰¹é‡å›¾ç‰‡ä¸Šä¼ 
        document.getElementById('bulkImageInput').addEventListener('change', async function(e) {
            // æ£€æŸ¥æ˜¯å¦å¤„äºåªè¯»æ¨¡å¼
            if (isReadOnlyMode) {
                showToast('ç¦»çº¿æ¨¡å¼ä¸‹æ— æ³•ä¸Šä¼ å›¾ç‰‡', 2000);
                e.target.value = '';
                return;
            }
            
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            if (!s3Client) {
                showToast('è¯·å…ˆé…ç½®Cloudflare R2');
                return;
            }
            
            showToast(`å¤„ç† ${files.length} å¼ å›¾ç‰‡...`);
            
            let processed = 0;
            let success = 0;
            let failedFiles = [];
            
            for (const file of files) {
                const name = file.name.toUpperCase();
                const code = name.replace(/\.(JPG|PNG|JPEG|GIF|BMP|WEBP|SVG)$/i, '').trim();
                
                if (!code) {
                    failedFiles.push({ name: file.name, error: 'æ–‡ä»¶åæ— æ³•æå–äº§å“ä»£ç ' });
                    processed++;
                    continue;
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    failedFiles.push({ name: file.name, error: 'æ–‡ä»¶å¤§äº5MB' });
                    processed++;
                    continue;
                }
                
                if (!catalogData[code]) {
                    failedFiles.push({ name: file.name, error: 'äº§å“ä»£ç ä¸å­˜åœ¨' });
                    processed++;
                    continue;
                }
                
                try {
                    const dimensions = await getImageDimensions(file);
                    const imageUrl = await uploadToR2(file, code);
                    
                    // æ¸…é™¤è¯¥äº§å“çš„å›¾ç‰‡ç¼“å­˜
                    await clearProductImageCache(code);
                    
                    // ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®åº“æ“ä½œå‡½æ•° - ç¡®ä¿æ•°æ®ä¿å­˜åˆ°R2
                    await withDatabaseOperation(async () => {
                        catalogData[code].image = imageUrl;
                        catalogData[code].imageWidth = dimensions.width;
                        catalogData[code].imageHeight = dimensions.height;
                    });
                    
                    success++;
                } catch (error) {
                    failedFiles.push({ name: file.name, error: error.message || 'ä¸Šä¼ å¤±è´¥' });
                }
                
                processed++;
            }
            
            let statusMsg = `æ‰¹é‡ä¸Šä¼ å®Œæˆï¼š${success} æˆåŠŸï¼Œ${failedFiles.length} å¤±è´¥`;
            if (failedFiles.length > 0) {
                const failedList = failedFiles.slice(0, 3).map(f => `${f.name}`).join('; ');
                statusMsg += `ã€‚å¤±è´¥æ–‡ä»¶ï¼š${failedList}${failedFiles.length > 3 ? '...' : ''}`;
            }
            
            showToast(statusMsg);
            e.target.value = '';
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.getElementById('addProductModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideAddProductModal();
            }
        });

        // ============== åˆå§‹åŒ–åº”ç”¨ - çº¯ç²¹çš„R2äº‘ç«¯å­˜å‚¨ + è‡ªåŠ¨åå°ç¼“å­˜ ==============
        async function initApp() {
            // åˆå§‹åŒ–IndexedDB
            await initImageDB();
            
            // åˆå§‹åŒ–å›¾ç‰‡åŠ è½½
            initImageLoading();
            
            // æ¸…é™¤è¿‡æœŸçš„æœ¬åœ°ç¼“å­˜
            clearExpiredCache();
            
            // åŠ è½½R2é…ç½®
            loadR2Config();
            
            // åˆå§‹ç½‘ç»œçŠ¶æ€æ£€æµ‹
            checkNetworkStatus();
            
            try {
                // é¦–å…ˆå°è¯•ä»R2åŠ è½½æ•°æ®åº“
                if (s3Client && isOnline) {
                    const success = await loadDatabaseFromR2();
                    if (!success) {
                        throw new Error('ä»R2åŠ è½½æ•°æ®å¤±è´¥');
                    }
                    showToast('äº‘ç«¯æ•°æ®åŠ è½½æˆåŠŸ');
                } else {
                    // å¦‚æœæ²¡æœ‰ç½‘ç»œæˆ–R2æœªé…ç½®ï¼Œå°è¯•ä»æœ¬åœ°ç¼“å­˜åŠ è½½
                    const cacheLoaded = loadFromLocalCache();
                    if (cacheLoaded) {
                        if (!isOnline) {
                            enableOfflineMode();
                            showToast('ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼ˆç¦»çº¿æ¨¡å¼ï¼‰', 3000);
                        } else {
                            showToast('ä½¿ç”¨ç¼“å­˜æ•°æ®', 2000);
                        }
                    } else {
                        // å¦‚æœæ²¡æœ‰ç¼“å­˜æ•°æ®ï¼Œåˆå§‹åŒ–ç©ºæ•°æ®åº“
                        catalogData = {};
                        searchHistory = [];
                        uploadedFiles = {};
                        if (!isOnline) {
                            enableOfflineMode();
                            showToast('æ— ç½‘ç»œè¿æ¥ä¸”æ— ç¼“å­˜æ•°æ®', 3000);
                        } else {
                            showToast('å·²åˆå§‹åŒ–ç©ºæ•°æ®åº“');
                        }
                    }
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                // å°è¯•ä»æœ¬åœ°ç¼“å­˜åŠ è½½ä½œä¸ºé™çº§æ–¹æ¡ˆ
                const cacheLoaded = loadFromLocalCache();
                if (cacheLoaded) {
                    if (!isOnline) {
                        enableOfflineMode();
                        showToast('ç½‘ç»œå¼‚å¸¸ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ®ï¼ˆç¦»çº¿æ¨¡å¼ï¼‰', 3000);
                    } else {
                        showToast('ç½‘ç»œå¼‚å¸¸ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ®', 2000);
                    }
                } else {
                    catalogData = {};
                    searchHistory = [];
                    uploadedFiles = {};
                    if (!isOnline) {
                        enableOfflineMode();
                        showToast('åˆå§‹åŒ–å¤±è´¥ä¸”æ— ç¼“å­˜æ•°æ®', 3000);
                    } else {
                        showToast('åˆå§‹åŒ–å¤±è´¥ï¼Œå·²åˆ›å»ºç©ºæ•°æ®åº“');
                    }
                }
            }
            
            // åˆå§‹åŒ–ç•Œé¢
            updateStats();
            renderHistory();
            renderManageProducts();
            
            // åˆå§‹åŒ–PhotoSwipeå›¾ç‰‡æŸ¥çœ‹å™¨
            initPhotoSwipe();
            
            // åˆå§‹åŒ–åå°è‡ªåŠ¨ç¼“å­˜ç³»ç»Ÿ
            backgroundCacheManager.init();
            
            // æ·»åŠ ç½‘ç»œçŠ¶æ€ç›‘å¬
            window.addEventListener('online', () => {
                checkNetworkStatus();
            });
            
            window.addEventListener('offline', () => {
                checkNetworkStatus();
            });
            
            console.log('iOSé£æ ¼æŠ¥ä»·ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ - çº¯R2äº‘ç«¯å­˜å‚¨ + ä¼˜åŒ–çš„è‡ªåŠ¨åå°ç¼“å­˜');
        }

        // å¯åŠ¨åº”ç”¨
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>